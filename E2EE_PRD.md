# ç«¯å¯¹ç«¯åŠ å¯†(E2EE)åŠŸèƒ½ - äº§å“éœ€æ±‚æ–‡æ¡£ (PRD)

## 1. æ¦‚è¿°

### 1.1 äº§å“ç›®æ ‡
ä¸º Cloudflare Workers Chat åº”ç”¨å®ç°ç«¯å¯¹ç«¯åŠ å¯†(End-to-End Encryption)åŠŸèƒ½ï¼Œç¡®ä¿æ¶ˆæ¯ã€æ–‡ä»¶å’Œå›¾ç‰‡åœ¨ä¼ è¾“å’Œå­˜å‚¨è¿‡ç¨‹ä¸­çš„éšç§å®‰å…¨ï¼Œä½¿å¾—é™¤äº†é€šä¿¡åŒæ–¹å¤–ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨åœ¨å†…çš„ä»»ä½•ç¬¬ä¸‰æ–¹éƒ½æ— æ³•è¯»å–åŠ å¯†å†…å®¹ã€‚

### 1.2 èƒŒæ™¯
å½“å‰çš„èŠå¤©åº”ç”¨åœ¨æœåŠ¡å™¨ç«¯ä»¥æ˜æ–‡æ–¹å¼å­˜å‚¨æ¶ˆæ¯å’Œæ–‡ä»¶ï¼Œè™½ç„¶ä½¿ç”¨äº† HTTPS ä¼ è¾“åŠ å¯†ï¼Œä½†æœåŠ¡å™¨ç®¡ç†å‘˜ç†è®ºä¸Šå¯ä»¥è®¿é—®æ‰€æœ‰æ¶ˆæ¯å†…å®¹ã€‚ç«¯å¯¹ç«¯åŠ å¯†å°†æä¾›æ›´é«˜çº§åˆ«çš„éšç§ä¿æŠ¤ã€‚

### 1.3 æ ¸å¿ƒåŸåˆ™ï¼šå®¢æˆ·ç«¯åŠ å¯†ï¼ŒæœåŠ¡ç«¯å­˜å‚¨å¯†æ–‡

**âš ï¸ é‡è¦è¯´æ˜ï¼šè¿™æ˜¯ä¸€ä¸ªé›¶ä¿¡ä»»çš„å®¢æˆ·ç«¯åŠ å¯†æ–¹æ¡ˆ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  æ˜æ–‡æ¶ˆæ¯ "Hello World"                                       â”‚
â”‚       â†“                                                       â”‚
â”‚  ğŸ”‘ ä½¿ç”¨æˆ¿é—´å¯†é’¥åŠ å¯†ï¼ˆAES-256-GCMï¼‰                          â”‚
â”‚       â†“                                                       â”‚
â”‚  å¯†æ–‡ "ENCRYPTED:{iv:[...], ciphertext:[...]}"               â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ é€šè¿‡ HTTPS ä¼ è¾“åŠ å¯†æ•°æ®
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Cloudflare Workers æœåŠ¡ç«¯                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  æ¥æ”¶åˆ°çš„æ•°æ®ï¼ˆæœåŠ¡ç«¯çœ‹åˆ°çš„ï¼‰ï¼š                              â”‚
â”‚  {                                                            â”‚
â”‚    "name": "Alice",                                          â”‚
â”‚    "message": "ENCRYPTED:{iv:[12,34,...], ciphertext:[...]}" â”‚
â”‚  }                                                            â”‚
â”‚                                                               â”‚
â”‚  âŒ æœåŠ¡ç«¯æ— æ³•è§£å¯†ï¼ˆæ²¡æœ‰å¯†é’¥ï¼‰                                â”‚
â”‚  âœ… ä»…å­˜å‚¨å¯†æ–‡åˆ° Durable Objects                             â”‚
â”‚  âœ… ä»…è½¬å‘å¯†æ–‡ç»™å…¶ä»–å®¢æˆ·ç«¯                                    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ å¯†æ–‡å­˜å‚¨ï¼ˆæ°¸ä¹…ï¼‰
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Durable Objects / R2 Storage                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  å­˜å‚¨çš„æ•°æ®ï¼ˆå¯†æ–‡ï¼‰ï¼š                                         â”‚
â”‚  - æ¶ˆæ¯å¯†æ–‡ï¼šENCRYPTED:{...}                                 â”‚
â”‚  - æ–‡ä»¶å¯†æ–‡ï¼šencrypted_image.jpg.enc                         â”‚
â”‚  - å…ƒæ•°æ®ï¼šç”¨æˆ·åã€æ—¶é—´æˆ³ï¼ˆæ˜æ–‡ï¼‰                            â”‚
â”‚                                                               â”‚
â”‚  âŒ æœåŠ¡å™¨ç®¡ç†å‘˜æ— æ³•è¯»å–å†…å®¹                                  â”‚
â”‚  âœ… æ•°æ®åº“å¤‡ä»½ä¹Ÿæ˜¯å¯†æ–‡                                        â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ è¿”å›å¯†æ–‡ç»™å…¶ä»–å®¢æˆ·ç«¯
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å…¶ä»–å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  æ¥æ”¶å¯†æ–‡ "ENCRYPTED:{iv:[...], ciphertext:[...]}"           â”‚
â”‚       â†“                                                       â”‚
â”‚  ğŸ”“ ä½¿ç”¨æˆ¿é—´å¯†é’¥è§£å¯†ï¼ˆAES-256-GCMï¼‰                          â”‚
â”‚       â†“                                                       â”‚
â”‚  æ˜æ–‡æ¶ˆæ¯ "Hello World"                                       â”‚
â”‚       â†“                                                       â”‚
â”‚  æ˜¾ç¤ºç»™ç”¨æˆ·                                                   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**ï¼š
- âœ… **åŠ å¯†åœ¨å®¢æˆ·ç«¯å®Œæˆ**ï¼šæ‰€æœ‰åŠ å¯†/è§£å¯†æ“ä½œéƒ½åœ¨ç”¨æˆ·çš„æµè§ˆå™¨ä¸­è¿›è¡Œ
- âœ… **å¯†é’¥ä¸ç¦»å¼€å®¢æˆ·ç«¯**ï¼šæˆ¿é—´å¯†ç å’Œæ´¾ç”Ÿçš„åŠ å¯†å¯†é’¥ä»…å­˜å‚¨åœ¨ç”¨æˆ·æµè§ˆå™¨çš„ IndexedDB ä¸­
- âœ… **æœåŠ¡ç«¯åªå­˜å‚¨å¯†æ–‡**ï¼šæœåŠ¡å™¨ï¼ˆDurable Objects/R2ï¼‰åªèƒ½çœ‹åˆ°å’Œå­˜å‚¨åŠ å¯†åçš„æ•°æ®
- âœ… **æœåŠ¡ç«¯æ— æ³•è§£å¯†**ï¼šæœåŠ¡å™¨æ²¡æœ‰å¯†é’¥ï¼Œå³ä½¿ç®¡ç†å‘˜ä¹Ÿæ— æ³•è¯»å–æ¶ˆæ¯å†…å®¹
- âœ… **å­˜å‚¨ç»“æ„ä¸å˜**ï¼šDurable Objects å’Œ R2 çš„å­˜å‚¨ç»“æ„ä¿æŒä¸å˜ï¼Œåªæ˜¯å­˜å‚¨çš„å†…å®¹ä»æ˜æ–‡å˜ä¸ºå¯†æ–‡
- âœ… **ä¼ è¾“å±‚ä¾ç„¶ä½¿ç”¨ HTTPS**ï¼šåœ¨åŠ å¯†å†…å®¹ä¹‹ä¸Šå†åŠ ä¸€å±‚ä¼ è¾“åŠ å¯†

**å¯¹æœåŠ¡ç«¯çš„å½±å“**ï¼š
- âœ… **é›¶æ”¹åŠ¨å­˜å‚¨é€»è¾‘**ï¼šæœåŠ¡ç«¯ API ä¸éœ€è¦ä¿®æ”¹ï¼Œç»§ç»­å­˜å‚¨ `message` å­—æ®µ
- âœ… **é›¶æ”¹åŠ¨æ•°æ®ç»“æ„**ï¼šDurable Objects æ•°æ®ç»“æ„å®Œå…¨ä¸€è‡´
- âœ… **é›¶æ”¹åŠ¨æ–‡ä»¶å­˜å‚¨**ï¼šR2 ç»§ç»­å­˜å‚¨æ–‡ä»¶ï¼Œåªæ˜¯æ–‡ä»¶å†…å®¹æ˜¯åŠ å¯†çš„
- âœ… **å‘åå…¼å®¹**ï¼šæœªåŠ å¯†çš„æˆ¿é—´ä¾ç„¶æ­£å¸¸å·¥ä½œ

### 1.4 ä¸ç°æœ‰ç³»ç»Ÿçš„å…³ç³»

| ç»„ä»¶ | å½“å‰çŠ¶æ€ | E2EE åçŠ¶æ€ | æ˜¯å¦éœ€è¦ä¿®æ”¹ |
|------|---------|------------|-------------|
| **å®¢æˆ·ç«¯ UI** | å‘é€/æ¥æ”¶æ˜æ–‡æ¶ˆæ¯ | å‘é€å‰åŠ å¯†ï¼Œæ¥æ”¶åè§£å¯† | âœ… éœ€è¦ä¿®æ”¹ |
| **WebSocket é€šä¿¡** | ä¼ è¾“æ˜æ–‡æ¶ˆæ¯ | ä¼ è¾“å¯†æ–‡æ¶ˆæ¯ | âŒ ä¸éœ€è¦ä¿®æ”¹ |
| **Durable Objects** | å­˜å‚¨æ˜æ–‡æ¶ˆæ¯ | å­˜å‚¨å¯†æ–‡æ¶ˆæ¯ | âŒ ä¸éœ€è¦ä¿®æ”¹ |
| **R2 å­˜å‚¨** | å­˜å‚¨æ˜æ–‡æ–‡ä»¶ | å­˜å‚¨åŠ å¯†æ–‡ä»¶ | âŒ ä¸éœ€è¦ä¿®æ”¹ |
| **Workers API** | è½¬å‘æ˜æ–‡æ¶ˆæ¯ | è½¬å‘å¯†æ–‡æ¶ˆæ¯ | âŒ ä¸éœ€è¦ä¿®æ”¹ |
| **æ•°æ®åº“ç»“æ„** | `{message: "Hello"}` | `{message: "ENCRYPTED:{...}"}` | âŒ ä¸éœ€è¦ä¿®æ”¹ |

**æ€»ç»“ï¼šæ‰€æœ‰åŠ è§£å¯†é€»è¾‘åœ¨å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯åªæ˜¯"æ— çŸ¥çš„æ¬è¿å·¥"**

### 1.3 é€‚ç”¨èŒƒå›´
- æ–‡æœ¬æ¶ˆæ¯åŠ å¯†
- æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½åŠ å¯†
- å›¾ç‰‡åŠ å¯†ä¼ è¾“å’Œæ˜¾ç¤º
- èŠå¤©å†å²åŠ å¯†å­˜å‚¨
- çº¿ç¨‹å›å¤åŠ å¯†

---

## 2. æŠ€æœ¯æ¶æ„

### 2.1 å®¢æˆ·ç«¯-æœåŠ¡ç«¯èŒè´£åˆ’åˆ†

**è®¾è®¡åŸåˆ™ï¼šå®¢æˆ·ç«¯åŠ å¯†ï¼ŒæœåŠ¡ç«¯ç›²ä¼ **

```javascript
// ===== å®¢æˆ·ç«¯èŒè´£ =====
âœ… ç”¨æˆ·è¾“å…¥æˆ¿é—´å¯†ç 
âœ… ä½¿ç”¨ PBKDF2 ä»å¯†ç æ´¾ç”Ÿ AES-256 å¯†é’¥
âœ… ä½¿ç”¨å¯†é’¥åŠ å¯†æ¶ˆæ¯ï¼ˆAES-GCMï¼‰
âœ… å‘é€å¯†æ–‡åˆ°æœåŠ¡å™¨
âœ… ä»æœåŠ¡å™¨æ¥æ”¶å¯†æ–‡
âœ… ä½¿ç”¨å¯†é’¥è§£å¯†æ¶ˆæ¯
âœ… æ˜¾ç¤ºæ˜æ–‡ç»™ç”¨æˆ·
âœ… ç®¡ç†å¯†é’¥ï¼ˆå­˜å‚¨åœ¨ IndexedDBï¼‰

// ===== æœåŠ¡ç«¯èŒè´£ =====
âœ… æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„å¯†æ–‡æ¶ˆæ¯
âœ… å­˜å‚¨å¯†æ–‡åˆ° Durable Objects
âœ… è½¬å‘å¯†æ–‡ç»™å…¶ä»–å®¢æˆ·ç«¯
âœ… å­˜å‚¨åŠ å¯†æ–‡ä»¶åˆ° R2
âœ… è¿”å›åŠ å¯†æ–‡ä»¶ç»™å®¢æˆ·ç«¯
âŒ ä¸çŸ¥é“æˆ¿é—´å¯†ç 
âŒ ä¸çŸ¥é“åŠ å¯†å¯†é’¥
âŒ ä¸è¿›è¡Œä»»ä½•åŠ è§£å¯†æ“ä½œ
âŒ æ— æ³•è¯»å–æ¶ˆæ¯å†…å®¹
```

**æ•°æ®æµç¤ºä¾‹**ï¼š

```javascript
// å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
// æ­¥éª¤ 1ï¼šç”¨æˆ·è¾“å…¥ï¼ˆå®¢æˆ·ç«¯ï¼‰
const userInput = "Hello, this is a secret message!";

// æ­¥éª¤ 2ï¼šåŠ å¯†ï¼ˆå®¢æˆ·ç«¯ï¼‰
const roomKey = await keyManager.getRoomKey(roomId);  // ä» IndexedDB è¯»å–
const encrypted = await CryptoUtils.encryptMessage(userInput, roomKey);
// encrypted = {
//   iv: [12, 34, 56, ...],
//   ciphertext: [78, 90, 12, ...],
//   version: "1.0"
// }

// æ­¥éª¤ 3ï¼šå‘é€åˆ°æœåŠ¡å™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰
websocket.send(JSON.stringify({
  name: "Alice",
  message: `ENCRYPTED:${JSON.stringify(encrypted)}`,
  messageId: "uuid-123",
  encryptionType: "e2ee-aes256-gcm"
}));

// æ­¥éª¤ 4ï¼šæœåŠ¡å™¨æ¥æ”¶ï¼ˆæœåŠ¡ç«¯ - Cloudflare Workersï¼‰
// æœåŠ¡å™¨çœ‹åˆ°çš„æ•°æ®ï¼š
{
  "name": "Alice",  // æ˜æ–‡ï¼ˆå…¬å¼€ä¿¡æ¯ï¼‰
  "message": "ENCRYPTED:{iv:[12,34,...], ciphertext:[78,90,...]}", // å¯†æ–‡
  "messageId": "uuid-123",
  "encryptionType": "e2ee-aes256-gcm"
}
// âŒ æœåŠ¡å™¨æ— æ³•è§£å¯†è¿™æ®µæ¶ˆæ¯ï¼

// æ­¥éª¤ 5ï¼šå­˜å‚¨åˆ° Durable Objectsï¼ˆæœåŠ¡ç«¯ï¼‰
await this.storage.put(timestamp, {
  name: "Alice",
  message: "ENCRYPTED:{...}",  // å­˜å‚¨çš„æ˜¯å¯†æ–‡ï¼
  messageId: "uuid-123",
  encryptionType: "e2ee-aes256-gcm"
});
// æ•°æ®åº“ä¸­æ°¸ä¹…å­˜å‚¨çš„æ˜¯å¯†æ–‡

// æ­¥éª¤ 6ï¼šè½¬å‘ç»™å…¶ä»–å®¢æˆ·ç«¯ï¼ˆæœåŠ¡ç«¯ï¼‰
this.broadcast({
  name: "Alice",
  message: "ENCRYPTED:{...}",  // è½¬å‘çš„ä¹Ÿæ˜¯å¯†æ–‡
  messageId: "uuid-123"
});

// æ­¥éª¤ 7ï¼šå…¶ä»–å®¢æˆ·ç«¯æ¥æ”¶ï¼ˆå®¢æˆ·ç«¯ï¼‰
websocket.onmessage = async (event) => {
  const data = JSON.parse(event.data);
  
  if (data.message.startsWith("ENCRYPTED:")) {
    // æ­¥éª¤ 8ï¼šè§£å¯†ï¼ˆå®¢æˆ·ç«¯ï¼‰
    const encryptedData = JSON.parse(data.message.substring(10));
    const roomKey = await keyManager.getRoomKey(roomId);  // ä» IndexedDB è¯»å–
    const plaintext = await CryptoUtils.decryptMessage(encryptedData, roomKey);
    // plaintext = "Hello, this is a secret message!"
    
    // æ­¥éª¤ 9ï¼šæ˜¾ç¤ºæ˜æ–‡ï¼ˆå®¢æˆ·ç«¯ï¼‰
    displayMessage({
      name: data.name,
      message: plaintext  // æ˜¾ç¤ºè§£å¯†åçš„æ˜æ–‡
    });
  }
};
```

**å…³é”®å¯¹æ¯”ï¼šåŠ å¯†å‰ vs åŠ å¯†å**

| é˜¶æ®µ | æœªåŠ å¯†ï¼ˆå½“å‰ï¼‰ | åŠ å¯†åï¼ˆE2EEï¼‰ | è¯´æ˜ |
|------|---------------|----------------|------|
| **ç”¨æˆ·è¾“å…¥** | "Hello World" | "Hello World" | ç›¸åŒ |
| **å®¢æˆ·ç«¯å¤„ç†** | ç›´æ¥å‘é€ | åŠ å¯†åå‘é€ | âœ… å˜åŒ– |
| **WebSocket ä¼ è¾“** | `{"message": "Hello World"}` | `{"message": "ENCRYPTED:{...}"}` | âœ… å˜åŒ–ï¼ˆå†…å®¹ï¼‰ |
| **æœåŠ¡ç«¯æ¥æ”¶** | çœ‹åˆ°æ˜æ–‡ | çœ‹åˆ°å¯†æ–‡ | âœ… å˜åŒ–ï¼ˆå¯è§æ€§ï¼‰ |
| **Durable Objects å­˜å‚¨** | å­˜å‚¨æ˜æ–‡ | å­˜å‚¨å¯†æ–‡ | âœ… å˜åŒ–ï¼ˆå†…å®¹ï¼‰ |
| **æœåŠ¡ç«¯è½¬å‘** | è½¬å‘æ˜æ–‡ | è½¬å‘å¯†æ–‡ | âœ… å˜åŒ–ï¼ˆå†…å®¹ï¼‰ |
| **å®¢æˆ·ç«¯æ¥æ”¶** | ç›´æ¥æ˜¾ç¤º | è§£å¯†åæ˜¾ç¤º | âœ… å˜åŒ– |
| **ç”¨æˆ·çœ‹åˆ°** | "Hello World" | "Hello World" | ç›¸åŒ |

**æœåŠ¡ç«¯å­˜å‚¨ç¤ºä¾‹**ï¼š

```javascript
// Durable Objects ä¸­å­˜å‚¨çš„æ•°æ®ï¼ˆåŠ å¯†å‰ï¼‰
{
  "key": "2025-10-26T10:30:00.000Z",
  "value": {
    "name": "Alice",
    "message": "Hello World",  // âŒ æ˜æ–‡ï¼ŒæœåŠ¡å™¨å¯è§
    "messageId": "uuid-123"
  }
}

// Durable Objects ä¸­å­˜å‚¨çš„æ•°æ®ï¼ˆåŠ å¯†åï¼‰
{
  "key": "2025-10-26T10:30:00.000Z",
  "value": {
    "name": "Alice",
    "message": "ENCRYPTED:{iv:[12,34,...], ciphertext:[78,90,...]}",  // âœ… å¯†æ–‡ï¼ŒæœåŠ¡å™¨ä¸å¯è§
    "messageId": "uuid-123",
    "encryptionType": "e2ee-aes256-gcm"
  }
}
// æ³¨æ„ï¼šæ•°æ®ç»“æ„å®Œå…¨ä¸€è‡´ï¼Œåªæ˜¯ message å­—æ®µçš„å†…å®¹ä»æ˜æ–‡å˜ä¸ºå¯†æ–‡ï¼
```

### 2.2 åŠ å¯†æ–¹æ¡ˆ

#### 2.1.1 åŸºäºæˆ¿é—´å¯†ç 

**æ ¸å¿ƒæ€è·¯**: ç”¨æˆ·åªéœ€è¾“å…¥ä¸€ä¸ªç®€å•çš„"æˆ¿é—´å¯†ç "ï¼Œç³»ç»Ÿè‡ªåŠ¨ä»å¯†ç æ´¾ç”ŸåŠ å¯†å¯†é’¥ã€‚

- **ç”¨æˆ·è¾“å…¥**: æˆ¿é—´å¯†ç ï¼ˆ8-64 å­—ç¬¦ï¼Œå¯ä»¥æ˜¯ä»»ä½•æ–‡æœ¬ï¼‰
- **å¯†é’¥æ´¾ç”Ÿ**: PBKDF2-SHA256ï¼ˆ100,000+ æ¬¡è¿­ä»£ï¼‰
- **åŠ å¯†ç®—æ³•**: AES-GCM (256-bit)
- **ä¼˜åŠ¿**: 
  - âœ… ç”¨æˆ·åªéœ€è®°ä½ä¸€ä¸ªå¯†ç 
  - âœ… æ— éœ€ç®¡ç†å¤æ‚çš„å¯†é’¥
  - âœ… å¯ä»¥å£å¤´åˆ†äº«æˆ–å†™åœ¨çº¸ä¸Š
  - âœ… æ”¯æŒè·¨è®¾å¤‡è®¿é—®

**å¯†ç â†’å¯†é’¥è½¬æ¢æµç¨‹**:
```javascript
ç”¨æˆ·å¯†ç  "mySecretRoom123" 
  â†“ PBKDF2 (100,000 iterations, salt: roomId)
  â†“
AES-256 å¯†é’¥ (ç”¨äºåŠ å¯†æ¶ˆæ¯)
```


### 2.3 å¯†é’¥ç®¡ç†æ¶æ„

**æ ¸å¿ƒåŸåˆ™ï¼šå¯†é’¥æ°¸ä¸ç¦»å¼€å®¢æˆ·ç«¯**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯ (æµè§ˆå™¨)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           IndexedDB (æœ¬åœ°å­˜å‚¨)                       â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  roomPasswords:                                      â”‚  â”‚
â”‚  â”‚    - roomId: "abc123"                                â”‚  â”‚
â”‚  â”‚    - password: "mySecret123"  â† å­˜å‚¨åœ¨ç”¨æˆ·è®¾å¤‡      â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  roomKeys (ç¼“å­˜):                                    â”‚  â”‚
â”‚  â”‚    - roomId: "abc123"                                â”‚  â”‚
â”‚  â”‚    - key: [AES-256 å¯†é’¥æ•°æ®]  â† ä»å¯†ç æ´¾ç”Ÿ         â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                            â†“                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  ç”¨æˆ·èº«ä»½å¯†é’¥å¯¹   â”‚         â”‚   æˆ¿é—´ä¼šè¯å¯†é’¥    â”‚          â”‚
â”‚  â”‚  (RSA/ECDH)     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤   (AES-256)     â”‚          â”‚
â”‚  â”‚  - å…¬é’¥          â”‚         â”‚   - å¯¹ç§°å¯†é’¥      â”‚          â”‚
â”‚  â”‚  - ç§é’¥ (æœ¬åœ°)   â”‚         â”‚   - æ¯ä¸ªæˆ¿é—´ç‹¬ç«‹  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚                            â”‚                      â”‚
â”‚           â”‚                            â”‚                      â”‚
â”‚           â–¼                            â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚         åŠ å¯†/è§£å¯†å¼•æ“ (Web Crypto API)           â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                            â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ ğŸ”’ åªä¼ è¾“åŠ å¯†åçš„æ•°æ®
                             â”‚ âŒ å¯†é’¥æ°¸ä¸é€šè¿‡ç½‘ç»œä¼ è¾“
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cloudflare Workers                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  âŒ æ²¡æœ‰å¯†ç                                                   â”‚
â”‚  âŒ æ²¡æœ‰å¯†é’¥                                                  â”‚
â”‚  âŒ æ— æ³•è§£å¯†                                                  â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Durable Object â”‚         â”‚    R2 Storage    â”‚          â”‚
â”‚  â”‚  - å­˜å‚¨å¯†æ–‡       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  - å­˜å‚¨åŠ å¯†æ–‡ä»¶   â”‚          â”‚
â”‚  â”‚  - å…ƒæ•°æ®         â”‚         â”‚  - å¯†æ–‡ Blob     â”‚          â”‚
â”‚  â”‚  - ä¸çŸ¥é“å¯†é’¥     â”‚         â”‚  - ä¸å¯è§£å¯†       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                               â”‚
â”‚  å­˜å‚¨ç¤ºä¾‹ï¼ˆæœåŠ¡ç«¯è§†è§’ï¼‰ï¼š                                     â”‚
â”‚  {                                                            â”‚
â”‚    "message": "ENCRYPTED:{iv:[...], ciphertext:[...]}"       â”‚
â”‚  }                                                            â”‚
â”‚  â†‘ æœåŠ¡å™¨åªçœ‹åˆ°è¿™äº›ï¼Œæ— æ³•çŸ¥é“åŸæ–‡æ˜¯ä»€ä¹ˆ                      â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯†é’¥ç”Ÿå‘½å‘¨æœŸ**ï¼š

```
1ï¸âƒ£ ç”¨æˆ·åˆ›å»ºæˆ¿é—´
   â†“
   è¾“å…¥æˆ¿é—´å¯†ç ï¼š"mySecret123"
   â†“
   [å®¢æˆ·ç«¯] å¯†ç å­˜å‚¨åˆ° IndexedDB
   â†“
   [å®¢æˆ·ç«¯] PBKDF2 æ´¾ç”Ÿ AES-256 å¯†é’¥
   â†“
   [å®¢æˆ·ç«¯] å¯†é’¥ç¼“å­˜åˆ°å†…å­˜/IndexedDB
   âŒ å¯†ç å’Œå¯†é’¥ä»ä¸å‘é€åˆ°æœåŠ¡å™¨

2ï¸âƒ£ ç”¨æˆ·å‘é€æ¶ˆæ¯
   â†“
   [å®¢æˆ·ç«¯] ä» IndexedDB è¯»å–å¯†ç 
   â†“
   [å®¢æˆ·ç«¯] ä»å¯†ç æ´¾ç”Ÿå¯†é’¥ï¼ˆæˆ–ä½¿ç”¨ç¼“å­˜ï¼‰
   â†“
   [å®¢æˆ·ç«¯] ä½¿ç”¨å¯†é’¥åŠ å¯†æ¶ˆæ¯
   â†“
   [å®¢æˆ·ç«¯] å‘é€å¯†æ–‡åˆ°æœåŠ¡å™¨
   â†“
   [æœåŠ¡ç«¯] å­˜å‚¨å¯†æ–‡ï¼ˆæ— æ³•è§£å¯†ï¼‰

3ï¸âƒ£ å…¶ä»–ç”¨æˆ·åŠ å…¥æˆ¿é—´
   â†“
   è¾“å…¥ç›¸åŒçš„æˆ¿é—´å¯†ç ï¼š"mySecret123"
   â†“
   [å®¢æˆ·ç«¯] å¯†ç å­˜å‚¨åˆ° IndexedDB
   â†“
   [å®¢æˆ·ç«¯] PBKDF2 æ´¾ç”Ÿç›¸åŒçš„ AES-256 å¯†é’¥
   â†“
   [å®¢æˆ·ç«¯] ä½¿ç”¨å¯†é’¥è§£å¯†å†å²æ¶ˆæ¯
   âœ… æœåŠ¡å™¨åªæ˜¯è½¬å‘å¯†æ–‡ï¼Œä¸å‚ä¸åŠ è§£å¯†

4ï¸âƒ£ ç”¨æˆ·ç¦»å¼€å¹¶é‡æ–°è®¿é—®
   â†“
   [å®¢æˆ·ç«¯] ä» IndexedDB è¯»å–ä¿å­˜çš„å¯†ç 
   â†“
   [å®¢æˆ·ç«¯] è‡ªåŠ¨æ´¾ç”Ÿå¯†é’¥
   â†“
   [å®¢æˆ·ç«¯] è‡ªåŠ¨è§£å¯†æ¶ˆæ¯
   âœ… æ— éœ€é‡æ–°è¾“å…¥å¯†ç 
```

**å¯¹æ¯”ä¼ ç»Ÿæ¶æ„**ï¼š

| ä¼ ç»Ÿæ¶æ„ï¼ˆä¸­å¿ƒåŒ–ï¼‰ | E2EE æ¶æ„ï¼ˆå»ä¸­å¿ƒåŒ–ï¼‰ |
|-------------------|---------------------|
| ğŸ”‘ å¯†é’¥å­˜å‚¨åœ¨æœåŠ¡å™¨ | ğŸ”‘ å¯†é’¥å­˜å‚¨åœ¨å®¢æˆ·ç«¯ |
| ğŸ”’ æœåŠ¡å™¨ç«¯åŠ å¯† | ğŸ”’ å®¢æˆ·ç«¯åŠ å¯† |
| ğŸ‘ï¸ æœåŠ¡å™¨å¯è¯»å–å†…å®¹ | âŒ æœåŠ¡å™¨æ— æ³•è¯»å– |
| âš ï¸ æœåŠ¡å™¨è¢«æ”»å‡» = æ•°æ®æ³„éœ² | âœ… æœåŠ¡å™¨è¢«æ”»å‡» = ä»…å¯†æ–‡æ³„éœ² |
| ğŸ’¾ æ•°æ®åº“å­˜å‚¨æ˜æ–‡/å¯è§£å¯†æ•°æ® | ğŸ’¾ æ•°æ®åº“å­˜å‚¨å¯†æ–‡ |
| ğŸ”§ éœ€è¦æœåŠ¡å™¨ç«¯å¯†é’¥ç®¡ç† | ğŸ”§ æ— éœ€æœåŠ¡å™¨ç«¯å¯†é’¥ç®¡ç† |

**æœåŠ¡ç«¯å®Œå…¨ä¸å‚ä¸åŠ å¯†è¿‡ç¨‹**ï¼š

```javascript
// ===== æœåŠ¡ç«¯ä»£ç ï¼ˆDurable Objectsï¼‰=====
// æ³¨æ„ï¼šæœåŠ¡ç«¯ä»£ç ä¸éœ€è¦ä»»ä½•åŠ å¯†é€»è¾‘ï¼

class ChatRoom {
  async handleMessage(request) {
    const { message, name, messageId } = await request.json();
    
    // âœ… ç›´æ¥å­˜å‚¨ï¼Œä¸ç®¡æ˜¯æ˜æ–‡è¿˜æ˜¯å¯†æ–‡
    await this.storage.put(Date.now(), {
      name,
      message,  // å¯èƒ½æ˜¯ "Hello" æˆ– "ENCRYPTED:{...}"ï¼ŒæœåŠ¡ç«¯ä¸å…³å¿ƒ
      messageId
    });
    
    // âœ… ç›´æ¥å¹¿æ’­ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†
    this.broadcast({ name, message, messageId });
    
    // âŒ æ²¡æœ‰ä»»ä½•è§£å¯†ä»£ç 
    // âŒ æ²¡æœ‰ä»»ä½•å¯†é’¥ç®¡ç†ä»£ç 
    // âŒ æœåŠ¡ç«¯å®Œå…¨"æ— çŸ¥"
  }
}
```

**å®‰å…¨æ€§ä¿è¯**ï¼š

âœ… **å³ä½¿æœåŠ¡å™¨è¢«å®Œå…¨æ”»ç ´**ï¼š
  - æ”»å‡»è€…è·å–æ•°æ®åº“ï¼šåªèƒ½çœ‹åˆ°å¯†æ–‡
  - æ”»å‡»è€…è·å–ä»£ç ï¼šæ²¡æœ‰å¯†é’¥ï¼Œæ— æ³•è§£å¯†
  - æ”»å‡»è€…ç›‘å¬ç½‘ç»œï¼šåªèƒ½çœ‹åˆ° HTTPS åŠ å¯†çš„å¯†æ–‡ä¼ è¾“

âœ… **å³ä½¿æ•°æ®åº“å¤‡ä»½æ³„éœ²**ï¼š
  - å¤‡ä»½ä¸­çš„æ¶ˆæ¯éƒ½æ˜¯å¯†æ–‡
  - æ²¡æœ‰å¯†é’¥æ— æ³•è§£å¯†

âœ… **å³ä½¿æœåŠ¡å™¨ç®¡ç†å‘˜æ¶æ„**ï¼š
  - ç®¡ç†å‘˜æ— æ³•è¯»å–ç”¨æˆ·æ¶ˆæ¯
  - ç®¡ç†å‘˜æ— æ³•ä¼ªé€ åŠ å¯†æ¶ˆæ¯ï¼ˆæ²¡æœ‰å¯†é’¥ï¼‰

âŒ **å”¯ä¸€é£é™©**ï¼š
  - ç”¨æˆ·è‡ªå·±æ³„éœ²å¯†ç 
  - å®¢æˆ·ç«¯è®¾å¤‡è¢«æ”»å‡»ï¼ˆç‰©ç†è®¿é—®ï¼‰
  - æ¶æ„æµè§ˆå™¨æ‰©å±•ï¼ˆç”¨æˆ·è´£ä»»ï¼‰

---

## 3. åŠŸèƒ½è¯¦ç»†è®¾è®¡

### 3.1 æˆ¿é—´åˆå§‹åŒ–ä¸å¯†é’¥ç”Ÿæˆ

#### 3.1.1 åˆ›å»ºåŠ å¯†æˆ¿é—´ï¼ˆæˆ¿é—´å¯†ç æ–¹æ¡ˆï¼‰

**è®¾è®¡åŸåˆ™ï¼šé»˜è®¤åŠ å¯†ï¼Œç”¨æˆ·å‹å¥½**

**é»˜è®¤è¡Œä¸ºï¼ˆæ¨èï¼‰ï¼šä½¿ç”¨æˆ¿é—´åä½œä¸ºé»˜è®¤å¯†ç **
- âœ… å¦‚æœç”¨æˆ·ä¸ä¸»åŠ¨è®¾ç½®å¯†ç ï¼Œ**è‡ªåŠ¨ä½¿ç”¨æˆ¿é—´åä½œä¸ºå¯†ç **
- âœ… æä¾›åŸºæœ¬çš„éšç§ä¿æŠ¤ï¼ˆé™Œç”Ÿäººæ— æ³•éšæ„åŠ å…¥ï¼‰
- âœ… é™ä½ç”¨æˆ·ä½¿ç”¨é—¨æ§›ï¼ˆæ— éœ€è®°å¿†é¢å¤–å¯†ç ï¼‰
- âœ… ç”¨æˆ·å¯ä»¥é€‰æ‹©ä½¿ç”¨è‡ªå®šä¹‰å¯†ç ä»¥æé«˜å®‰å…¨æ€§

**ç”¨æˆ·æµç¨‹**:
1. ç”¨æˆ·åˆ›å»ºæˆ¿é—´ï¼Œè¾“å…¥æˆ¿é—´åï¼š"Team Meeting"
2. **ç³»ç»Ÿæç¤ºåŠ å¯†é€‰é¡¹ï¼ˆç®€åŒ–ç‰ˆï¼‰**
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ğŸ”’ Room Privacy Settings                  â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                            â”‚
   â”‚  Room Name: Team Meeting                   â”‚
   â”‚                                            â”‚
   â”‚  ğŸ” Privacy Level:                         â”‚
   â”‚  â— Basic (Use room name as password)       â”‚
   â”‚    Others need to know the room name       â”‚
   â”‚                                            â”‚
   â”‚  â—‹ Enhanced (Set custom password)          â”‚
   â”‚    [________________]                      â”‚
   â”‚                                            â”‚
   â”‚  â—‹ Public (No encryption)                  â”‚
   â”‚                                            â”‚
   â”‚  ğŸ’¡ Recommended: Basic privacy is enabled  â”‚
   â”‚     by default for your protection.        â”‚
   â”‚                                            â”‚
   â”‚  [Create Room]                             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

3. **åœºæ™¯ Aï¼šç”¨æˆ·é€‰æ‹©åŸºç¡€éšç§ï¼ˆé»˜è®¤ï¼‰**
   - ç³»ç»Ÿä½¿ç”¨æˆ¿é—´å "Team Meeting" ä½œä¸ºå¯†ç 
   - æ´¾ç”ŸåŠ å¯†å¯†é’¥
   - æç¤ºï¼š"Share room name with your team to join"
   
4. **åœºæ™¯ Bï¼šç”¨æˆ·é€‰æ‹©å¢å¼ºéšç§**
   - ç”¨æˆ·è¾“å…¥è‡ªå®šä¹‰å¯†ç ï¼ˆå¦‚ "SecretPass123"ï¼‰
   - ç³»ç»Ÿä½¿ç”¨è‡ªå®šä¹‰å¯†ç æ´¾ç”Ÿå¯†é’¥
   - æç¤ºï¼š"Share room name AND password with your team"
   
5. **åœºæ™¯ Cï¼šç”¨æˆ·é€‰æ‹©å…¬å¼€ï¼ˆä¸åŠ å¯†ï¼‰**
   - ä¸ä½¿ç”¨åŠ å¯†
   - ä»»ä½•äººçŸ¥é“æˆ¿é—´ ID å³å¯åŠ å…¥

**æŠ€æœ¯å®ç°**:
```javascript
async function createRoom(roomName, privacyLevel = 'basic') {
  const roomId = generateRoomId();
  
  let password = null;
  let encrypted = false;
  
  switch (privacyLevel) {
    case 'basic':
      // é»˜è®¤ï¼šä½¿ç”¨æˆ¿é—´åä½œä¸ºå¯†ç 
      password = roomName;
      encrypted = true;
      console.log("ğŸ”’ åŸºç¡€åŠ å¯†ï¼šä½¿ç”¨æˆ¿é—´åä½œä¸ºå¯†ç ");
      break;
      
    case 'enhanced':
      // å¢å¼ºï¼šç”¨æˆ·è‡ªå®šä¹‰å¯†ç 
      password = customPassword;  // ç”¨æˆ·è¾“å…¥
      encrypted = true;
      console.log("ğŸ” å¢å¼ºåŠ å¯†ï¼šä½¿ç”¨è‡ªå®šä¹‰å¯†ç ");
      break;
      
    case 'public':
      // å…¬å¼€ï¼šä¸åŠ å¯†
      password = null;
      encrypted = false;
      console.log("ğŸŒ å…¬å¼€æˆ¿é—´ï¼šä¸åŠ å¯†");
      break;
  }
  
  // å¦‚æœå¯ç”¨åŠ å¯†ï¼Œç”ŸæˆéªŒè¯æ•°æ®
  if (encrypted && password) {
    const verificationData = await generateVerificationData(roomId, password);
    
    // åˆ›å»ºæˆ¿é—´
    const response = await fetch('/api/room/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        roomId,
        name: roomName,
        encrypted: true,
        verificationData,
        privacyLevel  // 'basic' æˆ– 'enhanced'
      })
    });
    
    // ä¿å­˜å¯†ç åˆ°æœ¬åœ°
    await keyManager.saveRoomPassword(roomId, password);
    
    return response.json();
  } else {
    // åˆ›å»ºæœªåŠ å¯†æˆ¿é—´
    const response = await fetch('/api/room/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        roomId,
        name: roomName,
        encrypted: false
      })
    });
    
    return response.json();
  }
}

async function deriveKeyFromPassword(password, roomId, iterations = 100000) {
  // 1. å°†å¯†ç è½¬æ¢ä¸ºå¯†é’¥ææ–™
  const encoder = new TextEncoder();
  const passwordBuffer = encoder.encode(password);
  
  const baseKey = await crypto.subtle.importKey(
    "raw",
    passwordBuffer,
    "PBKDF2",
    false,
    ["deriveBits", "deriveKey"]
  );
  
  // 2. ä½¿ç”¨ roomId ä½œä¸º saltï¼ˆç¡®ä¿ä¸åŒæˆ¿é—´ä¸åŒå¯†é’¥ï¼‰
  const salt = encoder.encode(roomId);
  
  // 3. æ´¾ç”Ÿ AES-GCM å¯†é’¥
  const derivedKey = await crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: salt,
      iterations: iterations,
      hash: "SHA-256"
    },
    baseKey,
    { name: "AES-GCM", length: 256 },
    true,
    ["encrypt", "decrypt"]
  );
  
  return derivedKey;
}
```

#### 3.1.2 åŠ å…¥åŠ å¯†æˆ¿é—´ï¼ˆæ™ºèƒ½å¯†ç æç¤ºï¼‰

**âš ï¸ é‡è¦ï¼šå¯†ç éªŒè¯æœºåˆ¶è¯´æ˜**

**é—®é¢˜ï¼šæœåŠ¡å™¨ä¸çŸ¥é“å¯†ç ï¼Œå¦‚ä½•éªŒè¯ç”¨æˆ·è¾“å…¥çš„å¯†ç æ˜¯å¦æ­£ç¡®ï¼Ÿ**

**ç­”æ¡ˆï¼šé€šè¿‡"è§£å¯†æµ‹è¯•"éªŒè¯**

ç”±äºæœåŠ¡å™¨ä¸å­˜å‚¨å¯†ç å’Œå¯†é’¥ï¼Œæˆ‘ä»¬æ— æ³•åœ¨æœåŠ¡ç«¯éªŒè¯å¯†ç ã€‚ä½†æˆ‘ä»¬å¯ä»¥è®©å®¢æˆ·ç«¯å°è¯•è§£å¯†æˆ¿é—´çš„éªŒè¯æ•°æ®ï¼š
- âœ… å¦‚æœè§£å¯†æˆåŠŸï¼Œè¯´æ˜å¯†ç æ­£ç¡®
- âŒ å¦‚æœè§£å¯†å¤±è´¥ï¼ˆæŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œè¯´æ˜å¯†ç é”™è¯¯

**å…³é”®ç‚¹**ï¼š
1. **ä»»ä½•äººéƒ½å¯ä»¥è¿æ¥åˆ°æˆ¿é—´çš„ WebSocket**ï¼ˆæœåŠ¡å™¨ä¸é˜»æ­¢ï¼‰
2. **ä½†åªæœ‰æ­£ç¡®çš„å¯†ç æ‰èƒ½è§£å¯†æ¶ˆæ¯**ï¼ˆå®¢æˆ·ç«¯éªŒè¯ï¼‰
3. **é”™è¯¯çš„å¯†ç ä¼šçœ‹åˆ°è§£å¯†å¤±è´¥æç¤º**ï¼ˆç”¨æˆ·è‡ªå·±çŸ¥é“å¯†ç é”™äº†ï¼‰

---

**ç”¨æˆ·æµç¨‹ï¼ˆæ ¹æ®éšç§çº§åˆ«æ™ºèƒ½æç¤ºï¼‰**:

**åœºæ™¯ Aï¼šåŠ å…¥åŸºç¡€éšç§æˆ¿é—´ï¼ˆprivacyLevel: 'basic'ï¼‰**

```
æ­¥éª¤ 1: ç”¨æˆ·å°è¯•åŠ å…¥æˆ¿é—´
   â†“
æ­¥éª¤ 2: è·å–æˆ¿é—´ä¿¡æ¯
   {
     name: "Team Meeting",
     encrypted: true,
     privacyLevel: "basic"  â† ä½¿ç”¨æˆ¿é—´åä½œä¸ºå¯†ç 
   }
   â†“
æ­¥éª¤ 3: æ™ºèƒ½æç¤ºï¼ˆæç¤ºç”¨æˆ·ä½¿ç”¨æˆ¿é—´åï¼‰
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ğŸ” Protected Room                     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                        â”‚
   â”‚  Room: Team Meeting                    â”‚
   â”‚                                        â”‚
   â”‚  This room uses the room name as       â”‚
   â”‚  password for basic privacy.           â”‚
   â”‚                                        â”‚
   â”‚  ğŸ’¡ Try entering the room name:        â”‚
   â”‚  Password: [Team Meeting_______]       â”‚
   â”‚                                        â”‚
   â”‚  Or ask the room creator for           â”‚
   â”‚  the password if it's different.       â”‚
   â”‚                                        â”‚
   â”‚  [Join Room] [Cancel]                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
æ­¥éª¤ 4: ç³»ç»Ÿè‡ªåŠ¨å°è¯•ä½¿ç”¨æˆ¿é—´å
   - å…ˆè‡ªåŠ¨ä½¿ç”¨ "Team Meeting" éªŒè¯
   - å¦‚æœæˆåŠŸï¼Œç›´æ¥è¿›å…¥
   - å¦‚æœå¤±è´¥ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
```

**åœºæ™¯ Bï¼šåŠ å…¥å¢å¼ºéšç§æˆ¿é—´ï¼ˆprivacyLevel: 'enhanced'ï¼‰**

```
æ­¥éª¤ 1: ç”¨æˆ·å°è¯•åŠ å…¥æˆ¿é—´
   â†“
æ­¥éª¤ 2: è·å–æˆ¿é—´ä¿¡æ¯
   {
     name: "Secret Project",
     encrypted: true,
     privacyLevel: "enhanced"  â† ä½¿ç”¨è‡ªå®šä¹‰å¯†ç 
   }
   â†“
æ­¥éª¤ 3: æç¤ºè¾“å…¥å¯†ç ï¼ˆæ— è‡ªåŠ¨å°è¯•ï¼‰
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ğŸ” Highly Protected Room              â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                        â”‚
   â”‚  Room: Secret Project                  â”‚
   â”‚                                        â”‚
   â”‚  This room uses a custom password      â”‚
   â”‚  for enhanced privacy protection.      â”‚
   â”‚                                        â”‚
   â”‚  Password: [________________]          â”‚
   â”‚                                        â”‚
   â”‚  ğŸ’¡ Ask the room creator for           â”‚
   â”‚     the password to join.              â”‚
   â”‚                                        â”‚
   â”‚  [Join Room] [Cancel]                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
æ­¥éª¤ 4: ç”¨æˆ·å¿…é¡»è¾“å…¥æ­£ç¡®çš„è‡ªå®šä¹‰å¯†ç 
```

**æŠ€æœ¯å®ç°**:

```javascript
async function joinRoom(roomId) {
  // 1. è·å–æˆ¿é—´ä¿¡æ¯
  const response = await fetch(`/api/room/${roomId}/info`);
  const roomInfo = await response.json();
  
  // 2. æ£€æŸ¥æˆ¿é—´æ˜¯å¦åŠ å¯†
  if (!roomInfo.encrypted) {
    // æœªåŠ å¯†æˆ¿é—´ï¼Œç›´æ¥è¿æ¥
    await connectToRoom(roomId);
    return { success: true };
  }
  
  // 3. æ ¹æ®éšç§çº§åˆ«å¤„ç†
  if (roomInfo.privacyLevel === 'basic') {
    // åŸºç¡€éšç§ï¼šå…ˆè‡ªåŠ¨å°è¯•ä½¿ç”¨æˆ¿é—´å
    console.log("ğŸ” æ£€æµ‹åˆ°åŸºç¡€éšç§æˆ¿é—´ï¼Œå°è¯•ä½¿ç”¨æˆ¿é—´åä½œä¸ºå¯†ç ...");
    
    const autoResult = await verifyPasswordWithData(
      roomId, 
      roomInfo.name,  // ä½¿ç”¨æˆ¿é—´åä½œä¸ºå¯†ç 
      roomInfo.verificationData
    );
    
    if (autoResult.success) {
      console.log("âœ… è‡ªåŠ¨éªŒè¯æˆåŠŸï¼Œä½¿ç”¨æˆ¿é—´åä½œä¸ºå¯†ç ");
      await connectToRoom(roomId);
      return { success: true, autoJoined: true };
    } else {
      // è‡ªåŠ¨éªŒè¯å¤±è´¥ï¼Œå¯èƒ½æˆ¿é—´åˆ›å»ºè€…ä¿®æ”¹äº†å¯†ç 
      console.log("âš ï¸ æˆ¿é—´åéªŒè¯å¤±è´¥ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥å¯†ç ");
      return await promptUserForPassword(roomId, roomInfo, 'basic');
    }
  } else if (roomInfo.privacyLevel === 'enhanced') {
    // å¢å¼ºéšç§ï¼šç›´æ¥è¦æ±‚ç”¨æˆ·è¾“å…¥å¯†ç 
    console.log("ğŸ” æ£€æµ‹åˆ°å¢å¼ºéšç§æˆ¿é—´ï¼Œéœ€è¦è‡ªå®šä¹‰å¯†ç ");
    return await promptUserForPassword(roomId, roomInfo, 'enhanced');
  } else {
    // æœªçŸ¥éšç§çº§åˆ«ï¼Œä½¿ç”¨é»˜è®¤æµç¨‹
    return await promptUserForPassword(roomId, roomInfo, 'unknown');
  }
}

async function promptUserForPassword(roomId, roomInfo, privacyLevel) {
  return new Promise((resolve, reject) => {
    // åˆ›å»ºå¯†ç è¾“å…¥å¯¹è¯æ¡†
    const dialog = createPasswordDialog(roomInfo, privacyLevel);
    
    dialog.onSubmit = async (password) => {
      const result = await verifyPasswordWithData(
        roomId,
        password,
        roomInfo.verificationData
      );
      
      if (result.success) {
        await connectToRoom(roomId);
        dialog.close();
        resolve({ success: true });
      } else {
        dialog.showError("å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•");
      }
    };
    
    dialog.onCancel = () => {
      dialog.close();
      reject(new Error('User cancelled'));
    };
    
    // å¦‚æœæ˜¯åŸºç¡€éšç§ï¼Œé¢„å¡«å……æˆ¿é—´å
    if (privacyLevel === 'basic') {
      dialog.setHint(`ğŸ’¡ æç¤ºï¼šå°è¯•è¾“å…¥æˆ¿é—´å "${roomInfo.name}"`);
      dialog.prefillPassword(roomInfo.name);
    }
  });
}

function createPasswordDialog(roomInfo, privacyLevel) {
  const dialog = document.createElement('div');
  dialog.className = 'password-dialog';
  
  let hint = '';
  let title = '';
  
  if (privacyLevel === 'basic') {
    title = 'ğŸ” Protected Room';
    hint = `
      <p>This room uses the room name as password for basic privacy.</p>
      <p>ğŸ’¡ Try entering: <strong>${roomInfo.name}</strong></p>
      <p>Or ask the room creator if the password is different.</p>
    `;
  } else if (privacyLevel === 'enhanced') {
    title = 'ğŸ” Highly Protected Room';
    hint = `
      <p>This room uses a custom password for enhanced privacy.</p>
      <p>ğŸ’¡ Ask the room creator for the password to join.</p>
    `;
  } else {
    title = 'ğŸ” Password Required';
    hint = `
      <p>This room is password protected.</p>
      <p>ğŸ’¡ Enter the password to join.</p>
    `;
  }
  
  dialog.innerHTML = `
    <div class="dialog-content">
      <h3>${title}</h3>
      <p><strong>Room:</strong> ${roomInfo.name}</p>
      <div class="hint">${hint}</div>
      <label>Password:</label>
      <input type="password" id="password-input" placeholder="Enter password">
      <div class="error" style="display:none; color:red;"></div>
      <div class="actions">
        <button id="submit-btn">Join Room</button>
        <button id="cancel-btn">Cancel</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(dialog);
  
  const input = dialog.querySelector('#password-input');
  const submitBtn = dialog.querySelector('#submit-btn');
  const cancelBtn = dialog.querySelector('#cancel-btn');
  const errorDiv = dialog.querySelector('.error');
  
  input.focus();
  
  return {
    onSubmit: null,
    onCancel: null,
    
    close: () => document.body.removeChild(dialog),
    
    showError: (message) => {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      input.value = '';
      input.focus();
    },
    
    setHint: (hintText) => {
      dialog.querySelector('.hint').innerHTML += `<p style="color:blue;">${hintText}</p>`;
    },
    
    prefillPassword: (password) => {
      input.value = password;
      input.select();
    },
    
    _init: function() {
      submitBtn.onclick = () => {
        if (this.onSubmit) {
          this.onSubmit(input.value);
        }
      };
      
      cancelBtn.onclick = () => {
        if (this.onCancel) {
          this.onCancel();
        }
      };
      
      input.onkeypress = (e) => {
        if (e.key === 'Enter' && this.onSubmit) {
          this.onSubmit(input.value);
        }
      };
    }
  }._init();
}

async function verifyRoomPassword(password, roomId, testMessage) {
  try {
    // 1. ä»å¯†ç æ´¾ç”Ÿå¯†é’¥
    const key = await deriveKeyFromPassword(password, roomId);
    
    // 2. å°è¯•è§£å¯†éªŒè¯æ•°æ®ï¼ˆå…³é”®éªŒè¯æ­¥éª¤ï¼‰
    const decrypted = await CryptoUtils.decryptMessage(testMessage, key);
    
    // 3. è§£å¯†æˆåŠŸ = å¯†ç æ­£ç¡®
    // AES-GCM ä¼šéªŒè¯æ¶ˆæ¯å®Œæ•´æ€§ï¼Œå¦‚æœå¯†é’¥é”™è¯¯ä¼šæŠ›å‡ºå¼‚å¸¸
    console.log("âœ… Password verified successfully");
    
    // 4. ä¿å­˜å¯†ç åˆ°æœ¬åœ°
    await keyManager.saveRoomPassword(roomId, password);
    
    return { success: true, key };
  } catch (error) {
    // 4. è§£å¯†å¤±è´¥ = å¯†ç é”™è¯¯
    // AES-GCM è§£å¯†å¤±è´¥ä¼šæŠ›å‡º "OperationError" å¼‚å¸¸
    console.error("âŒ Password verification failed:", error);
    
    return { success: false, error: "Incorrect password" };
  }
}
```

**"éªŒè¯æ•°æ®"ä»å“ªé‡Œæ¥ï¼Ÿå¦‚ä½•éªŒè¯ï¼Ÿ**

**æ ¸å¿ƒæ€è·¯ï¼šåˆ›å»ºæˆ¿é—´æ—¶ï¼Œç”ŸæˆåŠ å¯†çš„éªŒè¯æ•°æ®ï¼Œé€šè¿‡å•ç‹¬çš„ HTTP è¯·æ±‚å­˜å‚¨åœ¨æˆ¿é—´çš„å…ƒæ•°æ®å±æ€§ä¸­**

```
æµç¨‹å›¾ï¼š

1ï¸âƒ£ åˆ›å»ºæˆ¿é—´ï¼ˆå•ç‹¬çš„ HTTP POST è¯·æ±‚ï¼‰ï¼š
   
   ç”¨æˆ·è¾“å…¥å¯†ç  "mySecret123"
      â†“
   å®¢æˆ·ç«¯æ„é€ éªŒè¯è½½è·ï¼š{ roomId: "abc123", type: "verification" }
      â†“
   ä½¿ç”¨å¯†ç æ´¾ç”Ÿçš„å¯†é’¥åŠ å¯†éªŒè¯è½½è·
      â†“
   HTTP POST /api/room/create
   {
     name: "Secret Chat",
     encrypted: true,
     verificationData: "ENCRYPTED:{iv:[...], ciphertext:[...]}"
   }
      â†“
   æœåŠ¡ç«¯ï¼ˆDurable Objectï¼‰å­˜å‚¨åœ¨æˆ¿é—´å±æ€§ä¸­ï¼š
   {
     roomId: "abc123",
     name: "Secret Chat",
     encrypted: true,
     verificationData: "ENCRYPTED:{iv:[...], ciphertext:[...]}"  â† å­˜ä¸ºå±æ€§
   }
   
   âš ï¸ é‡è¦ï¼šverificationData å­˜å‚¨åœ¨æˆ¿é—´çš„å…ƒæ•°æ®å±æ€§ä¸­
   âš ï¸ ä¸æ˜¯å­˜å‚¨åœ¨æ¶ˆæ¯åˆ—è¡¨ä¸­
   âš ï¸ ä¸èŠå¤©æ¶ˆæ¯å®Œå…¨åˆ†ç¦»

2ï¸âƒ£ åŠ å…¥æˆ¿é—´æ—¶éªŒè¯å¯†ç ï¼ˆHTTP GET è¯·æ±‚ï¼‰ï¼š
   
   ç”¨æˆ·è¾“å…¥å¯†ç  "wrongPassword"
      â†“
   HTTP GET /api/room/abc123/info
      â†“
   æœåŠ¡ç«¯è¿”å›æˆ¿é—´å…ƒæ•°æ®ï¼š
   {
     roomId: "abc123",
     name: "Secret Chat",
     encrypted: true,
     verificationData: "ENCRYPTED:{iv:[...], ciphertext:[...]}"  â† å¯†æ–‡
   }
      â†“
   å®¢æˆ·ç«¯è·å– verificationDataï¼ˆå¯†æ–‡ï¼‰
      â†“
   ä½¿ç”¨è¾“å…¥çš„å¯†ç æ´¾ç”Ÿå¯†é’¥ï¼Œå°è¯•è§£å¯†
      â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å¦‚æœå¯†ç æ­£ç¡®ï¼š                          â”‚
   â”‚  âœ… è§£å¯†æˆåŠŸ                            â”‚
   â”‚  âœ… è§£å¯†å‡ºï¼š{ roomId: "abc123", ... }   â”‚
   â”‚  âœ… éªŒè¯ roomId åŒ¹é…                    â”‚
   â”‚  âœ… å…è®¸è¿æ¥ WebSocketï¼Œè¿›å…¥æˆ¿é—´        â”‚
   â”‚                                        â”‚
   â”‚ å¦‚æœå¯†ç é”™è¯¯ï¼š                          â”‚
   â”‚  âŒ è§£å¯†å¤±è´¥ï¼ˆAES-GCM æŠ›å‡ºå¼‚å¸¸ï¼‰        â”‚
   â”‚  âŒ æ˜¾ç¤º"å¯†ç é”™è¯¯"æç¤º                  â”‚
   â”‚  âŒ ä¸å…è®¸è¿›å…¥æˆ¿é—´                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**ï¼š
- âœ… éªŒè¯æ•°æ®å­˜å‚¨åœ¨ **Durable Object çš„æˆ¿é—´å…ƒæ•°æ®å±æ€§**ä¸­
- âœ… **ä¸æ˜¯å­˜å‚¨åœ¨æ¶ˆæ¯åˆ—è¡¨**ä¸­ï¼ˆä¸èŠå¤©æ¶ˆæ¯å®Œå…¨åˆ†ç¦»ï¼‰
- âœ… åˆ›å»ºæˆ¿é—´æ—¶é€šè¿‡**å•ç‹¬çš„ HTTP POST è¯·æ±‚**ä¸Šä¼ éªŒè¯æ•°æ®
- âœ… åŠ å…¥æˆ¿é—´æ—¶é€šè¿‡ **GET /api/room/:id/info** è·å–æˆ¿é—´ä¿¡æ¯
- âœ… æœåŠ¡ç«¯**åªå­˜å‚¨å¯†æ–‡**ï¼Œä¸çŸ¥é“éªŒè¯è½½è·çš„å†…å®¹
- âœ… éªŒè¯å®Œå…¨åœ¨**å®¢æˆ·ç«¯**é€šè¿‡"èƒ½å¦è§£å¯†"æ¥åˆ¤æ–­
- âœ… AES-GCM ç®—æ³•è‡ªå¸¦**å®Œæ•´æ€§éªŒè¯**ï¼Œé”™è¯¯çš„å¯†é’¥æ— æ³•è§£å¯†

---

**è¯¦ç»†å®ç°ï¼š**

**è¯¦ç»†å®ç°ï¼š**

```javascript
// ========================================
// æ­¥éª¤ 1ï¼šåˆ›å»ºåŠ å¯†æˆ¿é—´ï¼ˆå•ç‹¬çš„ HTTP POST è¯·æ±‚ï¼‰
// ========================================

async function createRoomWithPassword(roomName, password) {
  if (!password) {
    // æœªåŠ å¯†æˆ¿é—´ï¼Œæ™®é€šåˆ›å»º
    return await fetch('/api/room/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: roomName })
    });
  }
  
  // 1. ä»å¯†ç æ´¾ç”ŸåŠ å¯†å¯†é’¥
  const roomId = generateRoomId(); // å…ˆç”Ÿæˆæˆ¿é—´ ID
  const key = await CryptoUtils.deriveKeyFromPassword(password, roomId);
  
  // 2. æ„é€ éªŒè¯è½½è·ï¼ˆåŒ…å«æˆ¿é—´ä¿¡æ¯ï¼‰
  const verificationPayload = {
    type: "room-verification",        // æ¶ˆæ¯ç±»å‹æ ‡è¯†
    roomId: roomId,                   // æˆ¿é—´ IDï¼ˆç”¨äºéªŒè¯ï¼‰
    version: "1.0",                   // åè®®ç‰ˆæœ¬
    timestamp: Date.now(),            // åˆ›å»ºæ—¶é—´æˆ³
    salt: crypto.randomUUID()         // éšæœºç›å€¼ï¼ˆé˜²æ­¢é¢„æµ‹æ”»å‡»ï¼‰
  };
  
  // 3. åŠ å¯†éªŒè¯è½½è·
  const encrypted = await CryptoUtils.encryptMessage(
    JSON.stringify(verificationPayload),
    key
  );
  
  // 4. é€šè¿‡ HTTP POST åˆ›å»ºæˆ¿é—´ï¼ŒåŒ…å«éªŒè¯æ•°æ®
  const response = await fetch('/api/room/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      roomId: roomId,
      name: roomName,
      encrypted: true,                              // æ ‡è®°ä¸ºåŠ å¯†æˆ¿é—´
      verificationData: `ENCRYPTED:${JSON.stringify(encrypted)}`  // éªŒè¯æ•°æ®ï¼ˆå¯†æ–‡ï¼‰
    })
  });
  
  const result = await response.json();
  
  // 5. ä¿å­˜å¯†ç åˆ°å®¢æˆ·ç«¯æœ¬åœ°
  await keyManager.saveRoomPassword(roomId, password);
  
  console.log("âœ… åŠ å¯†æˆ¿é—´åˆ›å»ºæˆåŠŸï¼ŒéªŒè¯æ•°æ®å·²å­˜å‚¨åˆ°æˆ¿é—´å±æ€§ä¸­");
  return result;
}


// ========================================
// æœåŠ¡ç«¯ä»£ç ï¼šDurable Object å­˜å‚¨éªŒè¯æ•°æ®
// ========================================

// src/room.js (Durable Object)
export class ChatRoom {
  constructor(state, env) {
    this.state = state;
    this.env = env;
  }
  
  async fetch(request) {
    const url = new URL(request.url);
    
    // åˆ›å»ºæˆ¿é—´
    if (url.pathname === '/create' && request.method === 'POST') {
      const { roomId, name, encrypted, verificationData } = await request.json();
      
      // å­˜å‚¨æˆ¿é—´å…ƒæ•°æ®åˆ° Durable Object çš„å±æ€§ä¸­
      const roomMetadata = {
        roomId,
        name,
        encrypted: encrypted || false,
        createdAt: Date.now()
      };
      
      // âš ï¸ å…³é”®ï¼šå°†éªŒè¯æ•°æ®å­˜å‚¨ä¸ºå•ç‹¬çš„å±æ€§
      if (encrypted && verificationData) {
        roomMetadata.verificationData = verificationData;  // å­˜å‚¨å¯†æ–‡
        // â˜ï¸ æœåŠ¡ç«¯åªçœ‹åˆ°å¯†æ–‡ï¼Œä¸çŸ¥é“å†…å®¹ï¼
      }
      
      // å­˜å‚¨åˆ° Durable Object storage
      await this.state.storage.put('metadata', roomMetadata);
      
      return new Response(JSON.stringify({
        success: true,
        roomId
      }), {
        headers: { 'Content-Type': 'application/json' }
      });
    }
    
    // è·å–æˆ¿é—´ä¿¡æ¯
    if (url.pathname.startsWith('/info')) {
      const metadata = await this.state.storage.get('metadata');
      
      return new Response(JSON.stringify(metadata), {
        headers: { 'Content-Type': 'application/json' }
      });
    }
    
    // å…¶ä»–è¯·æ±‚...
  }
}

// Durable Object ä¸­å­˜å‚¨çš„æ•°æ®ç»“æ„ï¼š
// {
//   metadata: {
//     roomId: "abc123",
//     name: "Secret Chat",
//     encrypted: true,
//     verificationData: "ENCRYPTED:{iv:[12,34,...], ciphertext:[78,90,...]}"
//     createdAt: 1729936800000
//   },
//   
//   // èŠå¤©æ¶ˆæ¯å­˜å‚¨åœ¨å…¶ä»–é”®ä¸­
//   "2025-10-26T10:00:00.000Z": {
//     name: "Alice",
//     message: "ENCRYPTED:{...}",
//     messageId: "uuid-xxx"
//   },
//   "2025-10-26T10:01:00.000Z": {
//     name: "Bob",
//     message: "ENCRYPTED:{...}",
//     messageId: "uuid-yyy"
//   }
// }
// â˜ï¸ verificationData å­˜å‚¨åœ¨ metadata ä¸­ï¼Œä¸åœ¨æ¶ˆæ¯åˆ—è¡¨ä¸­


// ========================================
// æ­¥éª¤ 2ï¼šåŠ å…¥æˆ¿é—´æ—¶éªŒè¯å¯†ç ï¼ˆHTTP GET è¯·æ±‚ï¼‰
// ========================================

async function joinRoomWithPassword(roomId, password) {
  // 1. è·å–æˆ¿é—´ä¿¡æ¯ï¼ˆHTTP GET è¯·æ±‚ï¼‰
  const response = await fetch(`/api/room/${roomId}/info`);
  const roomInfo = await response.json();
  
  // ç¤ºä¾‹è¿”å›æ•°æ®ï¼š
  // {
  //   roomId: "abc123",
  //   name: "Secret Chat",
  //   encrypted: true,
  //   verificationData: "ENCRYPTED:{iv:[...], ciphertext:[...]}"
  // }
  
  // 2. æ£€æŸ¥æˆ¿é—´æ˜¯å¦åŠ å¯†
  if (!roomInfo.encrypted) {
    // æœªåŠ å¯†æˆ¿é—´ï¼Œç›´æ¥è¿›å…¥
    await connectToRoom(roomId);
    return { success: true };
  }
  
  // 3. æ£€æŸ¥æ˜¯å¦æœ‰éªŒè¯æ•°æ®
  if (!roomInfo.verificationData) {
    console.warn("âš ï¸ åŠ å¯†æˆ¿é—´ç¼ºå°‘éªŒè¯æ•°æ®");
    // é™çº§ï¼šå…è®¸è¿›å…¥ä½†æ ‡è®°éœ€è¦åç»­éªŒè¯
    await keyManager.saveRoomPassword(roomId, password);
    await connectToRoom(roomId);
    return { success: true, needsVerification: true };
  }
  
  // 4. éªŒè¯å¯†ç ï¼ˆå®¢æˆ·ç«¯è§£å¯†æµ‹è¯•ï¼‰
  return await verifyPasswordWithData(roomId, password, roomInfo.verificationData);
}


// ========================================
// æ­¥éª¤ 3ï¼šå¯†ç éªŒè¯æ ¸å¿ƒé€»è¾‘ï¼ˆå®¢æˆ·ç«¯ï¼‰
// ========================================

async function verifyPasswordWithData(roomId, password, encryptedData) {
  // 1. è§£æå¯†æ–‡
  const encrypted = JSON.parse(
    encryptedData.substring(10)  // å»æ‰ "ENCRYPTED:" å‰ç¼€
  );
  
  try {
    // 2. ä»å¯†ç æ´¾ç”Ÿå¯†é’¥
    console.log("ğŸ”‘ æ­£åœ¨ä»å¯†ç æ´¾ç”Ÿå¯†é’¥...");
    const key = await CryptoUtils.deriveKeyFromPassword(password, roomId);
    
    // 3. å°è¯•è§£å¯†éªŒè¯æ•°æ®ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰
    console.log("ğŸ”“ æ­£åœ¨å°è¯•è§£å¯†éªŒè¯æ•°æ®...");
    const decrypted = await CryptoUtils.decryptMessage(encrypted, key);
    
    // 4. è§£å¯†æˆåŠŸï¼è§£æéªŒè¯è½½è·
    const payload = JSON.parse(decrypted);
    
    // 5. éªŒè¯è½½è·å†…å®¹
    if (payload.type === "room-verification") {
      // éªŒè¯æˆ¿é—´ ID æ˜¯å¦åŒ¹é…
      if (payload.roomId === roomId) {
        console.log("âœ… éªŒè¯æˆåŠŸï¼šæˆ¿é—´ ID åŒ¹é…");
        
        // 6. ä¿å­˜å¯†ç åˆ°æœ¬åœ°
        await keyManager.saveRoomPassword(roomId, password);
        
        // 7. è¿æ¥åˆ°æˆ¿é—´çš„ WebSocket
        await connectToRoom(roomId);
        
        return { 
          success: true,
          message: "å¯†ç éªŒè¯æˆåŠŸ"
        };
      } else {
        // æˆ¿é—´ ID ä¸åŒ¹é…ï¼ˆç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼‰
        console.error("âŒ éªŒè¯å¤±è´¥ï¼šæˆ¿é—´ ID ä¸åŒ¹é…");
        return {
          success: false,
          error: "éªŒè¯æ•°æ®å¼‚å¸¸ï¼Œè¯·è”ç³»æˆ¿é—´åˆ›å»ºè€…"
        };
      }
    } else {
      // éªŒè¯è½½è·æ ¼å¼é”™è¯¯
      console.error("âŒ éªŒè¯å¤±è´¥ï¼šæ— æ•ˆçš„éªŒè¯æ•°æ®");
      return {
        success: false,
        error: "éªŒè¯æ•°æ®æ ¼å¼é”™è¯¯"
      };
    }
    
  } catch (error) {
    // 7. è§£å¯†å¤±è´¥ = å¯†ç é”™è¯¯ï¼
    console.error("âŒ è§£å¯†å¤±è´¥:", error.message);
    
    // AES-GCM è§£å¯†å¤±è´¥ä¼šæŠ›å‡º "OperationError" å¼‚å¸¸
    return {
      success: false,
      error: "å¯†ç é”™è¯¯ï¼Œè¯·æ£€æŸ¥åé‡è¯•"
    };
  }
}


// ========================================
// å®Œæ•´ç¤ºä¾‹ï¼šç”¨æˆ·è§†è§’
// ========================================

// ã€åœºæ™¯ 1ã€‘ç”¨æˆ· A åˆ›å»ºåŠ å¯†æˆ¿é—´
console.log("=== ç”¨æˆ· A åˆ›å»ºæˆ¿é—´ ===");

await createRoomWithPassword("Secret Chat", "myPassword123");

// HTTP POST /api/room/create
// è¯·æ±‚ä½“ï¼š
// {
//   roomId: "abc123",
//   name: "Secret Chat",
//   encrypted: true,
//   verificationData: "ENCRYPTED:{iv:[1,2,3,...], ciphertext:[4,5,6,...]}"
// }

// æœåŠ¡ç«¯ï¼ˆDurable Objectï¼‰å­˜å‚¨ï¼š
// metadata: {
//   roomId: "abc123",
//   name: "Secret Chat",
//   encrypted: true,
//   verificationData: "ENCRYPTED:{...}"  â† å¯†æ–‡ï¼ŒæœåŠ¡ç«¯çœ‹ä¸æ‡‚
// }

console.log("âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸ");


// ã€åœºæ™¯ 2ã€‘ç”¨æˆ· B åŠ å…¥ï¼ˆæ­£ç¡®å¯†ç ï¼‰
console.log("\n=== ç”¨æˆ· B åŠ å…¥ï¼ˆæ­£ç¡®å¯†ç ï¼‰===");

const result1 = await joinRoomWithPassword("abc123", "myPassword123");

// HTTP GET /api/room/abc123/info
// æœåŠ¡ç«¯è¿”å›ï¼š
// {
//   roomId: "abc123",
//   encrypted: true,
//   verificationData: "ENCRYPTED:{...}"
// }

// å®¢æˆ·ç«¯å¤„ç†ï¼š
// 1. ä½¿ç”¨ "myPassword123" æ´¾ç”Ÿå¯†é’¥
// 2. è§£å¯† verificationData
// 3. è§£å¯†æˆåŠŸï¼å¾—åˆ°ï¼š{ type: "room-verification", roomId: "abc123", ... }
// 4. éªŒè¯ roomId åŒ¹é…
// 5. è¿æ¥ WebSocket
// 6. ç»“æœï¼š{ success: true }

console.log("âœ… ç”¨æˆ· B æˆåŠŸåŠ å…¥æˆ¿é—´");


// ã€åœºæ™¯ 3ã€‘ç”¨æˆ· C åŠ å…¥ï¼ˆé”™è¯¯å¯†ç ï¼‰
console.log("\n=== ç”¨æˆ· C åŠ å…¥ï¼ˆé”™è¯¯å¯†ç ï¼‰===");

const result2 = await joinRoomWithPassword("abc123", "wrongPassword");

// HTTP GET /api/room/abc123/info
// æœåŠ¡ç«¯è¿”å›ï¼š
// {
//   roomId: "abc123",
//   encrypted: true,
//   verificationData: "ENCRYPTED:{...}"
// }

// å®¢æˆ·ç«¯å¤„ç†ï¼š
// 1. ä½¿ç”¨ "wrongPassword" æ´¾ç”Ÿå¯†é’¥
// 2. å°è¯•è§£å¯† verificationData
// 3. è§£å¯†å¤±è´¥ï¼AES-GCM æŠ›å‡ºå¼‚å¸¸
// 4. ç»“æœï¼š{ success: false, error: "å¯†ç é”™è¯¯" }

console.log("âŒ ç”¨æˆ· C å¯†ç é”™è¯¯ï¼Œæ— æ³•åŠ å…¥");
```
    };
    
    // 4. åŠ å¯†éªŒè¯è½½è·
    const encrypted = await CryptoUtils.encryptMessage(
      JSON.stringify(verificationPayload),
      key
    );
    
    // 5. å‘é€åˆ°æœåŠ¡ç«¯å­˜å‚¨ï¼ˆæœåŠ¡ç«¯åªçœ‹åˆ°å¯†æ–‡ï¼‰
    ws.send(JSON.stringify({
      message: `ENCRYPTED:${JSON.stringify(encrypted)}`,
      messageId: crypto.randomUUID(),
      encryptionType: "e2ee-aes256-gcm",
      isVerificationMessage: true,      // æ ‡è®°ä¸ºéªŒè¯æ¶ˆæ¯
      timestamp: Date.now()
    }));
    
    // 6. ä¿å­˜å¯†ç åˆ°å®¢æˆ·ç«¯æœ¬åœ°
    await keyManager.saveRoomPassword(roomId, password);
    
    console.log("âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸï¼ŒéªŒè¯æ¶ˆæ¯å·²åŠ å¯†å­˜å‚¨");
  }
  
  return roomId;
}

// æœåŠ¡ç«¯æ”¶åˆ°çš„æ•°æ®ï¼ˆå¯†æ–‡ï¼‰ï¼š
// {
//   "message": "ENCRYPTED:{iv:[12,34,56,...], ciphertext:[78,90,12,...]}",
//   "isVerificationMessage": true
// }
// â˜ï¸ æœåŠ¡ç«¯å®Œå…¨ä¸çŸ¥é“é‡Œé¢çš„å†…å®¹ï¼


// ========================================
// å¤‡é€‰æ–¹æ¡ˆï¼šå¦‚æœæˆ¿é—´æ²¡æœ‰éªŒè¯æ•°æ®ï¼ˆé™çº§å¤„ç†ï¼‰
// ========================================

async function joinRoomWithoutVerificationData(roomId, password) {
  console.warn("âš ï¸ æˆ¿é—´ç¼ºå°‘éªŒè¯æ•°æ®ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ");
  
  // æ–¹æ¡ˆ 1ï¼šç›´æ¥ä¿å­˜å¯†ç ï¼Œç­‰å¾…åç»­éªŒè¯
  await keyManager.saveRoomPassword(roomId, password);
  await connectToRoom(roomId);
  
  // å½“æ¥æ”¶åˆ°ç¬¬ä¸€æ¡åŠ å¯†æ¶ˆæ¯æ—¶ï¼Œå°è¯•è§£å¯†æ¥éªŒè¯å¯†ç 
  // å¦‚æœè§£å¯†å¤±è´¥ï¼Œæç¤ºç”¨æˆ·å¯†ç å¯èƒ½é”™è¯¯
  
  return { 
    success: true, 
    needsVerification: true,
    warning: "æ— æ³•é¢„å…ˆéªŒè¯å¯†ç ï¼Œå°†åœ¨æ¥æ”¶æ¶ˆæ¯æ—¶éªŒè¯"
  };
}


// ========================================
// å…³é”®æ•°æ®æµå¯¹æ¯”
// ========================================

/**
 * ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆæœåŠ¡ç«¯éªŒè¯ï¼‰ï¼š
 * 
 * POST /api/room/create { password: "123" }
 *   â†“
 * æœåŠ¡ç«¯å­˜å‚¨å¯†ç å“ˆå¸Œ
 *   â†“
 * GET /api/room/verify { password: "123" }
 *   â†“
 * æœåŠ¡ç«¯æ¯”è¾ƒå“ˆå¸Œï¼Œè¿”å› true/false
 * 
 * âŒ é—®é¢˜ï¼šæœåŠ¡ç«¯çŸ¥é“å¯†ç ä¿¡æ¯
 */

/**
 * E2EE æ–¹æ¡ˆï¼ˆå®¢æˆ·ç«¯éªŒè¯ï¼‰ï¼š
 * 
 * åˆ›å»ºé˜¶æ®µï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ å®¢æˆ·ç«¯                                   â”‚
 * â”‚ password "123" â†’ æ´¾ç”Ÿå¯†é’¥ â†’ åŠ å¯†è½½è·     â”‚
 * â”‚ å¾—åˆ°ï¼šverificationData (å¯†æ–‡)            â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *              â”‚
 *              â–¼
 * POST /api/room/create
 * {
 *   verificationData: "ENCRYPTED:{...}"  â† å¯†æ–‡
 * }
 *              â”‚
 *              â–¼
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ æœåŠ¡ç«¯ï¼ˆDurable Objectï¼‰                â”‚
 * â”‚ å­˜å‚¨åˆ° metadata.verificationData         â”‚
 * â”‚ âŒ æœåŠ¡ç«¯çœ‹ä¸æ‡‚å†…å®¹                      â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * 
 * éªŒè¯é˜¶æ®µï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ å®¢æˆ·ç«¯                                   â”‚
 * â”‚ GET /api/room/abc123/info                â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *              â”‚
 *              â–¼
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ æœåŠ¡ç«¯                                   â”‚
 * â”‚ è¿”å› metadata.verificationData (å¯†æ–‡)    â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *              â”‚
 *              â–¼
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ å®¢æˆ·ç«¯                                   â”‚
 * â”‚ password â†’ æ´¾ç”Ÿå¯†é’¥ â†’ å°è¯•è§£å¯†           â”‚
 * â”‚ âœ… æˆåŠŸ = å¯†ç æ­£ç¡®                       â”‚
 * â”‚ âŒ å¤±è´¥ = å¯†ç é”™è¯¯                       â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * 
 * âœ… ä¼˜åŠ¿ï¼šæœåŠ¡ç«¯å®Œå…¨ä¸çŸ¥é“å¯†ç 
 */


// ========================================
// å­˜å‚¨ç»“æ„å¯¹æ¯”
// ========================================

// Durable Object å­˜å‚¨ç»“æ„ï¼ˆæ¸…æ™°åˆ†ç¦»ï¼‰
{
  // æˆ¿é—´å…ƒæ•°æ®ï¼ˆå›ºå®šå±æ€§ï¼‰
  metadata: {
    roomId: "abc123",
    name: "Secret Chat",
    encrypted: true,
    verificationData: "ENCRYPTED:{...}",  â† éªŒè¯æ•°æ®åœ¨è¿™é‡Œ
    createdAt: 1729936800000
  },
  
  // èŠå¤©æ¶ˆæ¯ï¼ˆæ—¶é—´æˆ³ä¸ºé”®ï¼‰
  "2025-10-26T10:00:00.000Z": {
    name: "Alice",
    message: "ENCRYPTED:{...}",
    messageId: "uuid-1"
  },
  "2025-10-26T10:01:00.000Z": {
    name: "Bob",  
    message: "ENCRYPTED:{...}",
    messageId: "uuid-2"
  }
}

// â˜ï¸ å…³é”®ç‚¹ï¼š
// 1. verificationData å­˜å‚¨åœ¨ metadata å±æ€§ä¸­
// 2. ä¸åœ¨æ¶ˆæ¯åˆ—è¡¨ä¸­ï¼ˆmessagesï¼‰
// 3. åˆ›å»ºæˆ¿é—´æ—¶å•ç‹¬è®¾ç½®
// 4. è·å–æˆ¿é—´ä¿¡æ¯æ—¶è¿”å›


// ========================================
// API è®¾è®¡
// ========================================

// 1. åˆ›å»ºåŠ å¯†æˆ¿é—´
POST /api/room/create
{
  "roomId": "abc123",
  "name": "Secret Chat",
  "encrypted": true,
  "verificationData": "ENCRYPTED:{iv:[...], ciphertext:[...]}"
}

// å“åº”ï¼š
{
  "success": true,
  "roomId": "abc123"
}


// 2. è·å–æˆ¿é—´ä¿¡æ¯ï¼ˆç”¨äºå¯†ç éªŒè¯ï¼‰
GET /api/room/abc123/info

// å“åº”ï¼š
{
  "roomId": "abc123",
  "name": "Secret Chat",
  "encrypted": true,
  "verificationData": "ENCRYPTED:{iv:[...], ciphertext:[...]}"
  "createdAt": 1729936800000
}


// 3. è¿æ¥ WebSocketï¼ˆåœ¨å¯†ç éªŒè¯åï¼‰
WebSocket ws://example.com/api/room/abc123/websocket


// ========================================
// æ€»ç»“
// ========================================

console.log("=== æ ¸å¿ƒè®¾è®¡è¦ç‚¹ ===");
console.log("1ï¸âƒ£ éªŒè¯æ•°æ®å­˜å‚¨ä½ç½®ï¼š");
console.log("   - å­˜å‚¨åœ¨ Durable Object çš„ metadata.verificationData å±æ€§");
console.log("   - ä¸æ˜¯å­˜å‚¨åœ¨æ¶ˆæ¯åˆ—è¡¨ä¸­");
console.log("   - ä¸èŠå¤©æ¶ˆæ¯å®Œå…¨åˆ†ç¦»");

console.log("\n2ï¸âƒ£ API è®¾è®¡ï¼š");
console.log("   - POST /api/room/create - åˆ›å»ºæˆ¿é—´ï¼ŒåŒ…å« verificationData");
console.log("   - GET /api/room/:id/info - è·å–æˆ¿é—´ä¿¡æ¯ï¼Œè¿”å› verificationData");
console.log("   - WebSocket è¿æ¥åœ¨å¯†ç éªŒè¯å");

console.log("\n3ï¸âƒ£ éªŒè¯æµç¨‹ï¼š");
console.log("   - åˆ›å»ºæ—¶ï¼šåŠ å¯†éªŒè¯è½½è· â†’ POST åˆ°æœåŠ¡ç«¯");
console.log("   - åŠ å…¥æ—¶ï¼šGET è·å– verificationData â†’ è§£å¯†æµ‹è¯• â†’ æˆåŠŸ/å¤±è´¥");

console.log("\n4ï¸âƒ£ æœåŠ¡ç«¯èŒè´£ï¼š");
console.log("   - åªå­˜å‚¨å¯†æ–‡ï¼ˆverificationDataï¼‰");
console.log("   - ä¸çŸ¥é“å¯†ç ");
console.log("   - ä¸å‚ä¸éªŒè¯");
console.log("   - åªè´Ÿè´£å­˜å‚¨å’Œè¿”å›");

console.log("\n5ï¸âƒ£ å®¢æˆ·ç«¯èŒè´£ï¼š");
console.log("   - ç”ŸæˆéªŒè¯æ•°æ®");
console.log("   - åŠ å¯†éªŒè¯è½½è·");
console.log("   - éªŒè¯å¯†ç ï¼ˆè§£å¯†æµ‹è¯•ï¼‰");
console.log("   - ç®¡ç†å¯†é’¥");
```

---

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **ç‹¬ç«‹å­˜å‚¨** | verificationData ä½œä¸ºæˆ¿é—´å…ƒæ•°æ®ï¼Œä¸æ¶ˆæ¯åˆ†ç¦» |
| **å•ç‹¬è¯·æ±‚** | åˆ›å»ºæˆ¿é—´æ—¶é€šè¿‡ HTTP POST ä¸€æ¬¡æ€§è®¾ç½® |
| **å¿«é€ŸéªŒè¯** | åŠ å…¥æ—¶é€šè¿‡ GET /info ç«‹å³è·å–ï¼Œæ— éœ€éå†æ¶ˆæ¯ |
| **æ¸…æ™°åˆ†ç¦»** | æˆ¿é—´å±æ€§ vs èŠå¤©æ¶ˆæ¯ï¼ŒèŒè´£æ˜ç¡® |
| **é«˜æ•ˆè®¿é—®** | ç›´æ¥è¯»å–å±æ€§ï¼Œä¸éœ€è¦æŸ¥è¯¢æ¶ˆæ¯åˆ—è¡¨ |
| **å‘åå…¼å®¹** | æœªåŠ å¯†æˆ¿é—´çš„ verificationData ä¸ºç©º |

**æ•°æ®æµå®Œæ•´ç¤ºæ„å›¾**ï¼š

```
åˆ›å»ºåŠ å¯†æˆ¿é—´ï¼š
                                                      
  ğŸ‘¤ ç”¨æˆ· A                     ğŸ–¥ï¸ å®¢æˆ·ç«¯                     â˜ï¸ æœåŠ¡ç«¯
    â”‚                            â”‚                            â”‚
    â”‚ è¾“å…¥å¯†ç  "ABC"              â”‚                            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                            â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ 1. æ„é€ éªŒè¯è½½è·            â”‚
    â”‚                            â”‚    {roomId:"123"}          â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ 2. ä½¿ç”¨ ABC åŠ å¯†           â”‚
    â”‚                            â”‚    å¾—åˆ°å¯†æ–‡                 â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ POST /room/create          â”‚
    â”‚                            â”‚ {verificationData:"ENC.."}  â”‚
    â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚                            â”‚ 3. å­˜å‚¨åˆ°
    â”‚                            â”‚                            â”‚    metadata
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€{ success }â”€â”€â”€â”€â”€â”‚
    â”‚ â—€â”€â”€â”€â”€â”€â”€â”€ æˆ¿é—´åˆ›å»ºæˆåŠŸ â”€â”€â”€â”€â”€â”€â”‚                            â”‚
    â”‚                            â”‚                            â”‚


åŠ å…¥æˆ¿é—´ï¼ˆæ­£ç¡®å¯†ç ï¼‰ï¼š

  ğŸ‘¤ ç”¨æˆ· B                     ğŸ–¥ï¸ å®¢æˆ·ç«¯                     â˜ï¸ æœåŠ¡ç«¯
    â”‚                            â”‚                            â”‚
    â”‚ è¾“å…¥å¯†ç  "ABC"              â”‚                            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                            â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ GET /room/123/info         â”‚
    â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚                            â”‚ è¯»å–
    â”‚                            â”‚                            â”‚ metadata
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ â—€â”€â”€{ verificationData }â”€â”€â”€â”€â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ 1. ä½¿ç”¨ ABC æ´¾ç”Ÿå¯†é’¥       â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ 2. å°è¯•è§£å¯†                â”‚
    â”‚                            â”‚    âœ… æˆåŠŸï¼               â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ 3. è¿æ¥ WebSocket          â”‚
    â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚ â—€â”€â”€â”€â”€â”€â”€â”€ æˆåŠŸåŠ å…¥æˆ¿é—´ â”€â”€â”€â”€â”€â”€â”‚                            â”‚
    â”‚                            â”‚                            â”‚


åŠ å…¥æˆ¿é—´ï¼ˆé”™è¯¯å¯†ç ï¼‰ï¼š

  ğŸ‘¤ ç”¨æˆ· C                     ğŸ–¥ï¸ å®¢æˆ·ç«¯                     â˜ï¸ æœåŠ¡ç«¯
    â”‚                            â”‚                            â”‚
    â”‚ è¾“å…¥å¯†ç  "XYZ"              â”‚                            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                            â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ GET /room/123/info         â”‚
    â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ â—€â”€â”€{ verificationData }â”€â”€â”€â”€â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ 1. ä½¿ç”¨ XYZ æ´¾ç”Ÿå¯†é’¥       â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ 2. å°è¯•è§£å¯†                â”‚
    â”‚                            â”‚    âŒ å¤±è´¥ï¼               â”‚
    â”‚                            â”‚                            â”‚
    â”‚ â—€â”€â”€â”€â”€â”€ å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯• â”€â”€â”€â”€â”‚                            â”‚
    â”‚                            â”‚                            â”‚
```

---

**å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨ç¬¬ä¸€æ¡æ™®é€šæ¶ˆæ¯éªŒè¯ï¼ˆä¸æ¨èï¼‰**
      } else {
        // æˆ¿é—´ ID ä¸åŒ¹é…ï¼ˆç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼‰
        console.error("âŒ éªŒè¯å¤±è´¥ï¼šæˆ¿é—´ ID ä¸åŒ¹é…");
        return {
          success: false,
          error: "éªŒè¯æ•°æ®å¼‚å¸¸"
        };
      }
    } else {
      // ä¸æ˜¯éªŒè¯æ¶ˆæ¯ï¼Œä½†èƒ½è§£å¯†è¯´æ˜å¯†ç æ­£ç¡®
      console.log("âœ… è§£å¯†æˆåŠŸï¼ˆééªŒè¯æ¶ˆæ¯ï¼Œä½†å¯†ç æ­£ç¡®ï¼‰");
      await keyManager.saveRoomPassword(roomId, password);
      return { success: true };
    }
    
  } catch (error) {
    // 7. è§£å¯†å¤±è´¥ = å¯†ç é”™è¯¯ï¼
    console.error("âŒ è§£å¯†å¤±è´¥:", error.message);
    
    // AES-GCM è§£å¯†å¤±è´¥ä¼šæŠ›å‡ºç±»ä¼¼ "OperationError" çš„å¼‚å¸¸
    return {
      success: false,
      error: "å¯†ç é”™è¯¯ï¼Œè¯·æ£€æŸ¥åé‡è¯•"
    };
  }
}


// ========================================
// å®Œæ•´ç¤ºä¾‹ï¼šç”¨æˆ·è§†è§’
// ========================================

// ç”¨æˆ· A åˆ›å»ºæˆ¿é—´
await createRoomWithPassword("Secret Chat", "myPassword123");

// æœåŠ¡ç«¯å­˜å‚¨çš„æ•°æ®ï¼ˆDurable Objectsï¼‰:
// {
//   "key": "2025-10-26T10:00:00.000Z",
//   "value": {
//     "message": "ENCRYPTED:{iv:[1,2,3,...], ciphertext:[4,5,6,...]}",
//     "isVerificationMessage": true,
//     "messageId": "uuid-xxx",
//     "timestamp": 1729936800000
//   }
// }
// â˜ï¸ æœåŠ¡ç«¯åªçœ‹åˆ°å¯†æ–‡ï¼Œä¸çŸ¥é“å†…å®¹


// ç”¨æˆ· B å°è¯•åŠ å…¥ï¼ˆæ­£ç¡®å¯†ç ï¼‰
const result1 = await joinRoomWithPassword("abc123", "myPassword123");
// ç»“æœï¼š
// 1. ä»æœåŠ¡ç«¯è·å–éªŒè¯æ¶ˆæ¯ï¼ˆå¯†æ–‡ï¼‰
// 2. ä½¿ç”¨ "myPassword123" æ´¾ç”Ÿå¯†é’¥
// 3. è§£å¯†æˆåŠŸï¼å¾—åˆ°ï¼š{ type: "room-verification", roomId: "abc123", ... }
// 4. éªŒè¯ roomId åŒ¹é…
// 5. è¿”å› { success: true }
// 6. ç”¨æˆ· B è¿›å…¥æˆ¿é—´ï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰è§£å¯†çš„æ¶ˆæ¯


// ç”¨æˆ· C å°è¯•åŠ å…¥ï¼ˆé”™è¯¯å¯†ç ï¼‰
const result2 = await joinRoomWithPassword("abc123", "wrongPassword");
// ç»“æœï¼š
// 1. ä»æœåŠ¡ç«¯è·å–éªŒè¯æ¶ˆæ¯ï¼ˆå¯†æ–‡ï¼‰
// 2. ä½¿ç”¨ "wrongPassword" æ´¾ç”Ÿå¯†é’¥
// 3. è§£å¯†å¤±è´¥ï¼AES-GCM æŠ›å‡ºå¼‚å¸¸
// 4. è¿”å› { success: false, error: "å¯†ç é”™è¯¯" }
// 5. æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè¦æ±‚é‡æ–°è¾“å…¥
// 6. ç”¨æˆ· C æ— æ³•è¿›å…¥æˆ¿é—´


// ========================================
// å…³é”®æŠ€æœ¯ç»†èŠ‚
// ========================================

/**
 * ä¸ºä»€ä¹ˆ AES-GCM èƒ½éªŒè¯å¯†ç ï¼Ÿ
 * 
 * AES-GCMï¼ˆGalois/Counter Modeï¼‰æ˜¯ä¸€ç§è®¤è¯åŠ å¯†ç®—æ³•ï¼š
 * 
 * 1. åŠ å¯†æ—¶ï¼š
 *    - ä½¿ç”¨å¯†é’¥ K1 åŠ å¯†æ•°æ® â†’ ç”Ÿæˆå¯†æ–‡ + è®¤è¯æ ‡ç­¾
 *    - è®¤è¯æ ‡ç­¾æ˜¯åŸºäºå¯†é’¥å’Œå¯†æ–‡è®¡ç®—çš„
 * 
 * 2. è§£å¯†æ—¶ï¼š
 *    - ä½¿ç”¨å¯†é’¥ K2 å°è¯•è§£å¯†
 *    - å¦‚æœ K2 != K1ï¼š
 *      âœ… è®¤è¯æ ‡ç­¾éªŒè¯å¤±è´¥
 *      âœ… æŠ›å‡º OperationError å¼‚å¸¸
 *      âœ… æ— æ³•è§£å¯†å‡ºä»»ä½•å†…å®¹ï¼ˆä¸æ˜¯ä¹±ç ï¼Œæ˜¯ç›´æ¥å¤±è´¥ï¼‰
 *    - å¦‚æœ K2 == K1ï¼š
 *      âœ… è®¤è¯æ ‡ç­¾éªŒè¯æˆåŠŸ
 *      âœ… è§£å¯†æˆåŠŸ
 * 
 * 3. å®‰å…¨æ€§ä¿è¯ï¼š
 *    - å³ä½¿æ”»å‡»è€…ç¯¡æ”¹å¯†æ–‡ï¼Œä¹Ÿä¼šè¢«æ£€æµ‹åˆ°
 *    - é”™è¯¯çš„å¯†é’¥æ— æ³•è§£å¯†ï¼ˆä¸æ˜¯å¾—åˆ°ä¹±ç ï¼Œæ˜¯ç›´æ¥å¤±è´¥ï¼‰
 *    - å®Œç¾é€‚åˆå¯†ç éªŒè¯åœºæ™¯
 */

// ç¤ºä¾‹ï¼šAES-GCM è§£å¯†å¤±è´¥
const wrongKey = await CryptoUtils.deriveKeyFromPassword("wrong", roomId);
try {
  const decrypted = await CryptoUtils.decryptMessage(encryptedData, wrongKey);
  // â˜ï¸ è¿™è¡Œä»£ç ä¸ä¼šæ‰§è¡Œåˆ°
} catch (error) {
  console.log(error.name);     // "OperationError"
  console.log(error.message);  // "The operation failed for an operation-specific reason"
  // â˜ï¸ æ˜ç¡®çš„è§£å¯†å¤±è´¥ï¼Œè€Œéå¾—åˆ°ä¹±ç 
}
```

**ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ¡ˆå®‰å…¨ä¸”é«˜æ•ˆï¼Ÿ**

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **æœåŠ¡ç«¯é›¶çŸ¥è¯†** | æœåŠ¡ç«¯åªå­˜å‚¨å¯†æ–‡ï¼Œä¸çŸ¥é“å†…å®¹ï¼Œä¸çŸ¥é“å¯†ç  |
| **æ— éœ€é¢å¤–å­˜å‚¨** | éªŒè¯æ¶ˆæ¯å°±æ˜¯æ™®é€šæ¶ˆæ¯ï¼Œä¸éœ€è¦ç‰¹æ®Šçš„å¯†ç è¡¨ |
| **å®¢æˆ·ç«¯éªŒè¯** | å®Œå…¨åœ¨å®¢æˆ·ç«¯é€šè¿‡è§£å¯†æµ‹è¯•éªŒè¯ï¼ŒæœåŠ¡ç«¯ä¸å‚ä¸ |
| **é˜²ç¯¡æ”¹** | AES-GCM è‡ªå¸¦å®Œæ•´æ€§éªŒè¯ï¼Œå¯†æ–‡è¢«ç¯¡æ”¹ä¼šè¢«æ£€æµ‹ |
| **é˜²é‡æ”¾** | éªŒè¯è½½è·åŒ…å«éšæœºç›å€¼å’Œæ—¶é—´æˆ³ |
| **ç®€å•æ˜äº†** | èƒ½è§£å¯† = å¯†ç æ­£ç¡®ï¼Œä¸èƒ½è§£å¯† = å¯†ç é”™è¯¯ |
| **å‘åå…¼å®¹** | å¦‚æœæ²¡æœ‰ä¸“é—¨çš„éªŒè¯æ¶ˆæ¯ï¼Œå¯ä»¥ç”¨ç¬¬ä¸€æ¡æ™®é€šæ¶ˆæ¯ |

**æ•°æ®æµå›¾è§£**ï¼š

```
åˆ›å»ºæˆ¿é—´æ—¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ· A      â”‚
â”‚ å¯†ç : ABC   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ è¾“å…¥å¯†ç 
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯                  â”‚
â”‚ 1. æ„é€ éªŒè¯è½½è·ï¼š        â”‚
â”‚    {roomId: "123"}     â”‚
â”‚ 2. ä½¿ç”¨ ABC åŠ å¯†        â”‚
â”‚ 3. å¾—åˆ°å¯†æ–‡             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ å‘é€å¯†æ–‡
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœåŠ¡ç«¯                  â”‚
â”‚ å­˜å‚¨ï¼š                  â”‚
â”‚ message: "ENCRYPTED:{}"â”‚
â”‚ ï¼ˆåªçœ‹åˆ°å¯†æ–‡ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


åŠ å…¥æˆ¿é—´æ—¶ï¼ˆæ­£ç¡®å¯†ç ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ· B      â”‚
â”‚ å¯†ç : ABC   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ è¾“å…¥å¯†ç 
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯                  â”‚
â”‚ 1. è·å–å¯†æ–‡             â”‚
â”‚ 2. ä½¿ç”¨ ABC è§£å¯†        â”‚
â”‚ 3. âœ… è§£å¯†æˆåŠŸï¼        â”‚
â”‚ 4. å¾—åˆ° {roomId:"123"} â”‚
â”‚ 5. éªŒè¯ roomId åŒ¹é…     â”‚
â”‚ 6. å…è®¸è¿›å…¥             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


åŠ å…¥æˆ¿é—´æ—¶ï¼ˆé”™è¯¯å¯†ç ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ· C      â”‚
â”‚ å¯†ç : XYZ   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ è¾“å…¥å¯†ç 
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯                  â”‚
â”‚ 1. è·å–å¯†æ–‡             â”‚
â”‚ 2. ä½¿ç”¨ XYZ è§£å¯†        â”‚
â”‚ 3. âŒ è§£å¯†å¤±è´¥ï¼        â”‚
â”‚    (AES-GCM æŠ›å‡ºå¼‚å¸¸)  â”‚
â”‚ 4. æç¤ºå¯†ç é”™è¯¯         â”‚
â”‚ 5. ä¸å…è®¸è¿›å…¥           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ€»ç»“**ï¼š
- âœ… ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼
- âœ… åˆ›å»ºæˆ¿é—´æ—¶ä¸Šä¼ ä¸€ä¸ªåŠ å¯†çš„éªŒè¯æ•°æ®ï¼ˆåŒ…å«æˆ¿é—´å·ï¼‰
- âœ… åŠ å…¥æ—¶å°è¯•è§£å¯†ï¼ŒæˆåŠŸä¸”æˆ¿é—´å·åŒ¹é… = å¯†ç æ­£ç¡®
- âœ… è§£å¯†å¤±è´¥ = å¯†ç é”™è¯¯
- âœ… æœåŠ¡ç«¯åªå­˜å¯†æ–‡ï¼Œå®Œå…¨ä¸çŸ¥é“å¯†ç å’Œå†…å®¹
- âœ… è¿™æ˜¯çœŸæ­£çš„é›¶ä¿¡ä»»ç«¯å¯¹ç«¯åŠ å¯†ï¼

---

**å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨ç¬¬ä¸€æ¡æ™®é€šæ¶ˆæ¯éªŒè¯**

å¦‚æœæˆ¿é—´æ²¡æœ‰ä¸“é—¨çš„éªŒè¯æ¶ˆæ¯ï¼Œå¯ä»¥ä½¿ç”¨ç”¨æˆ·å‘é€çš„ç¬¬ä¸€æ¡æ™®é€šæ¶ˆæ¯ï¼š

```javascript
// åœºæ™¯ï¼šç”¨æˆ·åˆ›å»ºæˆ¿é—´ä½†æ²¡æœ‰å‘é€éªŒè¯æ¶ˆæ¯
// ç”¨æˆ· A å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼š"Hello everyone!"

// ç”¨æˆ· B åŠ å…¥æ—¶ï¼š
const firstMessage = await fetchFirstMessage(roomId);
// firstMessage.message = "ENCRYPTED:{...}" (åŠ å¯†çš„ "Hello everyone!")

// å°è¯•è§£å¯†
try {
  const decrypted = await decryptMessage(firstMessage, password);
  // å¦‚æœæˆåŠŸè§£å¯†å‡º "Hello everyone!"ï¼Œè¯´æ˜å¯†ç æ­£ç¡®
  return { success: true };
} catch {
  // è§£å¯†å¤±è´¥ï¼Œå¯†ç é”™è¯¯
  return { success: false };
}
```

---

**å®é™…æ•ˆæœæ¼”ç¤º**ï¼š

```javascript
// ========================================
// å®Œæ•´æµç¨‹æ¼”ç¤º
// ========================================

console.log("=== åœºæ™¯ 1ï¼šåˆ›å»ºæˆ¿é—´ ===");

// ç”¨æˆ· A åˆ›å»ºæˆ¿é—´
const roomId = "room-abc-123";
const password = "SecretPassword123";

// å®¢æˆ·ç«¯æ„é€ éªŒè¯è½½è·
const payload = {
  type: "room-verification",
  roomId: "room-abc-123",
  timestamp: 1729936800000,
  salt: "random-uuid-here"
};
console.log("ğŸ“¦ éªŒè¯è½½è·ï¼ˆæ˜æ–‡ï¼‰:", JSON.stringify(payload));

// ä½¿ç”¨å¯†ç åŠ å¯†
const key = await deriveKeyFromPassword(password, roomId);
const encrypted = await encryptMessage(JSON.stringify(payload), key);
console.log("ğŸ”’ åŠ å¯†å:", JSON.stringify(encrypted));
// è¾“å‡ºï¼š{
//   iv: [12, 34, 56, 78, 90, 12, 34, 56, 90, 12, 34, 56],
//   ciphertext: [145, 232, 67, 89, 123, ...], // å‡ ç™¾ä¸ªæ•°å­—
//   version: "1.0"
// }

// å‘é€åˆ°æœåŠ¡ç«¯
console.log("ğŸ“¤ å‘é€åˆ°æœåŠ¡ç«¯...");
// æœåŠ¡ç«¯å­˜å‚¨ï¼š
// {
//   "message": "ENCRYPTED:{iv:[12,34,...], ciphertext:[145,232,...]}"
// }
console.log("âœ… æœåŠ¡ç«¯å·²å­˜å‚¨å¯†æ–‡ï¼ˆæœåŠ¡ç«¯çœ‹ä¸æ‡‚å†…å®¹ï¼‰");


console.log("\n=== åœºæ™¯ 2ï¼šç”¨æˆ· B åŠ å…¥ï¼ˆæ­£ç¡®å¯†ç ï¼‰===");

// ç”¨æˆ· B è¾“å…¥å¯†ç ï¼š"SecretPassword123"
const userBPassword = "SecretPassword123";

// ä»æœåŠ¡ç«¯è·å–éªŒè¯æ¶ˆæ¯
const storedMessage = {
  message: "ENCRYPTED:{iv:[12,34,...], ciphertext:[145,232,...]}"
};
console.log("ğŸ“¥ ä»æœåŠ¡ç«¯è·å–éªŒè¯æ¶ˆæ¯ï¼ˆå¯†æ–‡ï¼‰");

// å°è¯•è§£å¯†
try {
  const userBKey = await deriveKeyFromPassword(userBPassword, roomId);
  const decrypted = await decryptMessage(storedMessage, userBKey);
  console.log("ğŸ”“ è§£å¯†æˆåŠŸï¼");
  console.log("ğŸ“„ è§£å¯†å†…å®¹:", decrypted);
  // è¾“å‡ºï¼š'{"type":"room-verification","roomId":"room-abc-123",...}'
  
  const verifiedPayload = JSON.parse(decrypted);
  if (verifiedPayload.roomId === roomId) {
    console.log("âœ… éªŒè¯é€šè¿‡ï¼šæˆ¿é—´ ID åŒ¹é…ï¼");
    console.log("âœ… ç”¨æˆ· B æˆåŠŸåŠ å…¥æˆ¿é—´");
  }
} catch (error) {
  console.log("âŒ ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ");
}


console.log("\n=== åœºæ™¯ 3ï¼šç”¨æˆ· C åŠ å…¥ï¼ˆé”™è¯¯å¯†ç ï¼‰===");

// ç”¨æˆ· C è¾“å…¥é”™è¯¯å¯†ç ï¼š"WrongPassword"
const userCPassword = "WrongPassword";

// ä»æœåŠ¡ç«¯è·å–ç›¸åŒçš„éªŒè¯æ¶ˆæ¯
console.log("ğŸ“¥ ä»æœåŠ¡ç«¯è·å–éªŒè¯æ¶ˆæ¯ï¼ˆå¯†æ–‡ï¼‰");

// å°è¯•è§£å¯†
try {
  const userCKey = await deriveKeyFromPassword(userCPassword, roomId);
  console.log("ğŸ”‘ ä½¿ç”¨é”™è¯¯å¯†ç æ´¾ç”Ÿçš„å¯†é’¥å°è¯•è§£å¯†...");
  
  const decrypted = await decryptMessage(storedMessage, userCKey);
  console.log("âŒ ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼è§£å¯†ä¼šæŠ›å‡ºå¼‚å¸¸");
} catch (error) {
  console.log("âŒ è§£å¯†å¤±è´¥ï¼");
  console.log("âŒ é”™è¯¯ç±»å‹:", error.name);        // "OperationError"
  console.log("âŒ é”™è¯¯ä¿¡æ¯:", error.message);     // "The operation failed..."
  console.log("âŒ æç¤ºç”¨æˆ·ï¼šå¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•");
  console.log("âŒ ç”¨æˆ· C æ— æ³•åŠ å…¥æˆ¿é—´");
}


// ========================================
// å…³é”®ç‚¹æ€»ç»“
// ========================================

console.log("\n=== å…³é”®ç‚¹ ===");
console.log("1ï¸âƒ£ æœåŠ¡ç«¯å­˜å‚¨ï¼š");
console.log("   - åªå­˜å‚¨å¯†æ–‡");
console.log("   - ä¸çŸ¥é“éªŒè¯è½½è·çš„å†…å®¹");
console.log("   - ä¸çŸ¥é“æˆ¿é—´å¯†ç ");
console.log("   - æ— æ³•éªŒè¯å¯†ç æ˜¯å¦æ­£ç¡®");

console.log("\n2ï¸âƒ£ å¯†ç æ­£ç¡®æ—¶ï¼š");
console.log("   - èƒ½æˆåŠŸè§£å¯†éªŒè¯æ¶ˆæ¯");
console.log("   - å¾—åˆ°åŒ…å«æˆ¿é—´ ID çš„è½½è·");
console.log("   - éªŒè¯æˆ¿é—´ ID åŒ¹é…");
console.log("   - å…è®¸ç”¨æˆ·è¿›å…¥");

console.log("\n3ï¸âƒ£ å¯†ç é”™è¯¯æ—¶ï¼š");
console.log("   - AES-GCM è§£å¯†ç›´æ¥å¤±è´¥");
console.log("   - æŠ›å‡º OperationError å¼‚å¸¸");
console.log("   - ä¸æ˜¯å¾—åˆ°ä¹±ç ï¼Œè€Œæ˜¯å®Œå…¨è§£å¯†å¤±è´¥");
console.log("   - å®¢æˆ·ç«¯æ•è·å¼‚å¸¸ï¼Œæç¤ºå¯†ç é”™è¯¯");

console.log("\n4ï¸âƒ£ å®‰å…¨æ€§ä¿è¯ï¼š");
console.log("   - æœåŠ¡ç«¯è¢«æ”»ç ´ï¼šåªèƒ½æ‹¿åˆ°å¯†æ–‡");
console.log("   - æš´åŠ›ç ´è§£ï¼šå®¢æˆ·ç«¯å¯ä»¥æ·»åŠ å°è¯•æ¬¡æ•°é™åˆ¶");
console.log("   - ä¸­é—´äººæ”»å‡»ï¼šHTTPS + å¯†æ–‡æ— æ³•ç¯¡æ”¹");
console.log("   - é‡æ”¾æ”»å‡»ï¼šéªŒè¯è½½è·åŒ…å«éšæœºç›å€¼");
```

**ç”¨æˆ·ä½“éªŒå¯¹æ¯”**ï¼š

```
ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆæœåŠ¡ç«¯éªŒè¯ï¼‰ï¼š
ç”¨æˆ·è¾“å…¥å¯†ç 
   â†“
å‘é€å¯†ç åˆ°æœåŠ¡å™¨
   â†“
æœåŠ¡å™¨æŸ¥è¯¢å¯†ç è¡¨
   â†“
æœåŠ¡å™¨è¿”å›"æ­£ç¡®"æˆ–"é”™è¯¯"
   â†“
ç”¨æˆ·è¿›å…¥æˆ–è¢«æ‹’ç»

âŒ é—®é¢˜ï¼šæœåŠ¡å™¨çŸ¥é“å¯†ç 
âŒ é—®é¢˜ï¼šæœåŠ¡å™¨å¯ä»¥é˜»æ­¢è®¿é—®
âŒ é—®é¢˜ï¼šæœåŠ¡å™¨è¢«æ”»ç ´ = å¯†ç æ³„éœ²


E2EE æ–¹æ¡ˆï¼ˆå®¢æˆ·ç«¯éªŒè¯ï¼‰ï¼š
ç”¨æˆ·è¾“å…¥å¯†ç 
   â†“
å®¢æˆ·ç«¯ä»å¯†ç æ´¾ç”Ÿå¯†é’¥
   â†“
å®¢æˆ·ç«¯å°è¯•è§£å¯†éªŒè¯æ¶ˆæ¯
   â†“
è§£å¯†æˆåŠŸ/å¤±è´¥
   â†“
ç”¨æˆ·è¿›å…¥æˆ–è¢«æ‹’ç»

âœ… ä¼˜åŠ¿ï¼šæœåŠ¡å™¨ä¸çŸ¥é“å¯†ç 
âœ… ä¼˜åŠ¿ï¼šæœåŠ¡å™¨æ— æ³•é˜»æ­¢ï¼ˆçœŸæ­£çš„å»ä¸­å¿ƒåŒ–ï¼‰
âœ… ä¼˜åŠ¿ï¼šæœåŠ¡å™¨è¢«æ”»ç ´ = åªæ³„éœ²å¯†æ–‡ï¼ˆå®‰å…¨ï¼‰
```

**ä»£ç å¯¹æ¯”**ï¼š

```javascript
// ========================================
// ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆä¸æ¨èï¼‰
// ========================================

// å®¢æˆ·ç«¯
const response = await fetch('/api/room/verify', {
  method: 'POST',
  body: JSON.stringify({
    roomId: 'abc123',
    password: 'myPassword'  // âŒ å¯†ç å‘é€åˆ°æœåŠ¡å™¨
  })
});

const result = await response.json();
if (result.success) {
  // æœåŠ¡å™¨è¯´å¯†ç æ­£ç¡®
} else {
  // æœåŠ¡å™¨è¯´å¯†ç é”™è¯¯
}

// æœåŠ¡ç«¯ï¼ˆéœ€è¦å­˜å‚¨å¯†ç å“ˆå¸Œï¼‰
app.post('/api/room/verify', async (req, res) => {
  const { roomId, password } = req.body;
  
  // âŒ æœåŠ¡å™¨çŸ¥é“ç”¨æˆ·è¾“å…¥çš„å¯†ç 
  const storedHash = await db.getPasswordHash(roomId);
  const inputHash = await hashPassword(password);
  
  if (storedHash === inputHash) {
    res.json({ success: true });
  } else {
    res.json({ success: false });
  }
});


// ========================================
// E2EE æ–¹æ¡ˆï¼ˆæ¨èï¼‰
// ========================================

// å®¢æˆ·ç«¯ï¼ˆå®Œæ•´é€»è¾‘ï¼‰
async function verifyPassword(roomId, password) {
  // 1. è·å–éªŒè¯æ¶ˆæ¯ï¼ˆå¯†æ–‡ï¼‰
  const verificationMessage = await fetchVerificationMessage(roomId);
  
  // 2. å°è¯•è§£å¯†
  try {
    const key = await deriveKeyFromPassword(password, roomId);
    const decrypted = await decryptMessage(verificationMessage, key);
    const payload = JSON.parse(decrypted);
    
    // 3. éªŒè¯å†…å®¹
    if (payload.roomId === roomId) {
      return { success: true };  // âœ… å¯†ç æ­£ç¡®
    }
  } catch (error) {
    return { success: false };  // âŒ å¯†ç é”™è¯¯
  }
}

// æœåŠ¡ç«¯ï¼ˆåªå­˜å‚¨å¯†æ–‡ï¼Œä¸å‚ä¸éªŒè¯ï¼‰
app.get('/api/room/:roomId/messages', async (req, res) => {
  const messages = await db.getMessages(req.params.roomId);
  // âœ… ç›´æ¥è¿”å›å¯†æ–‡ï¼Œä¸çŸ¥é“å†…å®¹ï¼Œä¸éªŒè¯å¯†ç 
  res.json(messages);
});
```

**å®‰å…¨æ€§åˆ†æ**ï¼š

| æ”»å‡»åœºæ™¯ | ä¼ ç»Ÿæ–¹æ¡ˆ | E2EE æ–¹æ¡ˆ |
|---------|---------|----------|
| **æœåŠ¡å™¨è¢«æ”»ç ´** | âŒ å¯†ç å“ˆå¸Œæ³„éœ² | âœ… åªæœ‰å¯†æ–‡ï¼Œå®‰å…¨ |
| **æ•°æ®åº“æ³„éœ²** | âŒ å¯èƒ½è¢«æš´åŠ›ç ´è§£ | âœ… æ— å¯†ç ä¿¡æ¯ï¼Œå®‰å…¨ |
| **ä¸­é—´äººæ”»å‡»** | âš ï¸ HTTPS ä¿æŠ¤ | âœ… HTTPS + å¯†æ–‡åŒé‡ä¿æŠ¤ |
| **æœåŠ¡å™¨ç®¡ç†å‘˜** | âŒ å¯ä»¥çœ‹åˆ°éªŒè¯è¯·æ±‚ | âœ… çœ‹ä¸åˆ°å¯†ç ï¼Œåªçœ‹åˆ°å¯†æ–‡ |
| **æ—¥å¿—æ³„éœ²** | âŒ å¯†ç å¯èƒ½è¢«è®°å½• | âœ… å¯†ç ä»ä¸å‘é€ï¼Œå®‰å…¨ |
| **æš´åŠ›ç ´è§£** | âš ï¸ æœåŠ¡ç«¯é™åˆ¶ | âœ… å®¢æˆ·ç«¯é™åˆ¶ + é«˜æˆæœ¬ |

**ä¸ºä»€ä¹ˆ AES-GCM è¿™ä¹ˆé‡è¦ï¼Ÿ**

```javascript
// AES-GCM çš„ç‰¹æ€§ï¼šè®¤è¯åŠ å¯†

// åŠ å¯†æ—¶ï¼š
const encrypted = await crypto.subtle.encrypt(
  { name: "AES-GCM", iv },
  key,
  plaintext
);
// â˜ï¸ ç”Ÿæˆï¼šå¯†æ–‡ + è®¤è¯æ ‡ç­¾ï¼ˆAuthentication Tagï¼‰
//         è®¤è¯æ ‡ç­¾æ˜¯åŸºäºå¯†é’¥å’Œå¯†æ–‡è®¡ç®—çš„

// è§£å¯†æ—¶ï¼š
try {
  const decrypted = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv },
    key,        // å¦‚æœè¿™ä¸ªå¯†é’¥ä¸å¯¹
    ciphertext
  );
  // â˜ï¸ è¿™è¡Œä¸ä¼šæ‰§è¡Œåˆ°
} catch (error) {
  // â˜ï¸ ä¼šæŠ›å‡ºå¼‚å¸¸ï¼
  // åŸå› ï¼šè®¤è¯æ ‡ç­¾éªŒè¯å¤±è´¥
  // ç»“æœï¼šå®Œå…¨æ— æ³•è§£å¯†ï¼ˆä¸æ˜¯å¾—åˆ°ä¹±ç ï¼‰
}

// å¯¹æ¯”å…¶ä»–æ¨¡å¼ï¼ˆå¦‚ AES-CBCï¼‰ï¼š
// AES-CBC è§£å¯†å¤±è´¥ä¼šå¾—åˆ°ä¹±ç 
// æ— æ³•æ˜ç¡®åˆ¤æ–­å¯†é’¥æ˜¯å¦æ­£ç¡®
// éœ€è¦é¢å¤–çš„å®Œæ•´æ€§æ£€æŸ¥

// AES-GCM çš„ä¼˜åŠ¿ï¼š
// âœ… è§£å¯†æˆåŠŸ = å¯†é’¥æ­£ç¡® + æ•°æ®å®Œæ•´
// âœ… è§£å¯†å¤±è´¥ = å¯†é’¥é”™è¯¯ æˆ– æ•°æ®è¢«ç¯¡æ”¹
// âœ… å®Œç¾é€‚åˆå¯†ç éªŒè¯åœºæ™¯
```

**æ–¹æ¡ˆ 2ï¼šæœåŠ¡å™¨å­˜å‚¨å¯†ç å“ˆå¸Œï¼ˆå¯é€‰ï¼Œé™ä½å®‰å…¨æ€§ï¼‰**

```javascript
// âš ï¸ ä¸æ¨èï¼šè¿™ä¼šè®©æœåŠ¡å™¨çŸ¥é“å¯†ç çš„å“ˆå¸Œå€¼

// åˆ›å»ºæˆ¿é—´æ—¶
const passwordHash = await crypto.subtle.digest(
  'SHA-256',
  new TextEncoder().encode(password + roomId)
);

// å‘é€å“ˆå¸Œåˆ°æœåŠ¡å™¨
await fetch('/api/room/create', {
  method: 'POST',
  body: JSON.stringify({
    roomId,
    passwordHash: btoa(String.fromCharCode(...new Uint8Array(passwordHash)))
  })
});

// åŠ å…¥æˆ¿é—´æ—¶éªŒè¯
const inputHash = await crypto.subtle.digest(
  'SHA-256',
  new TextEncoder().encode(inputPassword + roomId)
);

const response = await fetch(`/api/room/${roomId}/verify`, {
  method: 'POST',
  body: JSON.stringify({
    passwordHash: btoa(String.fromCharCode(...new Uint8Array(inputHash)))
  })
});

// âŒ é—®é¢˜ï¼šæœåŠ¡å™¨çŸ¥é“äº†å¯†ç å“ˆå¸Œï¼Œé™ä½äº†å®‰å…¨æ€§
// âŒ é—®é¢˜ï¼šæœåŠ¡å™¨å¯ä»¥é˜»æ­¢ç”¨æˆ·è®¿é—®ï¼ˆä¸­å¿ƒåŒ–æ§åˆ¶ï¼‰
```

**æ¨èï¼šä½¿ç”¨æ–¹æ¡ˆ 1ï¼ˆå®¢æˆ·ç«¯éªŒè¯ï¼‰**

---

**é”™è¯¯å¯†ç ç”¨æˆ·çœ‹åˆ°ä»€ä¹ˆï¼Ÿ**

**åœºæ™¯ 1ï¼šè¾“å…¥å¯†ç æ—¶éªŒè¯å¤±è´¥**

```
ç”¨æˆ·è¾“å…¥é”™è¯¯å¯†ç  "wrongPass"
   â†“
å®¢æˆ·ç«¯å°è¯•è§£å¯†éªŒè¯æ¶ˆæ¯
   â†“
è§£å¯†å¤±è´¥ï¼ˆAES-GCM æŠ›å‡ºå¼‚å¸¸ï¼‰
   â†“
æ˜¾ç¤ºé”™è¯¯æç¤ºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ Incorrect Password             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚
â”‚  The password you entered is       â”‚
â”‚  incorrect. Please try again.      â”‚
â”‚                                    â”‚
â”‚  Password:                         â”‚
â”‚  [____________________]            â”‚
â”‚                                    â”‚
â”‚  [Try Again] [Cancel]              â”‚
â”‚                                    â”‚
â”‚  ğŸ’¡ Make sure you have the         â”‚
â”‚     correct password               â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… ç”¨æˆ·è¢«é˜»æ­¢è¿›å…¥æˆ¿é—´ï¼Œå¿…é¡»è¾“å…¥æ­£ç¡®å¯†ç 
```

**åœºæ™¯ 2ï¼šå¦‚æœç”¨æˆ·ç»•è¿‡éªŒè¯å¼ºè¡Œè¿›å…¥ï¼ˆç†è®ºä¸Šï¼‰**

```javascript
// å‡è®¾ç”¨æˆ·é€šè¿‡æŸç§æ–¹å¼ç»•è¿‡äº†å¯†ç éªŒè¯
// ï¼ˆå®é™…ä¸Šå¾ˆéš¾ï¼Œå› ä¸ºéªŒè¯åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ï¼‰

// ç”¨æˆ·çœ‹åˆ°çš„ç•Œé¢ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Room: Secret Chat                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  ğŸ”’ [10:30] Alice: [ğŸ” Unable to decrypt]  â”‚
â”‚  ğŸ”’ [10:31] Bob: [ğŸ” Unable to decrypt]    â”‚
â”‚  ğŸ”’ [10:32] Carol: [ğŸ” Unable to decrypt]  â”‚
â”‚                                            â”‚
â”‚  ğŸ’¬ [Type a message...]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// æ‰€æœ‰å†å²æ¶ˆæ¯æ˜¾ç¤ºä¸º "[ğŸ” Unable to decrypt]"
// å› ä¸ºæ²¡æœ‰æ­£ç¡®çš„å¯†é’¥æ— æ³•è§£å¯†

// å¦‚æœä»–ä»¬å°è¯•å‘é€æ¶ˆæ¯ï¼š
// - å¦‚æœæ²¡æœ‰å¯†é’¥ï¼šæ˜¾ç¤ºé”™è¯¯ï¼Œæ— æ³•å‘é€
// - å¦‚æœç”¨é”™è¯¯å¯†é’¥åŠ å¯†ï¼šå…¶ä»–äººä¹Ÿæ— æ³•è§£å¯†
```

**åœºæ™¯ 3ï¼šç”¨æˆ·æ›´æ¢è®¾å¤‡ï¼Œå¿˜è®°å¯†ç **

```
ç”¨æˆ·åœ¨æ–°è®¾å¤‡ä¸Šæ‰“å¼€æˆ¿é—´
   â†“
æµè§ˆå™¨æ²¡æœ‰ä¿å­˜çš„å¯†ç 
   â†“
æç¤ºè¾“å…¥å¯†ç 
   â†“
ç”¨æˆ·è¾“å…¥é”™è¯¯å¯†ç 
   â†“
éªŒè¯å¤±è´¥ï¼Œæ— æ³•è¿›å…¥
   â†“
æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ Password Required              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚
â”‚  This room is encrypted.           â”‚
â”‚  You need the password to access   â”‚
â”‚  the messages.                     â”‚
â”‚                                    â”‚
â”‚  ğŸ’¡ Options:                       â”‚
â”‚  â€¢ Ask the room creator            â”‚
â”‚  â€¢ Check other devices             â”‚
â”‚  â€¢ Import password from backup     â”‚
â”‚                                    â”‚
â”‚  [Enter Password] [Import Backup]  â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ¶ˆæ¯åŠ å¯†ä¸è§£å¯†

#### 3.2.1 æ¶ˆæ¯åŠ å¯†æµç¨‹

```javascript
// å®¢æˆ·ç«¯åŠ å¯†æ¶ˆæ¯
async function encryptMessage(plaintext, roomKey) {
  // 1. ç”Ÿæˆéšæœº IV (åˆå§‹åŒ–å‘é‡)
  const iv = crypto.getRandomValues(new Uint8Array(12));
  
  // 2. åŠ å¯†æ¶ˆæ¯
  const encodedText = new TextEncoder().encode(plaintext);
  const ciphertext = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv: iv },
    roomKey,
    encodedText
  );
  
  // 3. ç»„åˆ IV å’Œå¯†æ–‡
  const encryptedData = {
    iv: Array.from(iv),
    ciphertext: Array.from(new Uint8Array(ciphertext)),
    version: "1.0"  // ç‰ˆæœ¬æ§åˆ¶
  };
  
  return JSON.stringify(encryptedData);
}
```

#### 3.2.2 æ¶ˆæ¯è§£å¯†æµç¨‹

```javascript
// å®¢æˆ·ç«¯è§£å¯†æ¶ˆæ¯
async function decryptMessage(encryptedMessage, roomKey) {
  try {
    // 1. è§£æåŠ å¯†æ•°æ®
    const data = JSON.parse(encryptedMessage);
    const iv = new Uint8Array(data.iv);
    const ciphertext = new Uint8Array(data.ciphertext);
    
    // 2. è§£å¯†
    const decrypted = await crypto.subtle.decrypt(
      { name: "AES-GCM", iv: iv },
      roomKey,
      ciphertext
    );
    
    // 3. è½¬æ¢ä¸ºæ–‡æœ¬
    const plaintext = new TextDecoder().decode(decrypted);
    return plaintext;
  } catch (error) {
    console.error("è§£å¯†å¤±è´¥:", error);
    return "[æ— æ³•è§£å¯†çš„æ¶ˆæ¯]";
  }
}
```

#### 3.2.3 æ•°æ®æ ¼å¼

**å‘é€åˆ°æœåŠ¡å™¨çš„æ¶ˆæ¯æ ¼å¼**:
```json
{
  "name": "ç”¨æˆ·å (æ˜æ–‡)",
  "message": "ENCRYPTED:{iv:[...], ciphertext:[...], version:'1.0'}",
  "messageId": "uuid",
  "timestamp": 1234567890,
  "encryptionType": "e2ee-aes256-gcm"
}
```

### 3.3 æ–‡ä»¶å’Œå›¾ç‰‡åŠ å¯†

#### 3.3.1 æ–‡ä»¶ä¸Šä¼ åŠ å¯†æµç¨‹

```javascript
async function encryptAndUploadFile(file, roomKey) {
  // 1. è¯»å–æ–‡ä»¶å†…å®¹
  const arrayBuffer = await file.arrayBuffer();
  
  // 2. ç”Ÿæˆéšæœº IV
  const iv = crypto.getRandomValues(new Uint8Array(12));
  
  // 3. åŠ å¯†æ–‡ä»¶å†…å®¹
  const encryptedContent = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv: iv },
    roomKey,
    arrayBuffer
  );
  
  // 4. åˆ›å»ºå…ƒæ•°æ®
  const metadata = {
    iv: Array.from(iv),
    originalName: file.name,
    originalType: file.type,
    originalSize: file.size,
    encrypted: true
  };
  
  // 5. ç»„åˆåŠ å¯†æ•°æ®å’Œå…ƒæ•°æ®
  const encryptedBlob = new Blob([
    JSON.stringify(metadata),
    new Uint8Array([0x00]), // åˆ†éš”ç¬¦
    encryptedContent
  ]);
  
  // 6. ä¸Šä¼ åˆ°æœåŠ¡å™¨
  const formData = new FormData();
  formData.append('file', encryptedBlob, `encrypted_${file.name}.enc`);
  
  const response = await fetch('/api/room/{roomId}/upload', {
    method: 'POST',
    body: formData
  });
  
  const result = await response.json();
  return result.fileUrl;
}
```

#### 3.3.2 æ–‡ä»¶ä¸‹è½½è§£å¯†æµç¨‹

```javascript
async function downloadAndDecryptFile(fileUrl, roomKey) {
  // 1. ä¸‹è½½åŠ å¯†æ–‡ä»¶
  const response = await fetch(fileUrl);
  const encryptedBlob = await response.blob();
  const arrayBuffer = await encryptedBlob.arrayBuffer();
  
  // 2. è§£æå…ƒæ•°æ®å’Œå¯†æ–‡
  const data = new Uint8Array(arrayBuffer);
  let separatorIndex = 0;
  for (let i = 0; i < data.length; i++) {
    if (data[i] === 0x00) {
      separatorIndex = i;
      break;
    }
  }
  
  const metadataBytes = data.slice(0, separatorIndex);
  const metadata = JSON.parse(new TextDecoder().decode(metadataBytes));
  const ciphertext = data.slice(separatorIndex + 1);
  
  // 3. è§£å¯†æ–‡ä»¶
  const iv = new Uint8Array(metadata.iv);
  const decryptedContent = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv: iv },
    roomKey,
    ciphertext
  );
  
  // 4. åˆ›å»ºå¯ä¸‹è½½çš„ Blob
  const decryptedBlob = new Blob([decryptedContent], { 
    type: metadata.originalType 
  });
  
  return {
    blob: decryptedBlob,
    fileName: metadata.originalName,
    fileType: metadata.originalType
  };
}
```

#### 3.3.3 å›¾ç‰‡åŠ å¯†æ˜¾ç¤º

**æµç¨‹**:
1. ä¸Šä¼ æ—¶ï¼šåŠ å¯†å›¾ç‰‡ â†’ å­˜å‚¨åˆ° R2
2. æ˜¾ç¤ºæ—¶ï¼š
   - ä¸‹è½½åŠ å¯†å›¾ç‰‡æ•°æ®
   - å®¢æˆ·ç«¯è§£å¯†
   - åˆ›å»º Object URL
   - æ˜¾ç¤ºåœ¨ `<img>` æ ‡ç­¾ä¸­

```javascript
async function displayEncryptedImage(encryptedImageUrl, roomKey) {
  // 1. ä¸‹è½½å¹¶è§£å¯†
  const { blob } = await downloadAndDecryptFile(encryptedImageUrl, roomKey);
  
  // 2. åˆ›å»ºä¸´æ—¶ URL
  const objectUrl = URL.createObjectURL(blob);
  
  // 3. æ›´æ–°å›¾ç‰‡å…ƒç´ 
  const img = document.querySelector(`img[data-encrypted-src="${encryptedImageUrl}"]`);
  img.src = objectUrl;
  
  // 4. æ¸…ç†ï¼šå½“å›¾ç‰‡ä¸å†éœ€è¦æ—¶é‡Šæ”¾ URL
  img.onload = () => {
    URL.revokeObjectURL(objectUrl);
  };
}
```

### 3.4 å¯†é’¥åˆ†äº«ä¸æˆ¿é—´è®¿é—®

#### 3.4.1 æˆ¿é—´å¯†ç åˆ†äº«ï¼ˆæ¨èæ–¹æ¡ˆï¼‰

**æ–¹æ¡ˆ A: å£å¤´/æ–‡å­—åˆ†äº«ï¼ˆæœ€ç®€å•ï¼‰**
```
"Hey, join my chat room!"
Room: abc123
Password: mySecretChat
```

ç”¨æˆ·ç‰¹ç‚¹ï¼š
- âœ… æå…¶ç®€å•ï¼Œåƒåˆ†äº« WiFi å¯†ç ä¸€æ ·
- âœ… å¯ä»¥é€šè¿‡ä»»ä½•æ–¹å¼åˆ†äº«ï¼ˆçŸ­ä¿¡ã€ç”µè¯ã€é‚®ä»¶ï¼‰
- âœ… æ˜“äºè®°å¿†å’Œä¼ è¾¾
- âš ï¸ å¯†ç å¯èƒ½è¢«ç¬¬ä¸‰æ–¹çœ‹åˆ°

**æ–¹æ¡ˆ B: URL å‚æ•°ä¼ é€’ï¼ˆæ¨èï¼‰**
```
https://chat.example.com/#room=abc123&pwd=mySecretChat
```

ç”¨æˆ·ç‰¹ç‚¹ï¼š
- âœ… ç‚¹å‡»å³å¯åŠ å…¥ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥
- âœ… é€‚åˆé€šè¿‡å®‰å…¨æ¸ é“åˆ†äº«ï¼ˆç«¯å¯¹ç«¯åŠ å¯†çš„èŠå¤©å·¥å…·ï¼‰
- âš ï¸ URL å¯èƒ½è¢«æµè§ˆå™¨å†å²è®°å½•

**æ–¹æ¡ˆ C: QR ç åˆ†äº«ï¼ˆçº¿ä¸‹åœºæ™¯ï¼‰**
```javascript
// ç”ŸæˆåŒ…å«æˆ¿é—´å¯†ç çš„ QR ç 
function generateRoomQRCode(roomId, password) {
  const shareUrl = `${baseUrl}/#room=${roomId}&pwd=${encodeURIComponent(password)}`;
  
  // ä½¿ç”¨ QR ç åº“ç”Ÿæˆ
  return generateQRCode(shareUrl);
}
```

ç•Œé¢ç¤ºä¾‹ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¤ Share This Room                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚
â”‚  Room: abc123                      â”‚
â”‚  Password: mySecretChat            â”‚
â”‚                                    â”‚
â”‚  Share Options:                    â”‚
â”‚  â€¢ [Copy Link]                     â”‚
â”‚  â€¢ [Show QR Code]                  â”‚
â”‚  â€¢ [Copy Room Info]                â”‚
â”‚                                    â”‚
â”‚  ğŸ”— https://chat.../abc123         â”‚
â”‚                                    â”‚
â”‚  âš ï¸  Keep password safe!           â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.4.2 é«˜çº§æ–¹æ¡ˆï¼šæ— å¯†ç çš„å¯†é’¥äº¤æ¢

é€‚ç”¨äºä¸æƒ³é¢„å…±äº«å¯†ç çš„åœºæ™¯ï¼š

**åœ¨çº¿ç”¨æˆ·ä¸­ç»§æ–¹æ¡ˆ**:
1. æ–°ç”¨æˆ·ç”Ÿæˆä¸´æ—¶ RSA å…¬é’¥
2. å‘é€å…¬é’¥åˆ°æœåŠ¡å™¨
3. æœåŠ¡å™¨å¹¿æ’­æ–°ç”¨æˆ·åŠ å…¥ + å…¬é’¥
4. ä»»ä¸€åœ¨çº¿ç”¨æˆ·ç”¨æ–°ç”¨æˆ·å…¬é’¥åŠ å¯†æˆ¿é—´å¯†é’¥
5. æœåŠ¡å™¨è½¬å‘ç»™æ–°ç”¨æˆ·
6. æ–°ç”¨æˆ·è§£å¯†è·å¾—æˆ¿é—´å¯†é’¥

**é‚€è¯·ç æ–¹æ¡ˆ**:
1. æˆ¿é—´åˆ›å»ºè€…ç”Ÿæˆä¸€æ¬¡æ€§é‚€è¯·ç 
2. é‚€è¯·ç åŒ…å«åŠ å¯†çš„æˆ¿é—´å¯†é’¥
3. æ–°ç”¨æˆ·ä½¿ç”¨é‚€è¯·ç åŠ å…¥
4. ç³»ç»Ÿè§£å¯†é‚€è¯·ç è·å¾—æˆ¿é—´å¯†é’¥
5. é‚€è¯·ç ä½¿ç”¨åå¤±æ•ˆï¼ˆå¯é€‰ï¼‰

#### 3.4.2 å¯†é’¥è½®æ¢

**è§¦å‘æ¡ä»¶**:
- ç”¨æˆ·ä¸»åŠ¨è½®æ¢
- æ£€æµ‹åˆ°æ½œåœ¨å®‰å…¨å¨èƒ
- å®šæœŸè½®æ¢ï¼ˆå¯é€‰ï¼Œå¦‚æ¯ 30 å¤©ï¼‰

**æµç¨‹**:
1. å½“å‰ç”¨æˆ·ç”Ÿæˆæ–°çš„æˆ¿é—´å¯†é’¥
2. ä½¿ç”¨æ—§å¯†é’¥åŠ å¯†æ–°å¯†é’¥ï¼ˆè¿‡æ¸¡æœŸï¼‰
3. å¹¿æ’­å¯†é’¥è½®æ¢é€šçŸ¥
4. æ‰€æœ‰å®¢æˆ·ç«¯æ›´æ–°æœ¬åœ°å­˜å‚¨çš„å¯†é’¥
5. åç»­æ¶ˆæ¯ä½¿ç”¨æ–°å¯†é’¥

### 3.5 å†å²æ¶ˆæ¯åŠ å¯†

#### 3.5.1 å­˜å‚¨æ ¼å¼

æœåŠ¡å™¨å­˜å‚¨çš„æ¶ˆæ¯æ ¼å¼ï¼š
```json
{
  "key": "2025-10-26T10:30:00.000Z",
  "value": {
    "name": "Alice",
    "message": "ENCRYPTED:{iv:[...], ciphertext:[...]}",
    "messageId": "uuid",
    "timestamp": 1234567890,
    "encryptionType": "e2ee-aes256-gcm"
  }
}
```

#### 3.5.2 å†å²æ¶ˆæ¯åŠ è½½ä¸è§£å¯†

```javascript
async function loadAndDecryptHistory(roomKey) {
  // 1. ä»æœåŠ¡å™¨è·å–åŠ å¯†å†å²
  const response = await fetch(`/api/room/${roomId}/websocket`);
  // WebSocket è¿æ¥åä¼šæ”¶åˆ°å†å²æ¶ˆæ¯
  
  // 2. é€æ¡è§£å¯†
  socket.on('message', async (data) => {
    if (data.message && data.message.startsWith('ENCRYPTED:')) {
      const encryptedContent = data.message.substring(10);
      const plaintext = await decryptMessage(encryptedContent, roomKey);
      
      // 3. æ˜¾ç¤ºè§£å¯†åçš„æ¶ˆæ¯
      displayMessage({
        ...data,
        message: plaintext,
        decrypted: true
      });
    }
  });
}
```

### 3.6 çº¿ç¨‹å›å¤åŠ å¯†

**åŸåˆ™**: çº¿ç¨‹å›å¤ä½¿ç”¨ä¸ä¸»æ¶ˆæ¯ç›¸åŒçš„æˆ¿é—´å¯†é’¥åŠ å¯†

**æ•°æ®ç»“æ„**:
```json
{
  "messageId": "reply-uuid",
  "message": "ENCRYPTED:{...}",
  "replyTo": {
    "messageId": "parent-uuid",
    "username": "Alice",
    "preview": "ENCRYPTED:{...}"  // å›å¤å¼•ç”¨ä¹Ÿéœ€åŠ å¯†
  }
}
```

---

## 4. UI/UX è®¾è®¡

### 4.1 åŠ å¯†çŠ¶æ€æŒ‡ç¤º

#### 4.1.1 æˆ¿é—´çº§åˆ«æŒ‡ç¤º

åœ¨æˆ¿é—´ä¿¡æ¯åŒºæ˜¾ç¤ºåŠ å¯†çŠ¶æ€ï¼š
```
ğŸ  Room Info
ğŸ”’ End-to-End Encrypted
âœ… All messages are encrypted
```

#### 4.1.2 æ¶ˆæ¯çº§åˆ«æŒ‡ç¤º

æ¯æ¡æ¶ˆæ¯æ˜¾ç¤ºå°é”å›¾æ ‡ï¼š
```
ğŸ”’ [10:30:00] Alice: Hello, this is encrypted!
```

**çŠ¶æ€å›¾æ ‡**:
- ğŸ”’ å·²åŠ å¯†å¹¶éªŒè¯
- âš ï¸ æ— æ³•è§£å¯†ï¼ˆç¼ºå°‘å¯†é’¥ï¼‰
- ğŸ”“ æœªåŠ å¯†ï¼ˆæ˜æ–‡æ¶ˆæ¯ï¼‰

### 4.2 å¯†é’¥ç®¡ç†ç•Œé¢

#### 4.2.1 åˆ›å»ºæˆ¿é—´æ—¶çš„åŠ å¯†è®¾ç½®

**ç®€åŒ–ç•Œé¢ï¼ˆæ¨èï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create a New Room                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  Room Name: [My Chat Room    ]      â”‚
â”‚                                     â”‚
â”‚  ï¿½ Enable Encryption               â”‚
â”‚  â˜ Password protect this room       â”‚
â”‚                                     â”‚
â”‚  Password: [________________]       â”‚
â”‚  (Optional, 8-64 characters)        â”‚
â”‚                                     â”‚
â”‚  ğŸ’¡ Tip: Only people with the       â”‚
â”‚     password can read messages.     â”‚
â”‚                                     â”‚
â”‚  [Create Room]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.2 æˆ¿é—´è®¾ç½®é¢æ¿

åœ¨å³ä¾§è¾¹æ æ˜¾ç¤ºç®€åŒ–çš„åŠ å¯†ä¿¡æ¯ï¼š
```
ğŸ” Encryption

âœ… Password Protected
ğŸ”‘ Status: Active

[Change Password]
[Share Room Info]

ğŸ’¡ Room Password: â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢
   [Show] [Copy]
```

#### 4.2.3 åŠ å…¥æˆ¿é—´æµç¨‹

**åœºæ™¯ 1: æˆ¿é—´æœ‰å¯†ç ä¿æŠ¤**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ï¿½ Join Protected Room         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  Room: My Secret Chat           â”‚
â”‚                                 â”‚
â”‚  This room is password          â”‚
â”‚  protected. Enter the password  â”‚
â”‚  to access encrypted messages.  â”‚
â”‚                                 â”‚
â”‚  Password:                      â”‚
â”‚  [____________________]         â”‚
â”‚                                 â”‚
â”‚  [Join Room] [Cancel]           â”‚
â”‚                                 â”‚
â”‚  ğŸ’¡ Ask the room creator for    â”‚
â”‚     the password                â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åœºæ™¯ 2: URL åŒ…å«å¯†ç **
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”’ Join Encrypted Room?        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  Room: My Secret Chat           â”‚
â”‚                                 â”‚
â”‚  This link includes the room    â”‚
â”‚  password. Click Join to enter. â”‚
â”‚                                 â”‚
â”‚  Password: â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢           â”‚
â”‚  [Show Password]                â”‚
â”‚                                 â”‚
â”‚  [Join Room] [Cancel]           â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åœºæ™¯ 3: å¯†ç é”™è¯¯**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ Incorrect Password          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  The password you entered is    â”‚
â”‚  incorrect. Please try again.   â”‚
â”‚                                 â”‚
â”‚  Password:                      â”‚
â”‚  [____________________]         â”‚
â”‚                                 â”‚
â”‚  [Try Again] [Cancel]           â”‚
â”‚                                 â”‚
â”‚  ğŸ’¡ Make sure you have the      â”‚
â”‚     correct password            â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æ–‡ä»¶/å›¾ç‰‡åŠ å¯† UI

#### 4.3.1 ä¸Šä¼ è¿›åº¦

```
Uploading: document.pdf
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”’ Encrypting...    [####    ]  â”‚
â”‚ ğŸ“¤ Uploading...     [########]  â”‚
â”‚ âœ… Complete!                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.2 åŠ å¯†å›¾ç‰‡æ˜¾ç¤º

- æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
- ä¸‹è½½å¹¶è§£å¯†åæ˜¾ç¤º
- æ·»åŠ "ğŸ”’"å°å›¾æ ‡è¡¨ç¤ºå·²åŠ å¯†

```html
<div class="encrypted-image-container">
  <img src="[decrypted object url]" alt="Encrypted image">
  <span class="encryption-badge">ğŸ”’</span>
</div>
```

### 4.4 é”™è¯¯å¤„ç†ä¸æç¤º

#### 4.4.1 æ— æ³•è§£å¯†æ¶ˆæ¯

æ˜¾ç¤ºå ä½ç¬¦ï¼š
```
ğŸ”’ [10:30:00] Alice: [ğŸ” Encrypted message - Key unavailable]
```

#### 4.4.2 å¯†é’¥ä¸¢å¤±

å…¨å±æç¤ºï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸  Encryption Key Lost            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  You cannot read messages in this   â”‚
â”‚  room because the encryption key    â”‚
â”‚  is not available.                  â”‚
â”‚                                     â”‚
â”‚  Options:                           â”‚
â”‚  â€¢ Import key from backup           â”‚
â”‚  â€¢ Request key from room members    â”‚
â”‚  â€¢ Leave room                       â”‚
â”‚                                     â”‚
â”‚  [Import Key] [Request Key] [Leave] â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. å®ç°è·¯çº¿å›¾

### 5.1 Phase 1: åŸºç¡€æ¶æ„

**ç›®æ ‡**: å»ºç«‹åŠ å¯†åŸºç¡€è®¾æ–½

- [ ] åˆ›å»ºåŠ å¯†å·¥å…·ç±» (`crypto-utils.js`)
  - AES-GCM åŠ å¯†/è§£å¯†
  - RSA å¯†é’¥ç”Ÿæˆ
  - å¯†é’¥å¯¼å…¥/å¯¼å‡º
- [ ] å®ç°å¯†é’¥ç®¡ç†æ¨¡å— (`key-manager.js`)
  - IndexedDB å­˜å‚¨
  - æˆ¿é—´å¯†é’¥ç®¡ç†
  - ç”¨æˆ·å¯†é’¥å¯¹ç®¡ç†
- [ ] æ·»åŠ åŠ å¯†ç‰ˆæœ¬æ§åˆ¶

### 5.2 Phase 2: æ¶ˆæ¯åŠ å¯†

**ç›®æ ‡**: å®ç°æ–‡æœ¬æ¶ˆæ¯ç«¯å¯¹ç«¯åŠ å¯†

- [ ] ä¿®æ”¹æ¶ˆæ¯å‘é€æµç¨‹
  - å®¢æˆ·ç«¯åŠ å¯†
  - æ·»åŠ åŠ å¯†æ ‡è¯†
- [ ] ä¿®æ”¹æ¶ˆæ¯æ¥æ”¶æµç¨‹
  - å®¢æˆ·ç«¯è§£å¯†
  - é”™è¯¯å¤„ç†
- [ ] å®ç°å¯†é’¥äº¤æ¢åè®®
  - æ–°ç”¨æˆ·åŠ å…¥æµç¨‹
  - åœ¨çº¿ç”¨æˆ·å¯†é’¥åˆ†å‘
- [ ] UI æ›´æ–°
  - åŠ å¯†çŠ¶æ€æŒ‡ç¤º
  - åŠ å¯†è®¾ç½®é¢æ¿

### 5.3 Phase 3: æ–‡ä»¶åŠ å¯† 

**ç›®æ ‡**: å®ç°æ–‡ä»¶å’Œå›¾ç‰‡åŠ å¯†ä¸Šä¼ /ä¸‹è½½

- [ ] å®ç°æ–‡ä»¶åŠ å¯†ä¸Šä¼ 
  - æµå¼åŠ å¯†ï¼ˆå¤§æ–‡ä»¶ï¼‰
  - å…ƒæ•°æ®ä¿æŠ¤
- [ ] å®ç°æ–‡ä»¶è§£å¯†ä¸‹è½½
  - æµå¼è§£å¯†
  - å†…å­˜ä¼˜åŒ–
- [ ] å›¾ç‰‡åŠ å¯†æ˜¾ç¤º
  - Lazy loading é›†æˆ
  - Object URL ç®¡ç†
- [ ] UI ä¼˜åŒ–
  - ä¸Šä¼ è¿›åº¦æŒ‡ç¤º
  - åŠ å¯†å›¾ç‰‡é¢„è§ˆ

### 5.4 Phase 4: é«˜çº§ç‰¹æ€§

**ç›®æ ‡**: å®Œå–„ç”¨æˆ·ä½“éªŒå’Œå®‰å…¨æ€§

- [ ] å¯†é’¥è½®æ¢æœºåˆ¶
- [ ] å¯†é’¥å¤‡ä»½ä¸æ¢å¤
  - äºŒç»´ç å¯¼å‡º
  - åŠ©è®°è¯å¤‡ä»½
- [ ] å¯†é’¥åˆ†äº«ä¼˜åŒ–
  - URL å‚æ•°ä¼ é€’
  - QR ç ç”Ÿæˆ
- [ ] æ€§èƒ½ä¼˜åŒ–
  - Web Workers åŠ å¯†
  - æ‰¹é‡è§£å¯†ä¼˜åŒ–

### 5.5 Phase 5: æµ‹è¯•ä¸å‘å¸ƒ

**ç›®æ ‡**: ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œå®‰å…¨æ€§

- [ ] å•å…ƒæµ‹è¯•
  - åŠ å¯†/è§£å¯†åŠŸèƒ½
  - å¯†é’¥ç®¡ç†
- [ ] é›†æˆæµ‹è¯•
  - å¤šç”¨æˆ·åœºæ™¯
  - å¯†é’¥äº¤æ¢æµç¨‹
- [ ] å®‰å…¨å®¡è®¡
  - å¯†é’¥æ³„æ¼æ£€æŸ¥
  - æ—¶åºæ”»å‡»é˜²æŠ¤
- [ ] æ€§èƒ½æµ‹è¯•
  - å¤§æ–‡ä»¶åŠ å¯†
  - æ‰¹é‡æ¶ˆæ¯è§£å¯†
- [ ] æ–‡æ¡£ç¼–å†™
  - ç”¨æˆ·æŒ‡å—
  - å¼€å‘è€…æ–‡æ¡£

---

## 6. æŠ€æœ¯å®ç°ç»†èŠ‚

### 6.1 åŠ å¯†å·¥å…·åº“ (`crypto-utils.js`)

```javascript
// crypto-utils.js
export class CryptoUtils {
  /**
   * ä»å¯†ç æ´¾ç”ŸåŠ å¯†å¯†é’¥ï¼ˆæ¨èæ–¹æ³•ï¼‰
   * @param {string} password - ç”¨æˆ·è¾“å…¥çš„æˆ¿é—´å¯†ç 
   * @param {string} roomId - æˆ¿é—´IDï¼ˆä½œä¸ºsaltï¼‰
   * @param {number} iterations - PBKDF2è¿­ä»£æ¬¡æ•°ï¼ˆé»˜è®¤100000ï¼‰
   * @returns {Promise<CryptoKey>} AES-GCMå¯†é’¥
   */
  static async deriveKeyFromPassword(password, roomId, iterations = 100000) {
    // 1. å°†å¯†ç è½¬æ¢ä¸ºå¯†é’¥ææ–™
    const encoder = new TextEncoder();
    const passwordBuffer = encoder.encode(password);
    
    const baseKey = await crypto.subtle.importKey(
      "raw",
      passwordBuffer,
      "PBKDF2",
      false,
      ["deriveBits", "deriveKey"]
    );
    
    // 2. ä½¿ç”¨ roomId ä½œä¸º saltï¼ˆç¡®ä¿ä¸åŒæˆ¿é—´ä¸åŒå¯†é’¥ï¼‰
    const salt = encoder.encode(roomId);
    
    // 3. æ´¾ç”Ÿ AES-GCM å¯†é’¥
    const derivedKey = await crypto.subtle.deriveKey(
      {
        name: "PBKDF2",
        salt: salt,
        iterations: iterations,
        hash: "SHA-256"
      },
      baseKey,
      { name: "AES-GCM", length: 256 },
      true,
      ["encrypt", "decrypt"]
    );
    
    return derivedKey;
  }

  /**
   * ç”Ÿæˆæ–°çš„ AES-256 æˆ¿é—´å¯†é’¥ï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰
   */
  static async generateRoomKey() {
    return await crypto.subtle.generateKey(
      { name: "AES-GCM", length: 256 },
      true,
      ["encrypt", "decrypt"]
    );
  }

  /**
   * ç”Ÿæˆ RSA å¯†é’¥å¯¹ï¼ˆç”¨äºå¯†é’¥äº¤æ¢ï¼‰
   */
  static async generateKeyPair() {
    return await crypto.subtle.generateKey(
      {
        name: "RSA-OAEP",
        modulusLength: 2048,
        publicExponent: new Uint8Array([1, 0, 1]),
        hash: "SHA-256"
      },
      true,
      ["encrypt", "decrypt"]
    );
  }

  /**
   * åŠ å¯†æ–‡æœ¬æ¶ˆæ¯
   */
  static async encryptMessage(plaintext, key) {
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encodedText = new TextEncoder().encode(plaintext);
    
    const ciphertext = await crypto.subtle.encrypt(
      { name: "AES-GCM", iv },
      key,
      encodedText
    );

    return {
      iv: Array.from(iv),
      ciphertext: Array.from(new Uint8Array(ciphertext)),
      version: "1.0"
    };
  }

  /**
   * è§£å¯†æ–‡æœ¬æ¶ˆæ¯
   */
  static async decryptMessage(encryptedData, key) {
    const iv = new Uint8Array(encryptedData.iv);
    const ciphertext = new Uint8Array(encryptedData.ciphertext);

    const decrypted = await crypto.subtle.decrypt(
      { name: "AES-GCM", iv },
      key,
      ciphertext
    );

    return new TextDecoder().decode(decrypted);
  }

  /**
   * å¯¼å‡ºå¯†é’¥ä¸º Base64
   */
  static async exportKey(key) {
    const exported = await crypto.subtle.exportKey("raw", key);
    return btoa(String.fromCharCode(...new Uint8Array(exported)));
  }

  /**
   * ä» Base64 å¯¼å…¥å¯†é’¥
   */
  static async importKey(keyBase64) {
    const keyData = Uint8Array.from(atob(keyBase64), c => c.charCodeAt(0));
    return await crypto.subtle.importKey(
      "raw",
      keyData,
      { name: "AES-GCM" },
      true,
      ["encrypt", "decrypt"]
    );
  }

  /**
   * ä½¿ç”¨ RSA å…¬é’¥åŠ å¯†å¯¹ç§°å¯†é’¥
   */
  static async encryptKeyWithPublicKey(symmetricKey, publicKey) {
    const exported = await crypto.subtle.exportKey("raw", symmetricKey);
    const encrypted = await crypto.subtle.encrypt(
      { name: "RSA-OAEP" },
      publicKey,
      exported
    );
    return Array.from(new Uint8Array(encrypted));
  }

  /**
   * ä½¿ç”¨ RSA ç§é’¥è§£å¯†å¯¹ç§°å¯†é’¥
   */
  static async decryptKeyWithPrivateKey(encryptedKey, privateKey) {
    const keyData = new Uint8Array(encryptedKey);
    const decrypted = await crypto.subtle.decrypt(
      { name: "RSA-OAEP" },
      privateKey,
      keyData
    );
    
    return await crypto.subtle.importKey(
      "raw",
      decrypted,
      { name: "AES-GCM" },
      true,
      ["encrypt", "decrypt"]
    );
  }
}
```

### 6.2 å¯†é’¥ç®¡ç†å™¨ (`key-manager.js`)

```javascript
// key-manager.js
export class KeyManager {
  constructor() {
    this.dbName = "ChatKeysDB";
    this.dbVersion = 1;
    this.db = null;
    this.passwordCache = new Map(); // å†…å­˜ä¸­ç¼“å­˜å¯†ç ï¼ˆå¯é€‰ï¼‰
  }

  /**
   * åˆå§‹åŒ– IndexedDB
   */
  async init() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.dbVersion);

      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        this.db = request.result;
        resolve();
      };

      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        
        // æˆ¿é—´å¯†ç å­˜å‚¨ï¼ˆå­˜å‚¨å¯†ç å“ˆå¸Œæˆ–ç›´æ¥å­˜å‚¨å¯†ç ï¼‰
        if (!db.objectStoreNames.contains("roomPasswords")) {
          db.createObjectStore("roomPasswords", { keyPath: "roomId" });
        }
        
        // æˆ¿é—´å¯†é’¥ç¼“å­˜ï¼ˆå¯é€‰ï¼Œç”¨äºæ€§èƒ½ä¼˜åŒ–ï¼‰
        if (!db.objectStoreNames.contains("roomKeys")) {
          db.createObjectStore("roomKeys", { keyPath: "roomId" });
        }
      };
    });
  }

  /**
   * ä¿å­˜æˆ¿é—´å¯†ç ï¼ˆæ¨èæ–¹æ³•ï¼‰
   * @param {string} roomId - æˆ¿é—´ID
   * @param {string} password - ç”¨æˆ·è¾“å…¥çš„å¯†ç 
   */
  async saveRoomPassword(roomId, password) {
    const tx = this.db.transaction("roomPasswords", "readwrite");
    const store = tx.objectStore("roomPasswords");
    
    await store.put({
      roomId,
      password: password, // å¯ä»¥é€‰æ‹©å­˜å‚¨å“ˆå¸Œï¼Œä½†ä¸ºäº†ç”¨æˆ·ä½“éªŒå­˜å‚¨æ˜æ–‡
      createdAt: Date.now()
    });
    
    // åŒæ—¶ç¼“å­˜åˆ°å†…å­˜
    this.passwordCache.set(roomId, password);
    
    return new Promise((resolve, reject) => {
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  /**
   * è·å–æˆ¿é—´å¯†ç 
   * @param {string} roomId - æˆ¿é—´ID
   * @returns {Promise<string|null>} å¯†ç æˆ–null
   */
  async getRoomPassword(roomId) {
    // å…ˆæ£€æŸ¥å†…å­˜ç¼“å­˜
    if (this.passwordCache.has(roomId)) {
      return this.passwordCache.get(roomId);
    }
    
    // ä»æ•°æ®åº“è¯»å–
    const tx = this.db.transaction("roomPasswords", "readonly");
    const store = tx.objectStore("roomPasswords");
    const request = store.get(roomId);

    return new Promise((resolve, reject) => {
      request.onsuccess = () => {
        if (request.result) {
          const password = request.result.password;
          this.passwordCache.set(roomId, password);
          resolve(password);
        } else {
          resolve(null);
        }
      };
      request.onerror = () => reject(request.error);
    });
  }

  /**
   * ä»å¯†ç è·å–æˆ–æ´¾ç”Ÿæˆ¿é—´å¯†é’¥
   * @param {string} roomId - æˆ¿é—´ID
   * @param {string} password - æˆ¿é—´å¯†ç ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸æä¾›åˆ™ä»å­˜å‚¨è¯»å–ï¼‰
   * @returns {Promise<CryptoKey|null>} åŠ å¯†å¯†é’¥æˆ–null
   */
  async getRoomKey(roomId, password = null) {
    // å¦‚æœæ²¡æœ‰æä¾›å¯†ç ï¼Œå°è¯•ä»å­˜å‚¨è¯»å–
    if (!password) {
      password = await this.getRoomPassword(roomId);
    }
    
    if (!password) {
      return null;
    }
    
    // ä»å¯†ç æ´¾ç”Ÿå¯†é’¥
    const key = await CryptoUtils.deriveKeyFromPassword(password, roomId);
    return key;
  }

  /**
   * éªŒè¯æˆ¿é—´å¯†ç æ˜¯å¦æ­£ç¡®
   * @param {string} roomId - æˆ¿é—´ID
   * @param {string} password - è¦éªŒè¯çš„å¯†ç 
   * @param {object} testMessage - ç”¨äºæµ‹è¯•çš„åŠ å¯†æ¶ˆæ¯
   * @returns {Promise<{success: boolean, key?: CryptoKey, error?: string}>}
   */
  async verifyRoomPassword(roomId, password, testMessage) {
    try {
      // ä»å¯†ç æ´¾ç”Ÿå¯†é’¥
      const key = await CryptoUtils.deriveKeyFromPassword(password, roomId);
      
      // å°è¯•è§£å¯†æµ‹è¯•æ¶ˆæ¯
      const decrypted = await CryptoUtils.decryptMessage(testMessage, key);
      
      // è§£å¯†æˆåŠŸï¼Œä¿å­˜å¯†ç 
      await this.saveRoomPassword(roomId, password);
      
      return { success: true, key };
    } catch (error) {
      return { success: false, error: "Incorrect password" };
    }
  }

  /**
   * å­˜å‚¨æˆ¿é—´å¯†é’¥ï¼ˆé«˜çº§æ–¹æ¡ˆï¼Œç›´æ¥å­˜å‚¨å¯†é’¥ï¼‰
   */
  async saveRoomKey(roomId, key) {
    const exported = await CryptoUtils.exportKey(key);
    const tx = this.db.transaction("roomKeys", "readwrite");
    const store = tx.objectStore("roomKeys");
    
    await store.put({
      roomId,
      key: exported,
      createdAt: Date.now()
    });
    
    return new Promise((resolve, reject) => {
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  /**
   * è·å–æˆ¿é—´å¯†é’¥
   */
  async getRoomKey(roomId) {
    const tx = this.db.transaction("roomKeys", "readonly");
    const store = tx.objectStore("roomKeys");
    const request = store.get(roomId);

    return new Promise((resolve, reject) => {
      request.onsuccess = async () => {
        if (request.result) {
          const key = await CryptoUtils.importKey(request.result.key);
          resolve(key);
        } else {
          resolve(null);
        }
      };
      request.onerror = () => reject(request.error);
    });
  }

  /**
   * åˆ é™¤æˆ¿é—´å¯†é’¥
   */
  async deleteRoomKey(roomId) {
    const tx = this.db.transaction("roomKeys", "readwrite");
    const store = tx.objectStore("roomKeys");
    await store.delete(roomId);
    
    return new Promise((resolve, reject) => {
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰æˆ¿é—´å¯†é’¥
   */
  async hasRoomKey(roomId) {
    const key = await this.getRoomKey(roomId);
    return key !== null;
  }
}
```

### 6.3 æ¶ˆæ¯åŠ å¯†é›†æˆï¼ˆåŸºäºæˆ¿é—´å¯†ç ï¼‰

```javascript
// åœ¨ chat.html ä¸­çš„ä¿®æ”¹

// åˆå§‹åŒ–å¯†é’¥ç®¡ç†å™¨
const keyManager = new KeyManager();
await keyManager.init();

// åˆ›å»ºæˆ¿é—´æ—¶è®¾ç½®å¯†ç 
async function createRoomWithPassword(roomName, password) {
  // 1. åˆ›å»ºæˆ¿é—´
  const roomId = await createRoom(roomName);
  
  if (password) {
    // 2. ä¿å­˜æˆ¿é—´å¯†ç 
    await keyManager.saveRoomPassword(roomId, password);
    
    // 3. å‘é€ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ï¼ˆç”¨äºåç»­å¯†ç éªŒè¯ï¼‰
    const testKey = await keyManager.getRoomKey(roomId, password);
    const testEncrypted = await CryptoUtils.encryptMessage("__TEST__", testKey);
    
    // 4. å°†æµ‹è¯•æ¶ˆæ¯ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ˆæ ‡è®°ä¸ºç³»ç»Ÿæ¶ˆæ¯ï¼‰
    ws.send(JSON.stringify({
      message: `ENCRYPTED:${JSON.stringify(testEncrypted)}`,
      messageId: crypto.randomUUID(),
      encryptionType: "e2ee-aes256-gcm",
      isTestMessage: true
    }));
  }
  
  return roomId;
}

// åŠ å…¥æˆ¿é—´æ—¶éªŒè¯å¯†ç 
async function joinRoomWithPassword(roomId, password) {
  // 1. è¿æ¥åˆ°æˆ¿é—´çš„ WebSocket
  await connectToRoom(roomId);
  
  // 2. è·å–æœ€è¿‘çš„ä¸€æ¡åŠ å¯†æ¶ˆæ¯ä½œä¸ºæµ‹è¯•
  const testMessage = await fetchTestMessage(roomId);
  
  if (testMessage) {
    // 3. éªŒè¯å¯†ç 
    const result = await keyManager.verifyRoomPassword(
      roomId, 
      password, 
      testMessage
    );
    
    if (result.success) {
      console.log("Password verified, joining room...");
      return { success: true };
    } else {
      return { success: false, error: "Incorrect password" };
    }
  } else {
    // æ²¡æœ‰æµ‹è¯•æ¶ˆæ¯ï¼Œä¿å­˜å¯†ç å¹¶å°è¯•
    await keyManager.saveRoomPassword(roomId, password);
    return { success: true };
  }
}

// å‘é€æ¶ˆæ¯æ—¶åŠ å¯†ï¼ˆä½¿ç”¨å¯†ç æ´¾ç”Ÿçš„å¯†é’¥ï¼‰
async function sendMessage(plaintext) {
  // è·å–å½“å‰æˆ¿é—´å¯†é’¥ï¼ˆè‡ªåŠ¨ä»å¯†ç æ´¾ç”Ÿï¼‰
  const roomKey = await keyManager.getRoomKey(currentRoomId);
  
  if (roomKey) {
    // åŠ å¯†æ¶ˆæ¯
    const encrypted = await CryptoUtils.encryptMessage(plaintext, roomKey);
    const encryptedMessage = `ENCRYPTED:${JSON.stringify(encrypted)}`;
    
    // å‘é€åŠ å¯†æ¶ˆæ¯
    ws.send(JSON.stringify({
      message: encryptedMessage,
      messageId: crypto.randomUUID(),
      encryptionType: "e2ee-aes256-gcm"
    }));
  } else {
    // æ²¡æœ‰å¯†ç ï¼Œæç¤ºç”¨æˆ·è¾“å…¥
    showPasswordPrompt();
  }
}

// æ¥æ”¶æ¶ˆæ¯æ—¶è§£å¯†
ws.onmessage = async (event) => {
  const data = JSON.parse(event.data);
  
  if (data.message && data.message.startsWith("ENCRYPTED:")) {
    const roomKey = await keyManager.getRoomKey(currentRoomId);
    
    if (roomKey) {
      try {
        const encryptedData = JSON.parse(data.message.substring(10));
        const plaintext = await CryptoUtils.decryptMessage(encryptedData, roomKey);
        
        // æ˜¾ç¤ºè§£å¯†åçš„æ¶ˆæ¯
        displayMessage({
          ...data,
          message: plaintext,
          decrypted: true
        });
      } catch (error) {
        console.error("Decryption failed:", error);
        displayMessage({
          ...data,
          message: "[ğŸ” Unable to decrypt message]",
          decryptionFailed: true
        });
      }
    } else {
      // æ²¡æœ‰å¯†é’¥ï¼Œæ˜¾ç¤ºå ä½ç¬¦
      displayMessage({
        ...data,
        message: "[ğŸ” Encrypted message - Key unavailable]",
        encrypted: true
      });
    }
  } else {
    // æ˜æ–‡æ¶ˆæ¯
    displayMessage(data);
  }
};
```

### 6.4 æˆ¿é—´å¯†ç å¤„ç†æµç¨‹

```javascript
// å¤„ç†æˆ¿é—´å¯†ç çš„å®Œæ•´æµç¨‹

// 1. ä» URL å‚æ•°è·å–å¯†ç 
function getPasswordFromURL() {
  const hash = window.location.hash;
  const params = new URLSearchParams(hash.substring(hash.indexOf('?')));
  
  // æ”¯æŒå¤šç§å‚æ•°å
  const password = params.get('pwd') || params.get('password') || params.get('p');
  
  // å¦‚æœæ˜¯æ··æ·†çš„å¯†ç ï¼Œè§£ç 
  if (params.get('p')) {
    return deobfuscatePassword(password);
  }
  
  return password;
}

// 2. æ˜¾ç¤ºå¯†ç è¾“å…¥å¯¹è¯æ¡†
function showPasswordPrompt(roomId, roomName) {
  return new Promise((resolve, reject) => {
    // åˆ›å»ºå¯¹è¯æ¡† UI
    const dialog = document.createElement('div');
    dialog.className = 'password-prompt-dialog';
    dialog.innerHTML = `
      <div class="password-prompt-content">
        <h3>ğŸ” Room is Password Protected</h3>
        <p>Room: ${roomName || roomId}</p>
        <p>Enter the password to access encrypted messages.</p>
        <input type="password" id="room-password-input" 
               placeholder="Enter password" 
               autocomplete="off">
        <div class="password-prompt-actions">
          <button id="password-submit">Join Room</button>
          <button id="password-cancel">Cancel</button>
        </div>
        <p class="password-error" style="display:none;color:red;">
          âŒ Incorrect password. Please try again.
        </p>
      </div>
    `;
    
    document.body.appendChild(dialog);
    
    const input = dialog.querySelector('#room-password-input');
    const submitBtn = dialog.querySelector('#password-submit');
    const cancelBtn = dialog.querySelector('#password-cancel');
    const errorMsg = dialog.querySelector('.password-error');
    
    // èšç„¦è¾“å…¥æ¡†
    input.focus();
    
    // æäº¤å¯†ç 
    const submitPassword = async () => {
      const password = input.value.trim();
      
      if (!password) {
        errorMsg.textContent = 'âš ï¸ Please enter a password';
        errorMsg.style.display = 'block';
        return;
      }
      
      // éªŒè¯å¯†ç 
      const testMessage = await fetchTestMessage(roomId);
      const result = await keyManager.verifyRoomPassword(
        roomId, 
        password, 
        testMessage
      );
      
      if (result.success) {
        // å¯†ç æ­£ç¡®
        document.body.removeChild(dialog);
        resolve(password);
      } else {
        // å¯†ç é”™è¯¯
        errorMsg.textContent = 'âŒ Incorrect password. Please try again.';
        errorMsg.style.display = 'block';
        input.value = '';
        input.focus();
      }
    };
    
    // äº‹ä»¶ç›‘å¬
    submitBtn.onclick = submitPassword;
    cancelBtn.onclick = () => {
      document.body.removeChild(dialog);
      reject(new Error('Password prompt cancelled'));
    };
    input.onkeypress = (e) => {
      if (e.key === 'Enter') {
        submitPassword();
      }
    };
  });
}

// 3. å®Œæ•´çš„åŠ å…¥æˆ¿é—´æµç¨‹
async function joinRoom(roomId) {
  try {
    // Step 1: æ£€æŸ¥ URL æ˜¯å¦åŒ…å«å¯†ç 
    let password = getPasswordFromURL();
    
    // Step 2: å¦‚æœ URL æœ‰å¯†ç ï¼Œè‡ªåŠ¨å¡«å……å¹¶æç¤ºç”¨æˆ·
    if (password) {
      const confirmed = confirm(
        `This link includes a room password.\nClick OK to join with the provided password.`
      );
      
      if (!confirmed) {
        password = null;
      }
    }
    
    // Step 3: è¿æ¥åˆ°æˆ¿é—´
    await connectToRoom(roomId);
    
    // Step 4: æ£€æŸ¥æˆ¿é—´æ˜¯å¦éœ€è¦å¯†ç 
    const roomInfo = await fetchRoomInfo(roomId);
    const isEncrypted = roomInfo.encrypted || false;
    
    if (isEncrypted) {
      // Step 5: å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–å¯†ç 
      if (!password) {
        password = await keyManager.getRoomPassword(roomId);
      }
      
      // Step 6: å¦‚æœè¿˜æ˜¯æ²¡æœ‰å¯†ç ï¼Œæç¤ºç”¨æˆ·è¾“å…¥
      if (!password) {
        password = await showPasswordPrompt(roomId, roomInfo.name);
      }
      
      // Step 7: éªŒè¯å¯†ç 
      const result = await joinRoomWithPassword(roomId, password);
      
      if (result.success) {
        console.log('Successfully joined encrypted room');
        return true;
      } else {
        throw new Error('Failed to join room: ' + result.error);
      }
    } else {
      // éåŠ å¯†æˆ¿é—´ï¼Œç›´æ¥åŠ å…¥
      console.log('Joined unencrypted room');
      return true;
    }
  } catch (error) {
    console.error('Failed to join room:', error);
    alert('Failed to join room: ' + error.message);
    return false;
  }
}

// 4. åˆ†äº«æˆ¿é—´ä¿¡æ¯
function shareRoom(roomId, roomName, password) {
  const baseUrl = window.location.origin + window.location.pathname;
  
  // ç”Ÿæˆåˆ†äº« URLï¼ˆåŒ…å«å¯†ç ï¼‰
  const shareUrl = `${baseUrl}#room=${roomId}&pwd=${encodeURIComponent(password)}`;
  
  // ç”Ÿæˆåˆ†äº«æ–‡æœ¬
  const shareText = `Join my chat room!\n\nRoom: ${roomName || roomId}\nPassword: ${password}\n\nOr click: ${shareUrl}`;
  
  // æ˜¾ç¤ºåˆ†äº«å¯¹è¯æ¡†
  const dialog = document.createElement('div');
  dialog.className = 'share-dialog';
  dialog.innerHTML = `
    <div class="share-content">
      <h3>ğŸ“¤ Share This Room</h3>
      <div class="share-info">
        <p><strong>Room:</strong> ${roomName || roomId}</p>
        <p><strong>Password:</strong> ${password}</p>
      </div>
      <div class="share-options">
        <button id="copy-link">ğŸ”— Copy Link</button>
        <button id="copy-info">ğŸ“‹ Copy Room Info</button>
        <button id="show-qr">ğŸ“± Show QR Code</button>
      </div>
      <div class="share-url">
        <input type="text" value="${shareUrl}" readonly>
      </div>
      <p class="share-warning">âš ï¸ Keep this password safe!</p>
      <button id="close-share">Close</button>
    </div>
  `;
  
  document.body.appendChild(dialog);
  
  // å¤åˆ¶é“¾æ¥
  dialog.querySelector('#copy-link').onclick = () => {
    navigator.clipboard.writeText(shareUrl);
    alert('Link copied to clipboard!');
  };
  
  // å¤åˆ¶æˆ¿é—´ä¿¡æ¯
  dialog.querySelector('#copy-info').onclick = () => {
    navigator.clipboard.writeText(shareText);
    alert('Room info copied to clipboard!');
  };
  
  // æ˜¾ç¤º QR ç 
  dialog.querySelector('#show-qr').onclick = () => {
    // è¿™é‡Œé›†æˆ QR ç ç”Ÿæˆåº“
    alert('QR code feature coming soon!');
  };
  
  // å…³é—­å¯¹è¯æ¡†
  dialog.querySelector('#close-share').onclick = () => {
    document.body.removeChild(dialog);
  };
}

// åœ¨çº¿ç”¨æˆ·åˆ†äº«å¯†é’¥
ws.onmessage = async (event) => {
  const data = JSON.parse(event.data);
  
  if (data.type === "new-user-requesting-key") {
    // 1. è·å–æˆ¿é—´å¯†é’¥
    const roomKey = await keyManager.getRoomKey(currentRoomId);
    
    if (roomKey) {
      // 2. å¯¼å…¥æ–°ç”¨æˆ·çš„å…¬é’¥
      const publicKeyData = Uint8Array.from(
        atob(data.publicKey), 
        c => c.charCodeAt(0)
      );
      const publicKey = await crypto.subtle.importKey(
        "spki",
        publicKeyData,
        { name: "RSA-OAEP", hash: "SHA-256" },
        false,
        ["encrypt"]
      );
      
      // 3. ä½¿ç”¨å…¬é’¥åŠ å¯†æˆ¿é—´å¯†é’¥
      const encryptedKey = await CryptoUtils.encryptKeyWithPublicKey(
        roomKey,
        publicKey
      );
      
      // 4. å‘é€åŠ å¯†çš„å¯†é’¥
      ws.send(JSON.stringify({
        type: "share-room-key",
        targetUserId: data.userId,
        encryptedKey: encryptedKey
      }));
    }
  }
};
```

---

## 7. å®‰å…¨è€ƒè™‘

### 7.1 å¨èƒæ¨¡å‹

| å¨èƒ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|----------|----------|
| æœåŠ¡å™¨çªƒå–å¯†é’¥ | âŒ å·²é˜²å¾¡ | å¯†é’¥ä»…å­˜å‚¨åœ¨å®¢æˆ·ç«¯ |
| ä¸­é—´äººæ”»å‡» | âš ï¸ ä¸­ç­‰ | HTTPS + è¯ä¹¦å›ºå®š |
| å®¢æˆ·ç«¯æ¶æ„ä»£ç  | âš ï¸ ä¸­ç­‰ | å­èµ„æºå®Œæ•´æ€§ (SRI) |
| å†…å­˜è½¬å‚¨æ”»å‡» | âš ï¸ ä½ | åŠæ—¶æ¸…ç†æ•æ„Ÿæ•°æ® |
| æµè§ˆå™¨æ‰©å±•çªƒå– | âš ï¸ ä¸­ç­‰ | ç”¨æˆ·æ•™è‚² + CSP ç­–ç•¥ |
| å¯†é’¥ä¸¢å¤± | âš ï¸ ä¸­ç­‰ | å¯†é’¥å¤‡ä»½æœºåˆ¶ |
| é‡æ”¾æ”»å‡» | âœ… å·²é˜²å¾¡ | æ—¶é—´æˆ³ + æ¶ˆæ¯ ID |

### 7.2 å®‰å…¨æœ€ä½³å®è·µ

#### 7.2.1 å¯†é’¥å­˜å‚¨
- âœ… ä½¿ç”¨ IndexedDB å­˜å‚¨ï¼ˆæ¯” LocalStorage æ›´å®‰å…¨ï¼‰
- âœ… è€ƒè™‘ä½¿ç”¨ Web Crypto API çš„ non-extractable å¯†é’¥
- âœ… å®šæœŸæ¸…ç†è¿‡æœŸå¯†é’¥

#### 7.2.2 åŠ å¯†å‚æ•°
- âœ… AES-256-GCMï¼ˆè®¤è¯åŠ å¯†ï¼‰
- âœ… éšæœº IVï¼Œæ¯æ¡æ¶ˆæ¯ä¸åŒ
- âœ… ä½¿ç”¨ Web Crypto APIï¼ˆç¡¬ä»¶åŠ é€Ÿï¼‰

#### 7.2.3 å¯†é’¥äº¤æ¢
- âœ… RSA-OAEP 2048-bit æˆ– ECDH P-256
- âœ… ä¸´æ—¶å¯†é’¥å¯¹ï¼Œç”¨åå³åˆ 
- âœ… éªŒè¯å…¬é’¥å®Œæ•´æ€§

#### 7.2.4 å‰ç«¯å®‰å…¨
```html
<!-- å†…å®¹å®‰å…¨ç­–ç•¥ -->
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'">

<!-- å­èµ„æºå®Œæ•´æ€§ -->
<script src="crypto-utils.js" 
        integrity="sha384-..." 
        crossorigin="anonymous"></script>
```

#### 7.2.5 å†…å­˜å®‰å…¨
```javascript
// ä½¿ç”¨åæ¸…ç†æ•æ„Ÿæ•°æ®
function clearSensitiveData(buffer) {
  if (buffer instanceof ArrayBuffer) {
    const view = new Uint8Array(buffer);
    view.fill(0);
  }
}

// æ¸…ç†è§£å¯†åçš„æ˜æ–‡
function safeDisplay(decryptedText) {
  displayMessage(decryptedText);
  // ä¸ä¿ç•™åŸå§‹å­—ç¬¦ä¸²å¼•ç”¨
  decryptedText = null;
}
```

### 7.3 å·²çŸ¥é™åˆ¶

1. **æµè§ˆå™¨ç¯å¢ƒå®‰å…¨æ€§**
   - JavaScript åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œå¯èƒ½å—åˆ°æ¶æ„æ‰©å±•å½±å“
   - è§£å†³æ–¹æ¡ˆï¼šç”¨æˆ·æ•™è‚²ï¼Œæé†’ç¦ç”¨ä¸å—ä¿¡ä»»çš„æ‰©å±•

2. **å¯†é’¥åˆ†å‘é—®é¢˜**
   - ç¦»çº¿æˆ¿é—´æ— æ³•è‡ªåŠ¨è·å–å¯†é’¥
   - è§£å†³æ–¹æ¡ˆï¼šæä¾› URL å‚æ•°ã€QR ç ç­‰å¤šç§åˆ†äº«æ–¹å¼

3. **å‘å‰ä¿å¯†æ€§**
   - é•¿æœŸä½¿ç”¨åŒä¸€å¯†é’¥é™ä½å®‰å…¨æ€§
   - è§£å†³æ–¹æ¡ˆï¼šå®ç°å¯†é’¥è½®æ¢æœºåˆ¶

4. **è®¾å¤‡ä¸¢å¤±**
   - è®¾å¤‡ä¸¢å¤±å¯¼è‡´å¯†é’¥æ°¸ä¹…ä¸¢å¤±
   - è§£å†³æ–¹æ¡ˆï¼šäº‘ç«¯åŠ å¯†å¤‡ä»½ï¼ˆå¯é€‰ï¼‰

---

## 8. æ€§èƒ½ä¼˜åŒ–ä¸å¼‚æ­¥å¤„ç†æ¶æ„

### 8.1 æ ¸å¿ƒæ€§èƒ½åŸåˆ™

**è®¾è®¡ç›®æ ‡**ï¼š
- ğŸ¯ UI ä¸»çº¿ç¨‹é›¶é˜»å¡ï¼šæ‰€æœ‰åŠ å¯†æ“ä½œåœ¨ Worker ä¸­å¼‚æ­¥æ‰§è¡Œ
- ğŸ¯ æµå¼å¤„ç†å¤§æ–‡ä»¶ï¼šæ”¯æŒ GB çº§æ–‡ä»¶çš„åˆ†å—åŠ è§£å¯†
- ğŸ¯ æ‰¹é‡æ“ä½œä¼˜åŒ–ï¼šå†å²æ¶ˆæ¯åŠ è½½æ—¶æ™ºèƒ½æ‰¹å¤„ç†
- ğŸ¯ å†…å­˜é«˜æ•ˆï¼šé¿å…å¤§æ•°æ®åœ¨ä¸»çº¿ç¨‹å †ç§¯

### 8.2 Web Worker å¼‚æ­¥åŠ å¯†æ¶æ„

#### 8.2.1 Worker çº¿ç¨‹æ± è®¾è®¡

**æ¶æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸»çº¿ç¨‹ (UI Thread)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  Crypto Manager (è°ƒåº¦å™¨)             â”‚               â”‚
â”‚  â”‚  - ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†                      â”‚               â”‚
â”‚  â”‚  - Worker æ± ç®¡ç†                     â”‚               â”‚
â”‚  â”‚  - è´Ÿè½½å‡è¡¡                          â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚           â”‚                                               â”‚
â”‚           â”‚ ä»»åŠ¡åˆ†å‘                                      â”‚
â”‚           â–¼                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ postMessage (éé˜»å¡)
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Worker #1  â”‚  â”‚  Worker #2  â”‚  â”‚  Worker #N  â”‚      â”‚
â”‚  â”‚  - åŠ å¯†ä»»åŠ¡  â”‚  â”‚  - è§£å¯†ä»»åŠ¡  â”‚  â”‚  - æ–‡ä»¶å¤„ç†  â”‚      â”‚
â”‚  â”‚  - PBKDF2   â”‚  â”‚  - æ‰¹é‡å¤„ç†  â”‚  â”‚  - æµå¼åŠ å¯†  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                           â”‚
â”‚              Worker çº¿ç¨‹æ±  (ç‹¬ç«‹çº¿ç¨‹)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ä»£ç **ï¼š

```javascript
// crypto-worker-pool.js - Worker çº¿ç¨‹æ± ç®¡ç†å™¨
export class CryptoWorkerPool {
  constructor(workerCount = navigator.hardwareConcurrency || 4) {
    this.workers = [];
    this.taskQueue = [];
    this.activeTasksPerWorker = new Map();
    this.taskIdCounter = 0;
    
    // åˆ›å»º Worker æ± 
    for (let i = 0; i < workerCount; i++) {
      const worker = new Worker('crypto-worker.js');
      this.workers.push(worker);
      this.activeTasksPerWorker.set(worker, 0);
      
      // ç›‘å¬ Worker å“åº”
      worker.onmessage = (event) => {
        this.handleWorkerResponse(worker, event);
      };
      
      worker.onerror = (error) => {
        console.error(`Worker ${i} error:`, error);
      };
    }
    
    console.log(`âœ… Crypto Worker Pool initialized with ${workerCount} workers`);
  }
  
  /**
   * æäº¤åŠ å¯†ä»»åŠ¡åˆ° Worker æ± 
   * @param {string} type - ä»»åŠ¡ç±»å‹: 'encrypt', 'decrypt', 'derive-key', 'encrypt-file'
   * @param {object} data - ä»»åŠ¡æ•°æ®
   * @returns {Promise} ä»»åŠ¡ç»“æœ
   */
  async submitTask(type, data) {
    return new Promise((resolve, reject) => {
      const taskId = this.taskIdCounter++;
      const task = { taskId, type, data, resolve, reject, timestamp: Date.now() };
      
      // é€‰æ‹©è´Ÿè½½æœ€ä½çš„ Worker
      const worker = this.selectWorker();
      
      if (worker) {
        this.executeTask(worker, task);
      } else {
        // æ‰€æœ‰ Worker ç¹å¿™ï¼ŒåŠ å…¥é˜Ÿåˆ—
        this.taskQueue.push(task);
      }
    });
  }
  
  /**
   * é€‰æ‹©è´Ÿè½½æœ€ä½çš„ Worker
   */
  selectWorker() {
    let minLoad = Infinity;
    let selectedWorker = null;
    
    for (const [worker, load] of this.activeTasksPerWorker) {
      if (load < minLoad) {
        minLoad = load;
        selectedWorker = worker;
      }
    }
    
    // å¦‚æœæ‰€æœ‰ Worker è´Ÿè½½è¿‡é«˜ï¼Œè¿”å› null
    return minLoad < 5 ? selectedWorker : null;
  }
  
  /**
   * åœ¨ Worker ä¸Šæ‰§è¡Œä»»åŠ¡
   */
  executeTask(worker, task) {
    // è®°å½•ä»»åŠ¡
    if (!worker._activeTasks) {
      worker._activeTasks = new Map();
    }
    worker._activeTasks.set(task.taskId, task);
    
    // æ›´æ–°è´Ÿè½½
    this.activeTasksPerWorker.set(
      worker,
      this.activeTasksPerWorker.get(worker) + 1
    );
    
    // å‘é€ä»»åŠ¡åˆ° Worker
    worker.postMessage({
      taskId: task.taskId,
      type: task.type,
      data: task.data
    });
  }
  
  /**
   * å¤„ç† Worker å“åº”
   */
  handleWorkerResponse(worker, event) {
    const { taskId, success, result, error } = event.data;
    
    // è·å–ä»»åŠ¡
    const task = worker._activeTasks.get(taskId);
    if (!task) {
      console.warn(`Unknown task ${taskId}`);
      return;
    }
    
    // æ¸…ç†ä»»åŠ¡
    worker._activeTasks.delete(taskId);
    this.activeTasksPerWorker.set(
      worker,
      this.activeTasksPerWorker.get(worker) - 1
    );
    
    // è§£æç»“æœ
    if (success) {
      task.resolve(result);
      
      // è®°å½•æ€§èƒ½æŒ‡æ ‡
      const duration = Date.now() - task.timestamp;
      if (duration > 100) {
        console.warn(`Slow crypto task ${task.type}: ${duration}ms`);
      }
    } else {
      task.reject(new Error(error));
    }
    
    // å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
    if (this.taskQueue.length > 0) {
      const nextTask = this.taskQueue.shift();
      this.executeTask(worker, nextTask);
    }
  }
  
  /**
   * æ‰¹é‡æäº¤ä»»åŠ¡ï¼ˆå¹¶è¡Œå¤„ç†ï¼‰
   */
  async submitBatch(tasks) {
    const promises = tasks.map(({ type, data }) => 
      this.submitTask(type, data)
    );
    return Promise.all(promises);
  }
  
  /**
   * é”€æ¯ Worker æ± 
   */
  destroy() {
    for (const worker of this.workers) {
      worker.terminate();
    }
    this.workers = [];
    this.taskQueue = [];
    console.log('ğŸ”¥ Crypto Worker Pool destroyed');
  }
}
```

#### 8.2.2 Worker å®ç°ï¼ˆcrypto-worker.jsï¼‰

```javascript
// crypto-worker.js - Worker çº¿ç¨‹ä¸­çš„åŠ å¯†é€»è¾‘
importScripts('crypto-utils.js'); // æˆ–ä½¿ç”¨ ES modules

self.onmessage = async (event) => {
  const { taskId, type, data } = event.data;
  
  try {
    let result;
    
    switch (type) {
      case 'encrypt':
        result = await encryptMessage(data.plaintext, data.key);
        break;
        
      case 'decrypt':
        result = await decryptMessage(data.encrypted, data.key);
        break;
        
      case 'derive-key':
        result = await deriveKeyFromPassword(
          data.password,
          data.roomId,
          data.iterations || 100000
        );
        break;
        
      case 'encrypt-file-chunk':
        result = await encryptFileChunk(
          data.chunk,
          data.key,
          data.chunkIndex
        );
        break;
        
      case 'decrypt-file-chunk':
        result = await decryptFileChunk(
          data.encryptedChunk,
          data.key,
          data.chunkIndex
        );
        break;
        
      case 'batch-decrypt':
        result = await batchDecrypt(data.messages, data.key);
        break;
        
      default:
        throw new Error(`Unknown task type: ${type}`);
    }
    
    // è¿”å›æˆåŠŸç»“æœ
    self.postMessage({
      taskId,
      success: true,
      result
    });
    
  } catch (error) {
    // è¿”å›é”™è¯¯
    self.postMessage({
      taskId,
      success: false,
      error: error.message
    });
  }
};

// ===== Worker å†…éƒ¨åŠ å¯†å‡½æ•° =====

/**
 * ä»å¯†ç æ´¾ç”Ÿå¯†é’¥ï¼ˆåœ¨ Worker ä¸­æ‰§è¡Œï¼Œé¿å…é˜»å¡ UIï¼‰
 */
async function deriveKeyFromPassword(password, roomId, iterations) {
  const encoder = new TextEncoder();
  const passwordBuffer = encoder.encode(password);
  
  const baseKey = await crypto.subtle.importKey(
    "raw",
    passwordBuffer,
    "PBKDF2",
    false,
    ["deriveBits", "deriveKey"]
  );
  
  const salt = encoder.encode(roomId);
  
  const derivedKey = await crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: salt,
      iterations: iterations,
      hash: "SHA-256"
    },
    baseKey,
    { name: "AES-GCM", length: 256 },
    true,
    ["encrypt", "decrypt"]
  );
  
  // å¯¼å‡ºä¸ºå¯ä¼ é€’çš„æ ¼å¼
  const exported = await crypto.subtle.exportKey("raw", derivedKey);
  return { keyData: Array.from(new Uint8Array(exported)) };
}

/**
 * åŠ å¯†æ¶ˆæ¯
 */
async function encryptMessage(plaintext, keyData) {
  const key = await importKey(keyData);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encodedText = new TextEncoder().encode(plaintext);
  
  const ciphertext = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv },
    key,
    encodedText
  );

  return {
    iv: Array.from(iv),
    ciphertext: Array.from(new Uint8Array(ciphertext)),
    version: "1.0"
  };
}

/**
 * è§£å¯†æ¶ˆæ¯
 */
async function decryptMessage(encryptedData, keyData) {
  const key = await importKey(keyData);
  const iv = new Uint8Array(encryptedData.iv);
  const ciphertext = new Uint8Array(encryptedData.ciphertext);

  const decrypted = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv },
    key,
    ciphertext
  );

  return new TextDecoder().decode(decrypted);
}

/**
 * æ‰¹é‡è§£å¯†ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
 */
async function batchDecrypt(messages, keyData) {
  const key = await importKey(keyData);
  const results = [];
  
  for (const msg of messages) {
    try {
      const decrypted = await decryptMessage(msg, keyData);
      results.push({ success: true, plaintext: decrypted });
    } catch (error) {
      results.push({ success: false, error: error.message });
    }
  }
  
  return results;
}

/**
 * åŠ å¯†æ–‡ä»¶åˆ†å—
 */
async function encryptFileChunk(chunkData, keyData, chunkIndex) {
  const key = await importKey(keyData);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  
  // åœ¨ IV ä¸­åŒ…å« chunk indexï¼Œç¡®ä¿æ¯ä¸ª chunk çš„ IV å”¯ä¸€
  const ivWithIndex = new Uint8Array(12);
  ivWithIndex.set(iv.slice(0, 8));
  ivWithIndex.set(new Uint8Array(new Uint32Array([chunkIndex]).buffer), 8);
  
  const encrypted = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv: ivWithIndex },
    key,
    new Uint8Array(chunkData)
  );
  
  return {
    iv: Array.from(ivWithIndex),
    ciphertext: Array.from(new Uint8Array(encrypted)),
    chunkIndex
  };
}

/**
 * è§£å¯†æ–‡ä»¶åˆ†å—
 */
async function decryptFileChunk(encryptedChunk, keyData, chunkIndex) {
  const key = await importKey(keyData);
  const iv = new Uint8Array(encryptedChunk.iv);
  const ciphertext = new Uint8Array(encryptedChunk.ciphertext);
  
  const decrypted = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv },
    key,
    ciphertext
  );
  
  return Array.from(new Uint8Array(decrypted));
}

/**
 * å¯¼å…¥å¯†é’¥
 */
async function importKey(keyData) {
  const keyArray = new Uint8Array(keyData);
  return await crypto.subtle.importKey(
    "raw",
    keyArray,
    { name: "AES-GCM" },
    true,
    ["encrypt", "decrypt"]
  );
}
```

#### 8.2.3 ä¸»çº¿ç¨‹é›†æˆï¼ˆä½¿ç”¨ Worker æ± ï¼‰

```javascript
// åœ¨ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨ Worker æ± 
let cryptoPool = null;

/**
 * åˆå§‹åŒ–åŠ å¯† Worker æ± 
 */
async function initCryptoPool() {
  if (!cryptoPool) {
    cryptoPool = new CryptoWorkerPool(4); // 4ä¸ª Worker çº¿ç¨‹
    console.log('âœ… Crypto Worker Pool ready');
  }
}

/**
 * å¼‚æ­¥åŠ å¯†æ¶ˆæ¯ï¼ˆä¸é˜»å¡ UIï¼‰
 */
async function encryptMessageAsync(plaintext, roomId) {
  // 1. è·å–å¯†é’¥æ•°æ®
  const password = await keyManager.getRoomPassword(roomId);
  if (!password) {
    throw new Error('No password found for room');
  }
  
  // 2. åœ¨ Worker ä¸­æ´¾ç”Ÿå¯†é’¥ï¼ˆè€—æ—¶æ“ä½œï¼‰
  const keyResult = await cryptoPool.submitTask('derive-key', {
    password,
    roomId,
    iterations: 100000
  });
  
  // 3. åœ¨ Worker ä¸­åŠ å¯†æ¶ˆæ¯
  const encrypted = await cryptoPool.submitTask('encrypt', {
    plaintext,
    key: keyResult.keyData
  });
  
  return `ENCRYPTED:${JSON.stringify(encrypted)}`;
}

/**
 * å¼‚æ­¥è§£å¯†æ¶ˆæ¯ï¼ˆä¸é˜»å¡ UIï¼‰
 */
async function decryptMessageAsync(encryptedMessage, roomId) {
  // 1. è§£æåŠ å¯†æ•°æ®
  const encryptedData = JSON.parse(encryptedMessage.substring(10));
  
  // 2. è·å–å¯†é’¥æ•°æ®
  const password = await keyManager.getRoomPassword(roomId);
  if (!password) {
    return "[ğŸ” Encrypted message - Password required]";
  }
  
  // 3. åœ¨ Worker ä¸­æ´¾ç”Ÿå¯†é’¥
  const keyResult = await cryptoPool.submitTask('derive-key', {
    password,
    roomId,
    iterations: 100000
  });
  
  // 4. åœ¨ Worker ä¸­è§£å¯†æ¶ˆæ¯
  try {
    const plaintext = await cryptoPool.submitTask('decrypt', {
      encrypted: encryptedData,
      key: keyResult.keyData
    });
    return plaintext;
  } catch (error) {
    console.error('Decryption failed:', error);
    return "[ğŸ” Unable to decrypt message]";
  }
}

/**
 * æ‰¹é‡è§£å¯†å†å²æ¶ˆæ¯ï¼ˆé«˜æ€§èƒ½ï¼‰
 */
async function decryptHistoryBatch(messages, roomId) {
  // 1. è·å–å¯†é’¥
  const password = await keyManager.getRoomPassword(roomId);
  if (!password) {
    return messages.map(() => ({ success: false, error: 'No password' }));
  }
  
  // 2. æ´¾ç”Ÿå¯†é’¥ï¼ˆä»…ä¸€æ¬¡ï¼‰
  const keyResult = await cryptoPool.submitTask('derive-key', {
    password,
    roomId,
    iterations: 100000
  });
  
  // 3. æ‰¹é‡è§£å¯†ï¼ˆåœ¨ Worker ä¸­å¹¶è¡Œå¤„ç†ï¼‰
  const encryptedMessages = messages.map(msg => {
    if (msg.message.startsWith('ENCRYPTED:')) {
      return JSON.parse(msg.message.substring(10));
    }
    return null;
  }).filter(Boolean);
  
  const results = await cryptoPool.submitTask('batch-decrypt', {
    messages: encryptedMessages,
    key: keyResult.keyData
  });
  
  // 4. åˆå¹¶ç»“æœ
  let resultIndex = 0;
  return messages.map(msg => {
    if (msg.message.startsWith('ENCRYPTED:')) {
      return {
        ...msg,
        message: results[resultIndex].success 
          ? results[resultIndex].plaintext 
          : '[ğŸ” Decryption failed]',
        decrypted: results[resultIndex].success
      };
      resultIndex++;
    }
    return msg;
  });
}
```

### 8.3 æµå¼æ–‡ä»¶åŠ å¯†ï¼ˆå¤§æ–‡ä»¶å¤„ç†ï¼‰

#### 8.3.1 æµå¼åŠ å¯†æ¶æ„

```javascript
/**
 * æµå¼åŠ å¯†å¤§æ–‡ä»¶ï¼ˆä½¿ç”¨ Worker æ± ï¼‰
 * æ”¯æŒ GB çº§æ–‡ä»¶ï¼Œä¸é˜»å¡ UI
 */
async function encryptLargeFileAsync(file, roomId, onProgress) {
  const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB per chunk
  const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
  const encryptedChunks = [];
  
  // è·å–å¯†é’¥
  const password = await keyManager.getRoomPassword(roomId);
  const keyResult = await cryptoPool.submitTask('derive-key', {
    password,
    roomId,
    iterations: 100000
  });
  
  console.log(`ğŸ” Encrypting file: ${file.name} (${totalChunks} chunks)`);
  
  // åˆ›å»ºæ‰¹é‡ä»»åŠ¡
  const tasks = [];
  for (let i = 0; i < totalChunks; i++) {
    const start = i * CHUNK_SIZE;
    const end = Math.min(start + CHUNK_SIZE, file.size);
    const chunk = file.slice(start, end);
    
    // è¯»å– chunk æ•°æ®
    const arrayBuffer = await chunk.arrayBuffer();
    
    // æäº¤åŠ å¯†ä»»åŠ¡ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
    tasks.push(
      cryptoPool.submitTask('encrypt-file-chunk', {
        chunk: Array.from(new Uint8Array(arrayBuffer)),
        key: keyResult.keyData,
        chunkIndex: i
      }).then(result => {
        encryptedChunks[i] = result;
        
        // æ›´æ–°è¿›åº¦
        const progress = ((i + 1) / totalChunks) * 100;
        if (onProgress) {
          onProgress(progress, 'encrypting');
        }
      })
    );
    
    // æ¯ 8 ä¸ª chunk ç­‰å¾…ä¸€æ¬¡ï¼Œé¿å…å†…å­˜æº¢å‡º
    if (tasks.length >= 8) {
      await Promise.all(tasks);
      tasks.length = 0;
    }
  }
  
  // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
  await Promise.all(tasks);
  
  console.log(`âœ… File encryption complete`);
  
  // åˆ›å»ºå…ƒæ•°æ®
  const metadata = {
    originalName: file.name,
    originalType: file.type,
    originalSize: file.size,
    chunkSize: CHUNK_SIZE,
    totalChunks: totalChunks,
    encrypted: true,
    version: "2.0"
  };
  
  // ç»„åˆåŠ å¯†æ–‡ä»¶
  return {
    metadata,
    chunks: encryptedChunks
  };
}

/**
 * æµå¼è§£å¯†å¤§æ–‡ä»¶
 */
async function decryptLargeFileAsync(encryptedFile, roomId, onProgress) {
  const { metadata, chunks } = encryptedFile;
  const decryptedChunks = [];
  
  // è·å–å¯†é’¥
  const password = await keyManager.getRoomPassword(roomId);
  const keyResult = await cryptoPool.submitTask('derive-key', {
    password,
    roomId,
    iterations: 100000
  });
  
  console.log(`ğŸ”“ Decrypting file: ${metadata.originalName} (${chunks.length} chunks)`);
  
  // æ‰¹é‡è§£å¯†
  const tasks = chunks.map((chunk, index) => 
    cryptoPool.submitTask('decrypt-file-chunk', {
      encryptedChunk: chunk,
      key: keyResult.keyData,
      chunkIndex: index
    }).then(result => {
      decryptedChunks[index] = new Uint8Array(result);
      
      // æ›´æ–°è¿›åº¦
      const progress = ((index + 1) / chunks.length) * 100;
      if (onProgress) {
        onProgress(progress, 'decrypting');
      }
    })
  );
  
  await Promise.all(tasks);
  
  console.log(`âœ… File decryption complete`);
  
  // åˆå¹¶æ‰€æœ‰ chunk
  const totalSize = decryptedChunks.reduce((sum, chunk) => sum + chunk.length, 0);
  const combined = new Uint8Array(totalSize);
  let offset = 0;
  
  for (const chunk of decryptedChunks) {
    combined.set(chunk, offset);
    offset += chunk.length;
  }
  
  // åˆ›å»º Blob
  return new Blob([combined], { type: metadata.originalType });
}

/**
 * ä¸Šä¼ åŠ å¯†æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼ˆå¸¦è¿›åº¦ï¼‰
 */
async function uploadEncryptedFile(file, roomId) {
  const progressDiv = document.createElement('div');
  progressDiv.className = 'upload-progress';
  progressDiv.innerHTML = `
    <div class="progress-bar">
      <div class="progress-fill" style="width: 0%"></div>
    </div>
    <div class="progress-text">Encrypting: 0%</div>
  `;
  document.body.appendChild(progressDiv);
  
  // åŠ å¯†æ–‡ä»¶
  const encrypted = await encryptLargeFileAsync(file, roomId, (progress, stage) => {
    const fill = progressDiv.querySelector('.progress-fill');
    const text = progressDiv.querySelector('.progress-text');
    
    if (stage === 'encrypting') {
      fill.style.width = `${progress * 0.7}%`; // åŠ å¯†å  70%
      text.textContent = `Encrypting: ${Math.round(progress)}%`;
    }
  });
  
  // ä¸Šä¼ åˆ°æœåŠ¡å™¨
  const formData = new FormData();
  formData.append('metadata', JSON.stringify(encrypted.metadata));
  
  // å°†æ‰€æœ‰ chunks åˆå¹¶ä¸ºä¸€ä¸ª Blob
  const chunksData = encrypted.chunks.map(c => new Uint8Array(c.ciphertext));
  const encryptedBlob = new Blob(chunksData);
  formData.append('file', encryptedBlob, `${file.name}.enc`);
  
  const response = await fetch(`/api/room/${roomId}/upload`, {
    method: 'POST',
    body: formData
  });
  
  progressDiv.querySelector('.progress-fill').style.width = '100%';
  progressDiv.querySelector('.progress-text').textContent = 'Upload complete!';
  
  setTimeout(() => document.body.removeChild(progressDiv), 2000);
  
  return await response.json();
}
```

### 8.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 8.4.1 å¯†é’¥ç¼“å­˜ä¼˜åŒ–

```javascript
/**
 * æ™ºèƒ½å¯†é’¥ç¼“å­˜ï¼ˆé¿å…é‡å¤æ´¾ç”Ÿï¼‰
 */
class KeyCache {
  constructor(maxAge = 5 * 60 * 1000) { // 5åˆ†é’Ÿè¿‡æœŸ
    this.cache = new Map();
    this.maxAge = maxAge;
  }
  
  /**
   * è·å–æˆ–æ´¾ç”Ÿå¯†é’¥
   */
  async getKey(roomId, password) {
    const cacheKey = `${roomId}:${password}`;
    const cached = this.cache.get(cacheKey);
    
    if (cached && Date.now() - cached.timestamp < this.maxAge) {
      console.log(`ğŸ“¦ Key cache hit for room ${roomId}`);
      return cached.keyData;
    }
    
    // ç¼“å­˜æœªå‘½ä¸­ï¼Œæ´¾ç”Ÿæ–°å¯†é’¥
    console.log(`ğŸ”‘ Deriving key for room ${roomId}...`);
    const keyResult = await cryptoPool.submitTask('derive-key', {
      password,
      roomId,
      iterations: 100000
    });
    
    // ç¼“å­˜å¯†é’¥
    this.cache.set(cacheKey, {
      keyData: keyResult.keyData,
      timestamp: Date.now()
    });
    
    return keyResult.keyData;
  }
  
  /**
   * æ¸…ç†è¿‡æœŸç¼“å­˜
   */
  cleanup() {
    const now = Date.now();
    for (const [key, value] of this.cache) {
      if (now - value.timestamp > this.maxAge) {
        this.cache.delete(key);
      }
    }
  }
}

const keyCache = new KeyCache();

// å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
setInterval(() => keyCache.cleanup(), 60000); // æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
```

#### 8.4.2 æ‰¹é‡å¤„ç†ç­–ç•¥

```javascript
// æ‰¹é‡è§£å¯†å†å²æ¶ˆæ¯ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
async function loadAndDecryptHistory(roomId, limit = 100) {
  // 1. è·å–å†å²æ¶ˆæ¯
  const messages = await fetchHistoryMessages(roomId, limit);
  
  // 2. æ‰¹é‡è§£å¯†ï¼ˆåœ¨ Worker ä¸­å¹¶è¡Œï¼‰
  const decrypted = await decryptHistoryBatch(messages, roomId);
  
  // 3. åˆ†æ‰¹æ¸²æŸ“åˆ° UIï¼ˆé¿å…é˜»å¡ï¼‰
  const batchSize = 10;
  for (let i = 0; i < decrypted.length; i += batchSize) {
    const batch = decrypted.slice(i, i + batchSize);
    
    // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ä¸é˜»å¡æ¸²æŸ“
    await new Promise(resolve => {
      requestAnimationFrame(() => {
        batch.forEach(msg => displayMessage(msg));
        resolve();
      });
    });
  }
  
  console.log(`âœ… Loaded and decrypted ${decrypted.length} messages`);
}
```

### 8.5 æ€§èƒ½ç›‘æ§ä¸æŒ‡æ ‡

```javascript
/**
 * æ€§èƒ½ç›‘æ§ç±»
 */
class CryptoPerformanceMonitor {
  constructor() {
    this.metrics = {
      encryption: [],
      decryption: [],
      keyDerivation: [],
      fileEncryption: []
    };
  }
  
  /**
   * è®°å½•æ“ä½œæ€§èƒ½
   */
  record(operation, duration, size = 0) {
    this.metrics[operation].push({ duration, size, timestamp: Date.now() });
    
    // ä¿ç•™æœ€è¿‘ 100 æ¡è®°å½•
    if (this.metrics[operation].length > 100) {
      this.metrics[operation].shift();
    }
    
    // è­¦å‘Šæ…¢æ“ä½œ
    if (duration > 500) {
      console.warn(`âš ï¸ Slow ${operation}: ${duration}ms`);
    }
  }
  
  /**
   * è·å–æ€§èƒ½ç»Ÿè®¡
   */
  getStats(operation) {
    const records = this.metrics[operation];
    if (records.length === 0) return null;
    
    const durations = records.map(r => r.duration);
    const avg = durations.reduce((a, b) => a + b, 0) / durations.length;
    const max = Math.max(...durations);
    const min = Math.min(...durations);
    
    return { avg, max, min, count: records.length };
  }
  
  /**
   * æ‰“å°æ€§èƒ½æŠ¥å‘Š
   */
  printReport() {
    console.log('ğŸ“Š Crypto Performance Report:');
    for (const [operation, records] of Object.entries(this.metrics)) {
      const stats = this.getStats(operation);
      if (stats) {
        console.log(`  ${operation}:`, 
          `avg=${stats.avg.toFixed(2)}ms`,
          `max=${stats.max}ms`,
          `min=${stats.min}ms`,
          `count=${stats.count}`
        );
      }
    }
  }
}

const perfMonitor = new CryptoPerformanceMonitor();

// åœ¨æ“ä½œä¸­ä½¿ç”¨ç›‘æ§
async function encryptMessageWithMonitoring(plaintext, roomId) {
  const start = performance.now();
  const result = await encryptMessageAsync(plaintext, roomId);
  const duration = performance.now() - start;
  
  perfMonitor.record('encryption', duration, plaintext.length);
  return result;
}
```

### 8.6 æ€§èƒ½åŸºå‡†ä¸ç›®æ ‡

#### 8.6.1 æ€§èƒ½æŒ‡æ ‡è¦æ±‚

| æ“ä½œ | ç›®æ ‡æ—¶é—´ | æœ€å¤§å¯æ¥å—æ—¶é—´ | ä¼˜åŒ–æ–¹æ¡ˆ |
|------|---------|---------------|---------|
| æ¶ˆæ¯åŠ å¯† | < 5ms | < 20ms | Worker å¼‚æ­¥ |
| æ¶ˆæ¯è§£å¯† | < 5ms | < 20ms | Worker å¼‚æ­¥ |
| å¯†é’¥æ´¾ç”Ÿ (PBKDF2) | < 100ms | < 300ms | Worker + ç¼“å­˜ |
| 100æ¡å†å²æ¶ˆæ¯è§£å¯† | < 500ms | < 1s | æ‰¹é‡ + Worker æ±  |
| 10MB æ–‡ä»¶åŠ å¯† | < 2s | < 5s | æµå¼ + Worker æ±  |
| 100MB æ–‡ä»¶åŠ å¯† | < 20s | < 60s | æµå¼ + Worker æ±  |

#### 8.6.2 æ€§èƒ½æµ‹è¯•åœºæ™¯

```javascript
/**
 * æ€§èƒ½åŸºå‡†æµ‹è¯•å¥—ä»¶
 */
async function runPerformanceBenchmark() {
  console.log('ğŸ Starting E2EE Performance Benchmark...\n');
  
  // åˆå§‹åŒ–
  await initCryptoPool();
  const roomId = 'test-room';
  const password = 'testPassword123';
  
  // æµ‹è¯• 1: å¯†é’¥æ´¾ç”Ÿæ€§èƒ½
  console.log('ğŸ“Š Test 1: Key Derivation (PBKDF2)');
  const keyStart = performance.now();
  const keyResult = await cryptoPool.submitTask('derive-key', {
    password,
    roomId,
    iterations: 100000
  });
  const keyTime = performance.now() - keyStart;
  console.log(`   âœ… Time: ${keyTime.toFixed(2)}ms (target: <100ms)\n`);
  
  // æµ‹è¯• 2: å•æ¡æ¶ˆæ¯åŠ è§£å¯†
  console.log('ğŸ“Š Test 2: Single Message Encryption/Decryption');
  const plaintext = 'Hello, this is a test message!';
  
  const encStart = performance.now();
  const encrypted = await cryptoPool.submitTask('encrypt', {
    plaintext,
    key: keyResult.keyData
  });
  const encTime = performance.now() - encStart;
  console.log(`   ğŸ” Encryption: ${encTime.toFixed(2)}ms (target: <5ms)`);
  
  const decStart = performance.now();
  const decrypted = await cryptoPool.submitTask('decrypt', {
    encrypted,
    key: keyResult.keyData
  });
  const decTime = performance.now() - decStart;
  console.log(`   ğŸ”“ Decryption: ${decTime.toFixed(2)}ms (target: <5ms)\n`);
  
  // æµ‹è¯• 3: æ‰¹é‡æ¶ˆæ¯è§£å¯†ï¼ˆæ¨¡æ‹Ÿå†å²è®°å½•åŠ è½½ï¼‰
  console.log('ğŸ“Š Test 3: Batch Message Decryption (100 messages)');
  const messages = Array(100).fill(null).map(() => ({
    iv: encrypted.iv,
    ciphertext: encrypted.ciphertext,
    version: '1.0'
  }));
  
  const batchStart = performance.now();
  const batchResults = await cryptoPool.submitTask('batch-decrypt', {
    messages,
    key: keyResult.keyData
  });
  const batchTime = performance.now() - batchStart;
  console.log(`   âœ… Time: ${batchTime.toFixed(2)}ms (target: <500ms)`);
  console.log(`   ğŸ“ˆ Throughput: ${(100 / (batchTime / 1000)).toFixed(0)} msg/s\n`);
  
  // æµ‹è¯• 4: å¤§æ–‡ä»¶åŠ å¯†ï¼ˆæ¨¡æ‹Ÿï¼‰
  console.log('ğŸ“Š Test 4: Large File Encryption (10MB simulated)');
  const fileSize = 10 * 1024 * 1024; // 10MB
  const chunkSize = 2 * 1024 * 1024; // 2MB chunks
  const numChunks = Math.ceil(fileSize / chunkSize);
  
  const fileStart = performance.now();
  const chunkTasks = [];
  for (let i = 0; i < numChunks; i++) {
    const chunk = new Uint8Array(chunkSize).fill(i);
    chunkTasks.push(
      cryptoPool.submitTask('encrypt-file-chunk', {
        chunk: Array.from(chunk),
        key: keyResult.keyData,
        chunkIndex: i
      })
    );
  }
  await Promise.all(chunkTasks);
  const fileTime = performance.now() - fileStart;
  console.log(`   âœ… Time: ${(fileTime / 1000).toFixed(2)}s (target: <2s)`);
  console.log(`   ğŸ“ˆ Throughput: ${(fileSize / (fileTime / 1000) / 1024 / 1024).toFixed(2)} MB/s\n`);
  
  // æµ‹è¯• 5: Worker æ± å¹¶å‘æ€§èƒ½
  console.log('ğŸ“Š Test 5: Worker Pool Concurrency (50 parallel encryptions)');
  const concurrentStart = performance.now();
  const concurrentTasks = Array(50).fill(plaintext).map(text => 
    cryptoPool.submitTask('encrypt', {
      plaintext: text,
      key: keyResult.keyData
    })
  );
  await Promise.all(concurrentTasks);
  const concurrentTime = performance.now() - concurrentStart;
  console.log(`   âœ… Time: ${concurrentTime.toFixed(2)}ms`);
  console.log(`   ğŸ“ˆ Avg per task: ${(concurrentTime / 50).toFixed(2)}ms\n`);
  
  // æ€»ç»“
  console.log('ğŸ‰ Benchmark Complete!');
  console.log('\nğŸ“‹ Summary:');
  console.log(`   Key Derivation: ${keyTime.toFixed(2)}ms ${keyTime < 100 ? 'âœ…' : 'âš ï¸'}`);
  console.log(`   Encryption: ${encTime.toFixed(2)}ms ${encTime < 5 ? 'âœ…' : 'âš ï¸'}`);
  console.log(`   Decryption: ${decTime.toFixed(2)}ms ${decTime < 5 ? 'âœ…' : 'âš ï¸'}`);
  console.log(`   Batch (100): ${batchTime.toFixed(2)}ms ${batchTime < 500 ? 'âœ…' : 'âš ï¸'}`);
  console.log(`   File (10MB): ${(fileTime / 1000).toFixed(2)}s ${fileTime < 2000 ? 'âœ…' : 'âš ï¸'}`);
  
  perfMonitor.printReport();
}

// åœ¨å¼€å‘ç¯å¢ƒä¸­è¿è¡ŒåŸºå‡†æµ‹è¯•
if (window.location.search.includes('benchmark=true')) {
  window.addEventListener('load', () => {
    setTimeout(runPerformanceBenchmark, 1000);
  });
}
```

### 8.7 å®é™…åº”ç”¨ä¸­çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 8.7.1 æ‡’åŠ è½½ä¸æ¸è¿›å¼è§£å¯†

```javascript
/**
 * æ¸è¿›å¼åŠ è½½å’Œè§£å¯†å†å²æ¶ˆæ¯
 * ç”¨æˆ·ä½“éªŒä¼˜å…ˆï¼šå…ˆæ˜¾ç¤ºç»“æ„ï¼Œå†é€æ­¥è§£å¯†å†…å®¹
 */
class ProgressiveMessageLoader {
  constructor(roomId) {
    this.roomId = roomId;
    this.isLoading = false;
    this.hasMore = true;
    this.offset = 0;
    this.batchSize = 50;
  }
  
  /**
   * åŠ è½½ä¸‹ä¸€æ‰¹æ¶ˆæ¯
   */
  async loadNext() {
    if (this.isLoading || !this.hasMore) return;
    
    this.isLoading = true;
    console.log(`ğŸ“¥ Loading messages ${this.offset} - ${this.offset + this.batchSize}`);
    
    try {
      // 1. ä»æœåŠ¡å™¨è·å–åŠ å¯†æ¶ˆæ¯ï¼ˆå¿«é€Ÿï¼‰
      const messages = await this.fetchMessages(this.offset, this.batchSize);
      
      if (messages.length === 0) {
        this.hasMore = false;
        return;
      }
      
      // 2. ç«‹å³æ˜¾ç¤ºæ¶ˆæ¯ç»“æ„ï¼ˆç”¨å ä½ç¬¦ä»£æ›¿å†…å®¹ï¼‰
      messages.forEach(msg => {
        this.displayMessageSkeleton(msg);
      });
      
      // 3. åå°å¼‚æ­¥è§£å¯†ï¼ˆä¸é˜»å¡ï¼‰
      this.decryptAndUpdateMessages(messages);
      
      this.offset += messages.length;
    } finally {
      this.isLoading = false;
    }
  }
  
  /**
   * æ˜¾ç¤ºæ¶ˆæ¯éª¨æ¶ï¼ˆå ä½ç¬¦ï¼‰
   */
  displayMessageSkeleton(msg) {
    const messageElement = document.createElement('div');
    messageElement.className = 'message skeleton';
    messageElement.id = `msg-${msg.messageId}`;
    messageElement.innerHTML = `
      <div class="message-header">
        <span class="username">${msg.name}</span>
        <span class="timestamp">${formatTime(msg.timestamp)}</span>
      </div>
      <div class="message-body">
        <span class="decrypting-indicator">ğŸ”“ Decrypting...</span>
      </div>
    `;
    
    document.getElementById('messages').appendChild(messageElement);
  }
  
  /**
   * å¼‚æ­¥è§£å¯†å¹¶æ›´æ–°æ¶ˆæ¯
   */
  async decryptAndUpdateMessages(messages) {
    // åˆ†æ‰¹è§£å¯†ï¼Œæ¯æ‰¹ 10 æ¡
    const subBatchSize = 10;
    
    for (let i = 0; i < messages.length; i += subBatchSize) {
      const batch = messages.slice(i, i + subBatchSize);
      
      // å¼‚æ­¥è§£å¯†è¿™ä¸€æ‰¹
      const decryptedBatch = await decryptHistoryBatch(batch, this.roomId);
      
      // æ›´æ–° UIï¼ˆä½¿ç”¨ requestAnimationFrame é¿å…é˜»å¡ï¼‰
      requestAnimationFrame(() => {
        decryptedBatch.forEach(msg => {
          const element = document.getElementById(`msg-${msg.messageId}`);
          if (element) {
            element.classList.remove('skeleton');
            element.querySelector('.message-body').innerHTML = 
              `<span class="message-text">${escapeHtml(msg.message)}</span>`;
          }
        });
      });
      
      // çŸ­æš‚å»¶è¿Ÿï¼Œé¿å… CPU å ç”¨è¿‡é«˜
      await new Promise(resolve => setTimeout(resolve, 10));
    }
    
    console.log(`âœ… Decrypted ${messages.length} messages`);
  }
  
  async fetchMessages(offset, limit) {
    const response = await fetch(
      `/api/room/${this.roomId}/messages?offset=${offset}&limit=${limit}`
    );
    return await response.json();
  }
}

// ä½¿ç”¨ç¤ºä¾‹
let messageLoader = null;

function initMessageLoader(roomId) {
  messageLoader = new ProgressiveMessageLoader(roomId);
  
  // åŠ è½½ç¬¬ä¸€æ‰¹
  messageLoader.loadNext();
  
  // æ»šåŠ¨åˆ°åº•éƒ¨æ—¶è‡ªåŠ¨åŠ è½½æ›´å¤š
  const messagesContainer = document.getElementById('messages');
  messagesContainer.addEventListener('scroll', () => {
    const scrollTop = messagesContainer.scrollTop;
    if (scrollTop < 100) { // æ¥è¿‘é¡¶éƒ¨
      messageLoader.loadNext();
    }
  });
}
```

#### 8.7.2 å†…å­˜ç®¡ç†ä¸æ¸…ç†

```javascript
/**
 * å†…å­˜ç®¡ç†å™¨ - é˜²æ­¢é•¿æ—¶é—´è¿è¡Œæ—¶å†…å­˜æ³„æ¼
 */
class CryptoMemoryManager {
  constructor() {
    this.decryptedCache = new Map();
    this.maxCacheSize = 200; // æœ€å¤šç¼“å­˜ 200 æ¡è§£å¯†æ¶ˆæ¯
    this.objectUrls = new Set();
  }
  
  /**
   * ç¼“å­˜è§£å¯†åçš„æ¶ˆæ¯
   */
  cacheDecrypted(messageId, plaintext) {
    // LRU ç­–ç•¥ï¼šåˆ é™¤æœ€æ—§çš„
    if (this.decryptedCache.size >= this.maxCacheSize) {
      const firstKey = this.decryptedCache.keys().next().value;
      this.decryptedCache.delete(firstKey);
    }
    
    this.decryptedCache.set(messageId, plaintext);
  }
  
  /**
   * è·å–ç¼“å­˜çš„è§£å¯†æ¶ˆæ¯
   */
  getCached(messageId) {
    return this.decryptedCache.get(messageId);
  }
  
  /**
   * æ³¨å†Œ Object URLï¼ˆç”¨äºå›¾ç‰‡/æ–‡ä»¶ï¼‰
   */
  registerObjectUrl(url) {
    this.objectUrls.add(url);
  }
  
  /**
   * æ¸…ç† Object URLs
   */
  cleanup() {
    console.log(`ğŸ§¹ Cleaning up ${this.objectUrls.size} object URLs`);
    for (const url of this.objectUrls) {
      URL.revokeObjectURL(url);
    }
    this.objectUrls.clear();
  }
  
  /**
   * æ¸…ç†æ—§æ¶ˆæ¯ç¼“å­˜
   */
  clearOldCache(maxAge = 10 * 60 * 1000) { // 10åˆ†é’Ÿ
    // è¿™é‡Œå¯ä»¥æ·»åŠ æ—¶é—´æˆ³è·Ÿè¸ª
    console.log('ğŸ§¹ Clearing old decrypted message cache');
    this.decryptedCache.clear();
  }
}

const memoryManager = new CryptoMemoryManager();

// å®šæœŸæ¸…ç†
setInterval(() => {
  memoryManager.clearOldCache();
}, 5 * 60 * 1000); // æ¯5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
```

#### 8.7.3 æ™ºèƒ½é¢„åŠ è½½ç­–ç•¥

```javascript
/**
 * æ™ºèƒ½é¢„åŠ è½½ - é¢„æµ‹ç”¨æˆ·è¡Œä¸ºï¼Œæå‰è§£å¯†
 */
class SmartPreloader {
  constructor(roomId) {
    this.roomId = roomId;
    this.preloadThreshold = 10; // è·ç¦»å¯è§åŒºåŸŸ 10 æ¡æ¶ˆæ¯æ—¶é¢„åŠ è½½
  }
  
  /**
   * æ£€æŸ¥æ˜¯å¦éœ€è¦é¢„åŠ è½½
   */
  checkPreload() {
    const messagesContainer = document.getElementById('messages');
    const messages = messagesContainer.querySelectorAll('.message');
    
    // æ‰¾åˆ°æœ€åä¸€æ¡å¯è§æ¶ˆæ¯
    const viewportBottom = messagesContainer.scrollTop + messagesContainer.clientHeight;
    
    let lastVisibleIndex = -1;
    messages.forEach((msg, index) => {
      const rect = msg.getBoundingClientRect();
      if (rect.top < viewportBottom) {
        lastVisibleIndex = index;
      }
    });
    
    // å¦‚æœæ¥è¿‘åº•éƒ¨ï¼Œé¢„åŠ è½½æ›´å¤š
    if (lastVisibleIndex >= 0 && 
        messages.length - lastVisibleIndex < this.preloadThreshold) {
      this.preloadNext();
    }
  }
  
  /**
   * é¢„åŠ è½½ä¸‹ä¸€æ‰¹æ¶ˆæ¯
   */
  async preloadNext() {
    if (messageLoader && !messageLoader.isLoading && messageLoader.hasMore) {
      console.log('ğŸ”® Smart preload: loading next batch');
      await messageLoader.loadNext();
    }
  }
}

// ä½¿ç”¨ Intersection Observer ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
function setupSmartPreload(roomId) {
  const preloader = new SmartPreloader(roomId);
  
  const messagesContainer = document.getElementById('messages');
  
  // ä½¿ç”¨ throttle é¿å…è¿‡åº¦è§¦å‘
  let throttleTimer = null;
  messagesContainer.addEventListener('scroll', () => {
    if (throttleTimer) return;
    
    throttleTimer = setTimeout(() => {
      preloader.checkPreload();
      throttleTimer = null;
    }, 200);
  });
}
```

### 8.8 ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–

```javascript
/**
 * ç§»åŠ¨ç«¯ç‰¹å®šä¼˜åŒ–
 */
const MobileOptimizations = {
  /**
   * æ£€æµ‹è®¾å¤‡æ€§èƒ½
   */
  detectPerformance() {
    const cores = navigator.hardwareConcurrency || 2;
    const memory = navigator.deviceMemory || 4; // GB
    
    if (cores <= 2 || memory <= 2) {
      return 'low';
    } else if (cores <= 4 || memory <= 4) {
      return 'medium';
    } else {
      return 'high';
    }
  },
  
  /**
   * æ ¹æ®è®¾å¤‡æ€§èƒ½è°ƒæ•´å‚æ•°
   */
  getOptimalSettings() {
    const performance = this.detectPerformance();
    
    switch (performance) {
      case 'low':
        return {
          workerCount: 2,
          batchSize: 20,
          fileChunkSize: 1 * 1024 * 1024, // 1MB
          maxConcurrent: 2,
          pbkdf2Iterations: 50000 // é™ä½è¿­ä»£æ¬¡æ•°
        };
      case 'medium':
        return {
          workerCount: 4,
          batchSize: 50,
          fileChunkSize: 2 * 1024 * 1024, // 2MB
          maxConcurrent: 4,
          pbkdf2Iterations: 100000
        };
      case 'high':
      default:
        return {
          workerCount: 8,
          batchSize: 100,
          fileChunkSize: 4 * 1024 * 1024, // 4MB
          maxConcurrent: 8,
          pbkdf2Iterations: 100000
        };
    }
  },
  
  /**
   * åº”ç”¨ä¼˜åŒ–è®¾ç½®
   */
  apply() {
    const settings = this.getOptimalSettings();
    console.log('ğŸ“± Applying mobile optimizations:', settings);
    
    // é‡æ–°åˆå§‹åŒ– Worker æ± 
    if (cryptoPool) {
      cryptoPool.destroy();
    }
    cryptoPool = new CryptoWorkerPool(settings.workerCount);
    
    // æ›´æ–°å…¶ä»–å‚æ•°
    window.CRYPTO_SETTINGS = settings;
  }
};

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åº”ç”¨ä¼˜åŒ–
window.addEventListener('load', () => {
  MobileOptimizations.apply();
});
```

### 8.9 æ€§èƒ½æœ€ä½³å®è·µæ€»ç»“

#### âœ… å…³é”®åŸåˆ™

1. **å¼‚æ­¥ä¼˜å…ˆ**
   - âœ… æ‰€æœ‰åŠ å¯†æ“ä½œåœ¨ Worker ä¸­æ‰§è¡Œ
   - âœ… UI ä¸»çº¿ç¨‹åªè´Ÿè´£æ¸²æŸ“
   - âœ… ä½¿ç”¨ `requestAnimationFrame` æ›´æ–° UI

2. **æ‰¹é‡å¤„ç†**
   - âœ… å†å²æ¶ˆæ¯æ‰¹é‡è§£å¯†
   - âœ… æ–‡ä»¶åˆ†å—å¹¶è¡Œå¤„ç†
   - âœ… æ™ºèƒ½æ‰¹æ¬¡å¤§å°ï¼ˆæ ¹æ®è®¾å¤‡æ€§èƒ½ï¼‰

3. **ç¼“å­˜ç­–ç•¥**
   - âœ… å¯†é’¥ç¼“å­˜ï¼ˆé¿å…é‡å¤æ´¾ç”Ÿï¼‰
   - âœ… è§£å¯†æ¶ˆæ¯ç¼“å­˜ï¼ˆLRUï¼‰
   - âœ… å®šæœŸæ¸…ç†é˜²æ­¢å†…å­˜æ³„æ¼

4. **æ¸è¿›å¼åŠ è½½**
   - âœ… å…ˆæ˜¾ç¤ºç»“æ„ï¼Œå†è§£å¯†å†…å®¹
   - âœ… å¯è§åŒºåŸŸä¼˜å…ˆè§£å¯†
   - âœ… æ™ºèƒ½é¢„åŠ è½½

5. **è®¾å¤‡é€‚é…**
   - âœ… æ£€æµ‹è®¾å¤‡æ€§èƒ½
   - âœ… åŠ¨æ€è°ƒæ•´å‚æ•°
   - âœ… ä½ç«¯è®¾å¤‡é™çº§å¤„ç†

#### ğŸ“Š é¢„æœŸæ€§èƒ½è¡¨ç°

| åœºæ™¯ | ä½ç«¯è®¾å¤‡ | ä¸­ç«¯è®¾å¤‡ | é«˜ç«¯è®¾å¤‡ |
|------|---------|---------|---------|
| æ¶ˆæ¯åŠ å¯†/è§£å¯† | < 10ms | < 5ms | < 3ms |
| å¯†é’¥æ´¾ç”Ÿ | < 500ms | < 200ms | < 100ms |
| 100æ¡å†å² | < 2s | < 1s | < 500ms |
| 10MBæ–‡ä»¶ | < 10s | < 5s | < 2s |
| UI å“åº”æ€§ | æµç•… | æµç•… | æµç•… |

---

## 9. æµ‹è¯•è®¡åˆ’

### 9.1 å•å…ƒæµ‹è¯•

```javascript
// crypto-utils.test.js
describe('CryptoUtils', () => {
  test('should encrypt and decrypt message correctly', async () => {
    const key = await CryptoUtils.generateRoomKey();
    const plaintext = "Hello, World!";
    
    const encrypted = await CryptoUtils.encryptMessage(plaintext, key);
    const decrypted = await CryptoUtils.decryptMessage(encrypted, key);
    
    expect(decrypted).toBe(plaintext);
  });
  
  test('should fail to decrypt with wrong key', async () => {
    const key1 = await CryptoUtils.generateRoomKey();
    const key2 = await CryptoUtils.generateRoomKey();
    const plaintext = "Secret message";
    
    const encrypted = await CryptoUtils.encryptMessage(plaintext, key1);
    
    await expect(
      CryptoUtils.decryptMessage(encrypted, key2)
    ).rejects.toThrow();
  });
  
  test('should export and import key correctly', async () => {
    const originalKey = await CryptoUtils.generateRoomKey();
    const exported = await CryptoUtils.exportKey(originalKey);
    const imported = await CryptoUtils.importKey(exported);
    
    const plaintext = "Test message";
    const encrypted = await CryptoUtils.encryptMessage(plaintext, originalKey);
    const decrypted = await CryptoUtils.decryptMessage(encrypted, imported);
    
    expect(decrypted).toBe(plaintext);
  });
});
```

### 9.2 é›†æˆæµ‹è¯•

```javascript
// integration.test.js
describe('E2EE Integration', () => {
  test('should complete full key exchange flow', async () => {
    // æ¨¡æ‹Ÿä¸¤ä¸ªç”¨æˆ·
    const user1 = new ChatClient("Alice");
    const user2 = new ChatClient("Bob");
    
    // User1 åˆ›å»ºæˆ¿é—´å¹¶ç”Ÿæˆå¯†é’¥
    const roomId = await user1.createRoom();
    const roomKey = await user1.getRoomKey(roomId);
    
    // User2 åŠ å…¥æˆ¿é—´å¹¶è¯·æ±‚å¯†é’¥
    await user2.joinRoom(roomId);
    
    // User1 åˆ†äº«å¯†é’¥ç»™ User2
    await user1.shareKeyWith(user2.userId);
    
    // éªŒè¯ User2 æ”¶åˆ°å¯†é’¥
    const receivedKey = await user2.getRoomKey(roomId);
    expect(receivedKey).toBeDefined();
    
    // éªŒè¯ä¸¤ä¸ªç”¨æˆ·å¯ä»¥äº’ç›¸å‘é€åŠ å¯†æ¶ˆæ¯
    const message = "Hello from Alice";
    await user1.sendMessage(message);
    
    const received = await user2.receiveMessage();
    expect(received.plaintext).toBe(message);
  });
});
```

### 9.3 æ€§èƒ½æµ‹è¯•

```javascript
// performance.test.js
describe('Performance', () => {
  test('should encrypt 100 messages in < 1 second', async () => {
    const key = await CryptoUtils.generateRoomKey();
    const messages = Array(100).fill("Test message");
    
    const start = performance.now();
    
    await Promise.all(
      messages.map(msg => CryptoUtils.encryptMessage(msg, key))
    );
    
    const duration = performance.now() - start;
    expect(duration).toBeLessThan(1000);
  });
  
  test('should decrypt 100 messages in < 1 second', async () => {
    const key = await CryptoUtils.generateRoomKey();
    const messages = await Promise.all(
      Array(100).fill("Test").map(msg => 
        CryptoUtils.encryptMessage(msg, key)
      )
    );
    
    const start = performance.now();
    
    await Promise.all(
      messages.map(enc => CryptoUtils.decryptMessage(enc, key))
    );
    
    const duration = performance.now() - start;
    expect(duration).toBeLessThan(1000);
  });
});
```

---

## 10. ç”¨æˆ·æ–‡æ¡£

### 10.1 å¿«é€Ÿå¼€å§‹æŒ‡å—

#### åˆ›å»ºåŠ å¯†æˆ¿é—´

1. ç‚¹å‡» "Create a Private Room"
2. å‹¾é€‰ "Password protect this room"
3. è¾“å…¥ä¸€ä¸ªå¯†ç ï¼ˆå¦‚ "mySecret123"ï¼‰
4. ç‚¹å‡» "Create Room"
5. ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨å¯†ç åŠ å¯†æ‰€æœ‰æ¶ˆæ¯

**æç¤º**: é€‰æ‹©ä¸€ä¸ªå®¹æ˜“è®°ä½ä½†éš¾ä»¥çŒœæµ‹çš„å¯†ç ã€‚

#### åŠ å…¥åŠ å¯†æˆ¿é—´

**æ–¹å¼ 1: ä»é“¾æ¥åŠ å…¥ï¼ˆæ¨èï¼‰**
1. ç‚¹å‡»æœ‹å‹åˆ†äº«çš„é“¾æ¥ï¼ˆåŒ…å«å¯†ç ï¼‰
2. ç¡®è®¤åŠ å…¥æˆ¿é—´
3. å¼€å§‹å®‰å…¨èŠå¤©

**æ–¹å¼ 2: æ‰‹åŠ¨è¾“å…¥å¯†ç **
1. è¾“å…¥æˆ¿é—´ ID
2. ç³»ç»Ÿæç¤ºè¾“å…¥å¯†ç 
3. è¾“å…¥æœ‹å‹å‘Šè¯‰ä½ çš„å¯†ç 
4. å¯†ç éªŒè¯æˆåŠŸåè¿›å…¥æˆ¿é—´

**æ–¹å¼ 3: æ‰«æ QR ç **
1. ä½¿ç”¨æ‰‹æœºç›¸æœºæ‰«æ QR ç 
2. è‡ªåŠ¨æ‰“å¼€æˆ¿é—´å¹¶å¡«å…¥å¯†ç 
3. ç‚¹å‡»åŠ å…¥

#### åˆ†äº«åŠ å¯†æˆ¿é—´

1. åœ¨æˆ¿é—´è®¾ç½®ä¸­ç‚¹å‡» "Share Room Info"
2. é€‰æ‹©åˆ†äº«æ–¹å¼ï¼š
   - **å¤åˆ¶é“¾æ¥**: åŒ…å«å¯†ç çš„å®Œæ•´é“¾æ¥
   - **å¤åˆ¶ä¿¡æ¯**: æˆ¿é—´ ID + å¯†ç æ–‡æœ¬
   - **æ˜¾ç¤º QR ç **: ç”ŸæˆäºŒç»´ç ä¾›æ‰«æ
3. é€šè¿‡å®‰å…¨æ–¹å¼å‘é€ç»™æœ‹å‹

**å®‰å…¨æç¤º**:
- âœ… é€šè¿‡ç«¯å¯¹ç«¯åŠ å¯†çš„èŠå¤©å·¥å…·åˆ†äº«ï¼ˆå¦‚ Signalã€WhatsAppï¼‰
- âœ… å½“é¢å‘ŠçŸ¥å¯†ç 
- âŒ ä¸è¦åœ¨å…¬å¼€åœºåˆå‘é€é“¾æ¥
- âŒ ä¸è¦é€šè¿‡æ˜æ–‡é‚®ä»¶å‘é€å¯†ç 

#### ä¿®æ”¹æˆ¿é—´å¯†ç 

1. ç‚¹å‡»æˆ¿é—´è®¾ç½®ä¸­çš„ "Change Password"
2. è¾“å…¥æ–°å¯†ç 
3. ç¡®è®¤ä¿®æ”¹
4. æ‰€æœ‰åç»­æ¶ˆæ¯å°†ä½¿ç”¨æ–°å¯†ç åŠ å¯†
5. è®°å¾—é€šçŸ¥æˆ¿é—´æˆå‘˜æ–°å¯†ç 

### 10.2 å¸¸è§é—®é¢˜

**Q: ä»€ä¹ˆæ˜¯ç«¯å¯¹ç«¯åŠ å¯†ï¼Ÿ**
A: ç«¯å¯¹ç«¯åŠ å¯†ç¡®ä¿åªæœ‰ä½ å’Œå¯¹è¯æ–¹èƒ½è¯»å–æ¶ˆæ¯ï¼Œå³ä½¿æ˜¯æœåŠ¡å™¨ç®¡ç†å‘˜ä¹Ÿæ— æ³•æŸ¥çœ‹å†…å®¹ã€‚æ‰€æœ‰æ¶ˆæ¯åœ¨ä½ çš„è®¾å¤‡ä¸ŠåŠ å¯†ï¼Œåœ¨å¯¹æ–¹è®¾å¤‡ä¸Šè§£å¯†ï¼Œä¸­é—´æœåŠ¡å™¨åªçœ‹åˆ°ä¹±ç ã€‚

**Q: æˆ¿é—´å¯†ç æ˜¯ä»€ä¹ˆï¼Ÿ**
A: æˆ¿é—´å¯†ç å°±åƒä¸€æŠŠé’¥åŒ™ï¼Œåªæœ‰çŸ¥é“å¯†ç çš„äººæ‰èƒ½è¯»å–æˆ¿é—´é‡Œçš„æ¶ˆæ¯ã€‚å®ƒå¯ä»¥æ˜¯ä»»ä½• 8-64 ä¸ªå­—ç¬¦çš„æ–‡æœ¬ï¼Œå°±åƒä½ çš„ WiFi å¯†ç ä¸€æ ·ã€‚

**Q: æˆ‘ä¸æƒ³è®¾ç½®å¯†ç ï¼Œè¿˜èƒ½æœ‰éšç§ä¿æŠ¤å—ï¼Ÿ**
A: **å¯ä»¥ï¼é»˜è®¤æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨æˆ¿é—´åä½œä¸ºå¯†ç **ã€‚è¿™æ„å‘³ç€ï¼š
- âœ… ä½ åˆ›å»ºæˆ¿é—´"Team Meeting"ï¼Œå¯†ç å°±æ˜¯"Team Meeting"
- âœ… åªæœ‰çŸ¥é“æˆ¿é—´åçš„äººæ‰èƒ½è§£å¯†æ¶ˆæ¯
- âœ… æä¾›åŸºæœ¬çš„éšç§ä¿æŠ¤ï¼Œæ— éœ€è®°å¿†é¢å¤–å¯†ç 
- âœ… ä½ ä»ç„¶å¯ä»¥é€‰æ‹©è®¾ç½®è‡ªå®šä¹‰å¯†ç ä»¥æé«˜å®‰å…¨æ€§

**ä½¿ç”¨åœºæ™¯å¯¹æ¯”**ï¼š

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | è¯´æ˜ |
|------|---------|------|
| **å°å›¢é˜Ÿå†…éƒ¨èŠå¤©** | åŸºç¡€éšç§ï¼ˆé»˜è®¤ï¼‰ | ä½¿ç”¨æˆ¿é—´åä½œä¸ºå¯†ç ï¼Œç®€å•æ–¹ä¾¿ |
| **é¡¹ç›®è®¨è®º** | åŸºç¡€éšç§ï¼ˆé»˜è®¤ï¼‰ | åˆ†äº«æˆ¿é—´åå³å¯ï¼Œå›¢é˜Ÿæˆå‘˜éƒ½çŸ¥é“ |
| **æ•æ„Ÿä¿¡æ¯äº¤æµ** | å¢å¼ºéšç§ | è®¾ç½®å¤æ‚çš„è‡ªå®šä¹‰å¯†ç  |
| **ä¸´æ—¶èŠå¤©** | åŸºç¡€éšç§ï¼ˆé»˜è®¤ï¼‰ | ç”¨å®Œå³å¼ƒï¼Œæ— éœ€å¤æ‚è®¾ç½® |
| **å…¬å¼€è®¨è®º** | ä¸åŠ å¯† | å®Œå…¨å…¬å¼€ï¼Œä»»ä½•äººå¯è§ |

**ç¤ºä¾‹**ï¼š
```
åœºæ™¯ï¼šå›¢é˜Ÿä¼šè®®
- åˆ›å»ºæˆ¿é—´ï¼š"Daily Standup"
- å¯†ç ï¼šè‡ªåŠ¨ä½¿ç”¨ "Daily Standup"
- åˆ†äº«ï¼šå‘Šè¯‰å›¢é˜Ÿæˆå‘˜æˆ¿é—´åå°±è¡Œ
- åŠ å…¥ï¼šè¾“å…¥æˆ¿é—´åå³å¯è‡ªåŠ¨éªŒè¯

åœºæ™¯ï¼šæœºå¯†é¡¹ç›®
- åˆ›å»ºæˆ¿é—´ï¼š"Project X"
- å¯†ç ï¼šè®¾ç½®è‡ªå®šä¹‰ "SecurePass2024!"
- åˆ†äº«ï¼šåˆ†åˆ«å‘ŠçŸ¥æˆ¿é—´åå’Œå¯†ç 
- åŠ å…¥ï¼šå¿…é¡»è¾“å…¥æ­£ç¡®çš„è‡ªå®šä¹‰å¯†ç 
```

**Q: æˆ‘å¿˜è®°äº†æˆ¿é—´å¯†ç æ€ä¹ˆåŠï¼Ÿ**
A: æ ¹æ®æˆ¿é—´çš„éšç§çº§åˆ«ï¼š

**åŸºç¡€éšç§æˆ¿é—´**ï¼š
- å¯†ç å°±æ˜¯æˆ¿é—´åï¼Œç›´æ¥è¾“å…¥æˆ¿é—´åå³å¯
- é™¤éåˆ›å»ºè€…ä¿®æ”¹äº†å¯†ç 

**å¢å¼ºéšç§æˆ¿é—´**ï¼š
- å¦‚æœå¿˜è®°è‡ªå®šä¹‰å¯†ç ï¼Œä½ å°†æ— æ³•è§£å¯†å†å²æ¶ˆæ¯
- å¯ä»¥è¯¢é—®æˆ¿é—´é‡Œçš„å…¶ä»–æˆå‘˜
- å¦‚æœä½ æ˜¯æˆ¿é—´åˆ›å»ºè€…ï¼Œè€ƒè™‘åˆ›å»ºæ–°æˆ¿é—´
- æ£€æŸ¥æ˜¯å¦åœ¨æµè§ˆå™¨ä¸­ä¿å­˜äº†å¯†ç 

**Q: å¯†ç éœ€è¦å¤šå¤æ‚ï¼Ÿ**
A: æ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©ï¼š

**åŸºç¡€éšç§ï¼ˆé»˜è®¤ï¼‰**ï¼š
- âœ… ä½¿ç”¨æˆ¿é—´åä½œä¸ºå¯†ç 
- âœ… é€‚åˆå¤§å¤šæ•°åœºæ™¯
- âœ… ç®€å•æ˜“ç”¨ï¼Œæ— éœ€è®°å¿†

**å¢å¼ºéšç§ï¼ˆæ¨èæ•æ„Ÿåœºæ™¯ï¼‰**ï¼š
- âœ… è‡³å°‘ 8 ä¸ªå­—ç¬¦
- âœ… åŒ…å«å­—æ¯å’Œæ•°å­—
- âœ… å®¹æ˜“è®°ä½ä½†éš¾ä»¥çŒœæµ‹
- ç¤ºä¾‹ï¼š`MyChat2024`ã€`SecretGroup123!`

**Q: åŠ å¯†ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ**
A: ä¸ä¼šã€‚Web Crypto API ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿï¼ŒåŠ å¯†å’Œè§£å¯†é€Ÿåº¦éå¸¸å¿«ï¼Œä½ ä¸ä¼šæ„Ÿè§‰åˆ°ä»»ä½•å»¶è¿Ÿã€‚

**Q: å¯ä»¥åœ¨å¤šä¸ªè®¾å¤‡ä¸Šä½¿ç”¨åŒä¸€ä¸ªæˆ¿é—´å—ï¼Ÿ**
A: å¯ä»¥ï¼åªè¦åœ¨æ¯ä¸ªè®¾å¤‡ä¸Šè¾“å…¥ç›¸åŒçš„æˆ¿é—´å¯†ç å³å¯ã€‚å¯†ç ä¼šè‡ªåŠ¨ä¿å­˜åœ¨è®¾å¤‡ä¸Šï¼Œä¸‹æ¬¡è®¿é—®æ— éœ€é‡æ–°è¾“å…¥ã€‚

å¯¹äºåŸºç¡€éšç§æˆ¿é—´ï¼Œåªéœ€è¾“å…¥æˆ¿é—´åå³å¯è‡ªåŠ¨åŠ å…¥ã€‚

**Q: å¦‚ä½•åˆ†äº«æˆ¿é—´ç»™æœ‹å‹ï¼Ÿ**
A: æ ¹æ®æˆ¿é—´ç±»å‹æœ‰ä¸åŒçš„æ–¹å¼ï¼š

**åŸºç¡€éšç§æˆ¿é—´ï¼ˆé»˜è®¤ï¼‰**ï¼š
- åªéœ€å‘Šè¯‰æœ‹å‹æˆ¿é—´åï¼š"æ¥åŠ å…¥ 'Team Meeting' æˆ¿é—´"
- ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨æˆ¿é—´åä½œä¸ºå¯†ç éªŒè¯
- æœ€ç®€å•ï¼

**å¢å¼ºéšç§æˆ¿é—´**ï¼š
1. åˆ†äº«åŒ…å«å¯†ç çš„é“¾æ¥ï¼ˆæœ€æ–¹ä¾¿ï¼‰
2. åˆ†äº«æˆ¿é—´åå’Œè‡ªå®šä¹‰å¯†ç ï¼ˆåˆ†åˆ«å‘ŠçŸ¥ï¼‰
3. æ˜¾ç¤º QR ç è®©æœ‹å‹æ‰«æ

**Q: URL ä¸­åŒ…å«å¯†ç å®‰å…¨å—ï¼Ÿ**
A: è™½ç„¶ä¸æ˜¯æœ€å®‰å…¨çš„æ–¹å¼ï¼Œä½†é€‚åˆå¿«é€Ÿåˆ†äº«ã€‚å»ºè®®ï¼š
- é€šè¿‡ç«¯å¯¹ç«¯åŠ å¯†çš„èŠå¤©å·¥å…·å‘é€ï¼ˆå¦‚ Signalã€WhatsAppï¼‰
- åˆ†äº«åå¯ä»¥è€ƒè™‘ä¿®æ”¹å¯†ç 
- æˆ–è€…åˆ†åˆ«å‘é€æˆ¿é—´åå’Œå¯†ç 

å¯¹äºåŸºç¡€éšç§æˆ¿é—´ï¼Œåªéœ€åˆ†äº«æˆ¿é—´åï¼Œä¸éœ€è¦åœ¨ URL ä¸­åŒ…å«å¯†ç ã€‚

**Q: åŠ å¯†çš„æ–‡ä»¶å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ**
A: åŠ å¯†åçš„æ–‡ä»¶å­˜å‚¨åœ¨ Cloudflare R2 å­˜å‚¨æœåŠ¡ä¸Šï¼Œä½†æœåŠ¡å™¨åªèƒ½çœ‹åˆ°åŠ å¯†åçš„æ•°æ®ï¼Œæ— æ³•è§£å¯†æŸ¥çœ‹å®é™…å†…å®¹ã€‚

**Q: å¯ä»¥ä¿®æ”¹æˆ¿é—´å¯†ç å—ï¼Ÿ**
A: å¯ä»¥ï¼æˆ¿é—´åˆ›å»ºè€…å¯ä»¥éšæ—¶ä¿®æ”¹å¯†ç ã€‚ä¿®æ”¹åï¼Œæ—§å¯†ç å°†æ— æ³•è§£å¯†æ–°æ¶ˆæ¯ï¼Œä½†å†å²æ¶ˆæ¯ä»ç„¶å¯ä»¥ç”¨æ—§å¯†ç è§£å¯†ã€‚

**æ³¨æ„**ï¼šå¦‚æœä½ çš„æˆ¿é—´ä½¿ç”¨åŸºç¡€éšç§ï¼ˆæˆ¿é—´åä½œä¸ºå¯†ç ï¼‰ï¼Œä¿®æ”¹å¯†ç åç”¨æˆ·æ— æ³•é€šè¿‡æˆ¿é—´åè‡ªåŠ¨åŠ å…¥ï¼Œéœ€è¦å‘ŠçŸ¥æ–°å¯†ç ã€‚

**Q: å¦‚æœæœ‰äººçŸ¥é“äº†å¯†ç æ€ä¹ˆåŠï¼Ÿ**
A: ç«‹å³ä¿®æ”¹æˆ¿é—´å¯†ç ï¼Œä¿®æ”¹åçš„æ–°æ¶ˆæ¯ä»–ä»¬å°†æ— æ³•è§£å¯†ã€‚è€ƒè™‘åˆ›å»ºæ–°æˆ¿é—´å¹¶åªé‚€è¯·ä¿¡ä»»çš„äººã€‚

å¯¹äºåŸºç¡€éšç§æˆ¿é—´ï¼Œæ„å‘³ç€ä»»ä½•çŸ¥é“æˆ¿é—´åçš„äººéƒ½èƒ½åŠ å…¥ã€‚å¦‚æœéœ€è¦æ›´ä¸¥æ ¼çš„æ§åˆ¶ï¼Œå»ºè®®å‡çº§åˆ°å¢å¼ºéšç§æ¨¡å¼ï¼ˆè®¾ç½®è‡ªå®šä¹‰å¯†ç ï¼‰ã€‚

**Q: æˆ¿é—´å¯†ç ä¼šå‘é€åˆ°æœåŠ¡å™¨å—ï¼Ÿ**
A: **ä¸ä¼šï¼**å¯†ç åªåœ¨ä½ çš„æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Œç”¨äºæ´¾ç”ŸåŠ å¯†å¯†é’¥ã€‚æœåŠ¡å™¨ä»ä¸çŸ¥é“ä½ çš„å¯†ç ï¼Œåªçœ‹åˆ°åŠ å¯†åçš„æ¶ˆæ¯ã€‚

**Q: åŸºç¡€éšç§å’Œå¢å¼ºéšç§æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
A: 

| ç‰¹æ€§ | åŸºç¡€éšç§ï¼ˆé»˜è®¤ï¼‰ | å¢å¼ºéšç§ | ä¸åŠ å¯† |
|------|---------------|---------|--------|
| **å¯†ç ** | è‡ªåŠ¨ä½¿ç”¨æˆ¿é—´å | è‡ªå®šä¹‰å¯†ç  | æ—  |
| **æ˜“ç”¨æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **å®‰å…¨æ€§** | â­â­â­ | â­â­â­â­â­ | âŒ |
| **é€‚ç”¨åœºæ™¯** | å›¢é˜Ÿå†…éƒ¨ã€æœ‹å‹èŠå¤© | æ•æ„Ÿä¿¡æ¯ã€æœºå¯†é¡¹ç›® | å…¬å¼€è®¨è®º |
| **åŠ å…¥æ–¹å¼** | è¾“å…¥æˆ¿é—´å | è¾“å…¥æˆ¿é—´å+å¯†ç  | è¾“å…¥æˆ¿é—´ID |
| **é˜²æŠ¤å¯¹è±¡** | é™Œç”Ÿäºº | æ‰€æœ‰äººï¼ˆé™¤éçŸ¥é“å¯†ç ï¼‰ | æ— é˜²æŠ¤ |

**æ¨è**ï¼šé»˜è®¤ä½¿ç”¨åŸºç¡€éšç§ï¼Œæ—¢æœ‰ä¿æŠ¤åˆæ–¹ä¾¿ä½¿ç”¨ã€‚æ•æ„Ÿåœºæ™¯ä½¿ç”¨å¢å¼ºéšç§ã€‚

---

## 11. é™„å½•

### 11.1 æœ¯è¯­è¡¨

- **E2EE**: End-to-End Encryptionï¼Œç«¯å¯¹ç«¯åŠ å¯†
- **AES-GCM**: Advanced Encryption Standard - Galois/Counter Modeï¼Œé«˜çº§åŠ å¯†æ ‡å‡†
- **RSA-OAEP**: RSA Optimal Asymmetric Encryption Padding
- **ECDH**: Elliptic Curve Diffie-Hellmanï¼Œæ¤­åœ†æ›²çº¿å¯†é’¥äº¤æ¢
- **IV**: Initialization Vectorï¼Œåˆå§‹åŒ–å‘é‡
- **Web Crypto API**: æµè§ˆå™¨æä¾›çš„åŠ å¯† API
- **IndexedDB**: æµè§ˆå™¨æœ¬åœ°æ•°æ®åº“

### 11.2 å‚è€ƒèµ„æº

- [Web Crypto API æ–‡æ¡£](https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API)
- [OWASP åŠ å¯†æœ€ä½³å®è·µ](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html)
- [Signal åè®®æ–‡æ¡£](https://signal.org/docs/)
- [NIST åŠ å¯†æ ‡å‡†](https://csrc.nist.gov/projects/cryptographic-standards-and-guidelines)

### 11.3 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|----------|
| 1.0  | 2025-10-26 | åˆå§‹ç‰ˆæœ¬ |

---

## 12. æ€»ç»“

æœ¬ PRD è¯¦ç»†æè¿°äº†ä¸º Cloudflare Workers Chat åº”ç”¨å®ç°ç«¯å¯¹ç«¯åŠ å¯†çš„å®Œæ•´æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

âœ… **å®Œæ•´çš„åŠ å¯†æ¶æ„**ï¼šåŸºäº Web Crypto API çš„ AES-GCM + RSA-OAEP æ–¹æ¡ˆ
âœ… **å¯†é’¥ç®¡ç†ç³»ç»Ÿ**ï¼šIndexedDB å­˜å‚¨ã€å¯†é’¥äº¤æ¢ã€å¤‡ä»½æ¢å¤
âœ… **å…¨æ–¹ä½åŠ å¯†**ï¼šæ–‡æœ¬æ¶ˆæ¯ã€æ–‡ä»¶ã€å›¾ç‰‡ã€èŠå¤©å†å²
âœ… **å‹å¥½çš„ç”¨æˆ·ä½“éªŒ**ï¼šåŠ å¯†çŠ¶æ€æŒ‡ç¤ºã€é”™è¯¯å¤„ç†ã€å¤šç§å¯†é’¥åˆ†äº«æ–¹å¼
âœ… **é«˜æ€§èƒ½å¼‚æ­¥æ¶æ„**ï¼šWeb Workers çº¿ç¨‹æ± ã€æ‰¹é‡å¤„ç†ã€æµå¼åŠ å¯†
âœ… **å®‰å…¨è€ƒè™‘**ï¼šå¨èƒæ¨¡å‹åˆ†æã€å®‰å…¨æœ€ä½³å®è·µ
âœ… **æ¸…æ™°çš„å®ç°è·¯çº¿å›¾**ï¼šåˆ† 5 ä¸ªé˜¶æ®µï¼Œå…± 10 å‘¨å®Œæˆ

---

## 13. å¸¸è§ç–‘é—®è§£ç­”ï¼ˆäº§å“å›¢é˜Ÿå¿…è¯»ï¼‰

### Q1: åŠ å¯†ä¼šå½±å“æœåŠ¡ç«¯æ€§èƒ½å—ï¼Ÿ

**ç­”ï¼šå®Œå…¨ä¸ä¼šï¼æœåŠ¡ç«¯æ— éœ€åšä»»ä½•åŠ å¯†å·¥ä½œã€‚**

æœåŠ¡ç«¯ï¼ˆCloudflare Workers + Durable Objects + R2ï¼‰çš„å·¥ä½œæµç¨‹ä¸ä¹‹å‰**å®Œå…¨ç›¸åŒ**ï¼š
- æ¥æ”¶æ•°æ® â†’ å­˜å‚¨æ•°æ® â†’ è½¬å‘æ•°æ®
- å”¯ä¸€çš„åŒºåˆ«æ˜¯å­˜å‚¨çš„å†…å®¹ä»æ˜æ–‡å˜ä¸ºå¯†æ–‡
- æœåŠ¡ç«¯ CPUã€å†…å­˜ã€å­˜å‚¨å¼€é”€**é›¶å¢é•¿**
- å»¶è¿Ÿ**æ— å˜åŒ–**ï¼ˆåŠ è§£å¯†åœ¨å®¢æˆ·ç«¯ï¼Œä¸é˜»å¡æœåŠ¡ç«¯ï¼‰

```javascript
// æœåŠ¡ç«¯ä»£ç ï¼ˆåŠ å¯†å‰åå¯¹æ¯”ï¼‰

// ===== åŠ å¯†å‰ =====
await storage.put(timestamp, {
  message: "Hello World"  // æ˜æ–‡
});

// ===== åŠ å¯†å =====
await storage.put(timestamp, {
  message: "ENCRYPTED:{...}"  // å¯†æ–‡
});

// ğŸ‘† ä»£ç å®Œå…¨ç›¸åŒï¼åªæ˜¯æ•°æ®å†…å®¹ä¸åŒ
// æœåŠ¡ç«¯æ€§èƒ½å½±å“ï¼š0%
```

### Q2: æœåŠ¡ç«¯éœ€è¦åšä»€ä¹ˆæ”¹åŠ¨å—ï¼Ÿ

**ç­”ï¼šæœåŠ¡ç«¯å‡ ä¹é›¶æ”¹åŠ¨ï¼**

| ç»„ä»¶ | éœ€è¦ä¿®æ”¹å— | è¯´æ˜ |
|------|-----------|------|
| Durable Objects API | âŒ ä¸éœ€è¦ | ç»§ç»­å­˜å‚¨ `message` å­—æ®µï¼Œåªæ˜¯å†…å®¹å˜äº† |
| R2 å­˜å‚¨ | âŒ ä¸éœ€è¦ | ç»§ç»­å­˜å‚¨æ–‡ä»¶ï¼Œåªæ˜¯æ–‡ä»¶æ˜¯åŠ å¯†çš„ |
| WebSocket è½¬å‘ | âŒ ä¸éœ€è¦ | ç»§ç»­è½¬å‘æ¶ˆæ¯ï¼Œåªæ˜¯è½¬å‘å¯†æ–‡ |
| æ•°æ®ç»“æ„ | âŒ ä¸éœ€è¦ | JSON ç»“æ„å®Œå…¨ä¸€è‡´ |
| HTTP API | âŒ ä¸éœ€è¦ | æ¥å£ç­¾åä¸å˜ |

**æœåŠ¡ç«¯å”¯ä¸€å¯èƒ½éœ€è¦çš„æ”¹åŠ¨**ï¼ˆå¯é€‰ï¼‰ï¼š
- æ·»åŠ ä¸€ä¸ª `encryptionType` å­—æ®µç”¨äºæ ‡è¯†åŠ å¯†ç±»å‹
- æ·»åŠ ä¸€ä¸ªæˆ¿é—´å…ƒæ•°æ®å­—æ®µæ ‡è®°æˆ¿é—´æ˜¯å¦å¯ç”¨åŠ å¯†
- è¿™äº›éƒ½æ˜¯**å…ƒæ•°æ®**ï¼Œä¸å½±å“åŠ å¯†æœ¬èº«

### Q3: æ•°æ®åº“å­˜å‚¨çš„æ˜¯ä»€ä¹ˆï¼Ÿ

**ç­”ï¼šæ•°æ®åº“å­˜å‚¨çš„æ˜¯å¯†æ–‡ï¼ŒæœåŠ¡å™¨æ— æ³•è§£å¯†ã€‚**

**å­˜å‚¨ç¤ºä¾‹**ï¼š

```json
// Durable Objects ä¸­çš„å®é™…å­˜å‚¨æ•°æ®
{
  "2025-10-26T10:30:00.000Z": {
    "name": "Alice",
    "message": "ENCRYPTED:{iv:[12,34,56,78,90,...], ciphertext:[11,22,33,44,55,...]}",
    "messageId": "550e8400-e29b-41d4-a716-446655440000",
    "timestamp": 1729936200000,
    "encryptionType": "e2ee-aes256-gcm"
  }
}
```

**å…³é”®ç‚¹**ï¼š
- `name`: æ˜æ–‡ï¼ˆå…¬å¼€ä¿¡æ¯ï¼‰
- `message`: **å¯†æ–‡**ï¼ˆæœåŠ¡å™¨æ— æ³•è§£å¯†ï¼‰
- `messageId`: æ˜æ–‡ï¼ˆå…¬å¼€ä¿¡æ¯ï¼‰
- `timestamp`: æ˜æ–‡ï¼ˆå…¬å¼€ä¿¡æ¯ï¼‰

**å³ä½¿æ•°æ®åº“ç®¡ç†å‘˜ä¹Ÿæ— æ³•è¯»å– `message` çš„å†…å®¹ï¼**

### Q4: æ€§èƒ½ä¼šå½±å“ç”¨æˆ·ä½“éªŒå—ï¼Ÿ

**ç­”ï¼šä¸ä¼šï¼è®¾è®¡ä¸Šå·²ç»å……åˆ†è€ƒè™‘æ€§èƒ½ã€‚**

**æ€§èƒ½ä¿è¯**ï¼š

| æ“ä½œ | ç›®æ ‡æ—¶é—´ | ç”¨æˆ·æ„ŸçŸ¥ |
|------|---------|---------|
| å‘é€æ¶ˆæ¯ | < 5ms åŠ å¯† | âœ… æ— æ„ŸçŸ¥ |
| æ¥æ”¶æ¶ˆæ¯ | < 5ms è§£å¯† | âœ… æ— æ„ŸçŸ¥ |
| åŠ è½½ 100 æ¡å†å² | < 500ms | âœ… æµç•… |
| ä¸Šä¼  10MB å›¾ç‰‡ | < 2s åŠ å¯† | âœ… å¯æ¥å— |

**æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µ**ï¼š

1. **Web Workers å¼‚æ­¥å¤„ç†**
   - æ‰€æœ‰åŠ å¯†æ“ä½œåœ¨åå°çº¿ç¨‹
   - UI ä¸»çº¿ç¨‹å®Œå…¨ä¸é˜»å¡
   - å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†

2. **æ™ºèƒ½ç¼“å­˜**
   - å¯†é’¥ç¼“å­˜ï¼ˆé¿å…é‡å¤æ´¾ç”Ÿï¼‰
   - è§£å¯†æ¶ˆæ¯ç¼“å­˜ï¼ˆé¿å…é‡å¤è§£å¯†ï¼‰
   - LRU ç­–ç•¥é˜²æ­¢å†…å­˜æº¢å‡º

3. **æ‰¹é‡å¤„ç†**
   - å†å²æ¶ˆæ¯æ‰¹é‡è§£å¯†
   - æ–‡ä»¶åˆ†å—å¹¶è¡ŒåŠ å¯†
   - å‡å°‘çº¿ç¨‹åˆ‡æ¢å¼€é”€

4. **æ¸è¿›å¼åŠ è½½**
   - å…ˆæ˜¾ç¤ºæ¶ˆæ¯ç»“æ„
   - åå°å¼‚æ­¥è§£å¯†
   - ç”¨æˆ·æ— éœ€ç­‰å¾…

5. **è®¾å¤‡è‡ªé€‚åº”**
   - æ£€æµ‹è®¾å¤‡æ€§èƒ½
   - ä½ç«¯è®¾å¤‡é™ä½å¹¶å‘æ•°
   - é«˜ç«¯è®¾å¤‡å……åˆ†åˆ©ç”¨å¤šæ ¸

**å®é™…ä½“éªŒ**ï¼š
```
ç”¨æˆ·è§†è§’ï¼š
1. è¾“å…¥æ¶ˆæ¯ â†’ ç‚¹å‡»å‘é€
2. ç«‹å³æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šï¼ˆ< 10msï¼‰
3. èƒŒæ™¯å¼‚æ­¥åŠ å¯†å¹¶å‘é€ï¼ˆ< 5msï¼‰
4. æ¥æ”¶æ–¹ç«‹å³çœ‹åˆ°æ¶ˆæ¯ï¼ˆ< 5ms è§£å¯†ï¼‰

âœ… ç”¨æˆ·æ„Ÿè§‰ï¼šå’ŒæœªåŠ å¯†æ—¶ä¸€æ¨¡ä¸€æ ·ï¼
```

### Q5: å†å²æ¶ˆæ¯åŠ è½½ä¼šå¾ˆæ…¢å—ï¼Ÿ

**ç­”ï¼šä¸ä¼šï¼é‡‡ç”¨æ¸è¿›å¼è§£å¯†ï¼Œç”¨æˆ·ä½“éªŒæµç•…ã€‚**

**åŠ è½½ç­–ç•¥**ï¼š

```javascript
// ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿæ˜¾ç¤ºç»“æ„ï¼ˆ< 50msï¼‰
åŠ è½½æ¶ˆæ¯åˆ—è¡¨ â†’ æ˜¾ç¤ºæ¶ˆæ¯æ¡†æ¶ï¼ˆå ä½ç¬¦ï¼‰

// ç¬¬äºŒé˜¶æ®µï¼šåå°è§£å¯†ï¼ˆæ‰¹é‡å¹¶è¡Œï¼‰
ä½¿ç”¨ Worker æ± æ‰¹é‡è§£å¯† â†’ é€æ­¥æ›´æ–°å†…å®¹

// ç¬¬ä¸‰é˜¶æ®µï¼šæŒ‰éœ€åŠ è½½
æ»šåŠ¨åˆ°é¡¶éƒ¨ â†’ åŠ è½½æ›´å¤šå†å² â†’ é‡å¤ä¸Šè¿°è¿‡ç¨‹
```

**ç”¨æˆ·çœ‹åˆ°çš„æ•ˆæœ**ï¼š

```
åŠ è½½ç¬¬ä¸€å±ï¼ˆ50æ¡æ¶ˆæ¯ï¼‰ï¼š
- 0-50ms: æ˜¾ç¤ºæ¶ˆæ¯æ¡†æ¶ï¼ˆç°è‰²å ä½ç¬¦ï¼‰
- 50-300ms: é€æ­¥æ˜¾ç¤ºè§£å¯†å†…å®¹ï¼ˆ10æ¡/æ‰¹æ¬¡ï¼‰
- ç”¨æˆ·æ„Ÿè§‰ï¼šå¿«é€Ÿä¸”æµç•…

åŠ è½½æ›´å¤šå†å²ï¼š
- æ»šåŠ¨åˆ°é¡¶éƒ¨è§¦å‘
- é¢„åŠ è½½æœºåˆ¶ï¼ˆæå‰è§£å¯†ï¼‰
- æ— ç¼åŠ è½½ä½“éªŒ
```

### Q6: ç§»åŠ¨ç«¯æ€§èƒ½æ€ä¹ˆæ ·ï¼Ÿ

**ç­”ï¼šä¸“é—¨ä¼˜åŒ–äº†ç§»åŠ¨ç«¯ï¼Œä½ç«¯è®¾å¤‡ä¹Ÿèƒ½æµç•…è¿è¡Œã€‚**

**è‡ªé€‚åº”ç­–ç•¥**ï¼š

```javascript
// è‡ªåŠ¨æ£€æµ‹è®¾å¤‡æ€§èƒ½
if (ä½ç«¯è®¾å¤‡) {
  - 2 ä¸ª Worker çº¿ç¨‹
  - æ‰¹æ¬¡å¤§å°: 20 æ¡/æ‰¹
  - PBKDF2 è¿­ä»£: 50,000 æ¬¡
  - æ–‡ä»¶åˆ†å—: 1MB
}

if (ä¸­ç«¯è®¾å¤‡) {
  - 4 ä¸ª Worker çº¿ç¨‹
  - æ‰¹æ¬¡å¤§å°: 50 æ¡/æ‰¹
  - PBKDF2 è¿­ä»£: 100,000 æ¬¡
  - æ–‡ä»¶åˆ†å—: 2MB
}

if (é«˜ç«¯è®¾å¤‡) {
  - 8 ä¸ª Worker çº¿ç¨‹
  - æ‰¹æ¬¡å¤§å°: 100 æ¡/æ‰¹
  - PBKDF2 è¿­ä»£: 100,000 æ¬¡
  - æ–‡ä»¶åˆ†å—: 4MB
}
```

**ç§»åŠ¨ç«¯æµ‹è¯•æ•°æ®**ï¼ˆé¢„æœŸï¼‰ï¼š

| è®¾å¤‡ | å‘é€æ¶ˆæ¯ | æ¥æ”¶æ¶ˆæ¯ | åŠ è½½50æ¡å†å² |
|------|---------|---------|-------------|
| iPhone 15 Pro | < 3ms | < 3ms | < 200ms |
| iPhone 12 | < 5ms | < 5ms | < 400ms |
| ä¸­ç«¯ Android | < 8ms | < 8ms | < 600ms |
| ä½ç«¯æ‰‹æœº | < 15ms | < 15ms | < 1s |

âœ… **å³ä½¿æ˜¯ä½ç«¯æ‰‹æœºï¼Œç”¨æˆ·ä½“éªŒä¾ç„¶æµç•…ï¼**

### Q7: ä¸ç°æœ‰åŠŸèƒ½å…¼å®¹å—ï¼Ÿ

**ç­”ï¼šå®Œå…¨å…¼å®¹ï¼æ”¯æŒé€æ­¥è¿ç§»ã€‚**

**å…¼å®¹æ€§è®¾è®¡**ï¼š

1. **æˆ¿é—´çº§åˆ«å¼€å…³**
   - æœªåŠ å¯†æˆ¿é—´ï¼šç»§ç»­ä½¿ç”¨æ˜æ–‡ï¼ˆå‘åå…¼å®¹ï¼‰
   - åŠ å¯†æˆ¿é—´ï¼šä½¿ç”¨ E2EE
   - ä¸¤ç§æˆ¿é—´å¯ä»¥å…±å­˜

2. **é€æ­¥è¿ç§»**
   - æ–°æˆ¿é—´é»˜è®¤å¯ç”¨åŠ å¯†
   - æ—§æˆ¿é—´ç»§ç»­ä½¿ç”¨æ˜æ–‡
   - ç”¨æˆ·å¯é€‰æ‹©æ˜¯å¦åŠ å¯†

3. **æ¶ˆæ¯æ ‡è¯†**
   ```javascript
   // ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«æ¶ˆæ¯ç±»å‹
   if (message.startsWith("ENCRYPTED:")) {
     è§£å¯†æ˜¾ç¤º
   } else {
     ç›´æ¥æ˜¾ç¤º
   }
   ```

4. **åŠŸèƒ½æ— ç¼ºå¤±**
   - çº¿ç¨‹å›å¤ï¼šæ”¯æŒâœ…
   - @æåŠï¼šæ”¯æŒâœ…
   - è¡¨æƒ…å›åº”ï¼šæ”¯æŒâœ…
   - æ–‡ä»¶ä¸Šä¼ ï¼šæ”¯æŒâœ…
   - å›¾ç‰‡é¢„è§ˆï¼šæ”¯æŒâœ…
   - æœç´¢å†å²ï¼šæ”¯æŒâœ…ï¼ˆå®¢æˆ·ç«¯è§£å¯†åæœç´¢ï¼‰

### Q8: å¼€å‘å·¥ä½œé‡æœ‰å¤šå¤§ï¼Ÿ

**ç­”ï¼šä¸»è¦å·¥ä½œåœ¨å®¢æˆ·ç«¯ï¼Œçº¦ 8-10 å‘¨å®Œæˆã€‚**

**å·¥ä½œé‡åˆ†è§£**ï¼š

| é˜¶æ®µ | å·¥ä½œå†…å®¹ | æ—¶é—´ | äººå‘˜ |
|------|---------|------|------|
| Phase 1 | åŠ å¯†å·¥å…·åº“ã€Worker æ±  | 2 å‘¨ | 1 å‰ç«¯ |
| Phase 2 | æ¶ˆæ¯åŠ å¯†ã€UI é›†æˆ | 2 å‘¨ | 1 å‰ç«¯ |
| Phase 3 | æ–‡ä»¶åŠ å¯†ã€æµå¼å¤„ç† | 2 å‘¨ | 1 å‰ç«¯ |
| Phase 4 | æ€§èƒ½ä¼˜åŒ–ã€ç§»åŠ¨ç«¯ | 2 å‘¨ | 1 å‰ç«¯ |
| Phase 5 | æµ‹è¯•ã€æ–‡æ¡£ã€å‘å¸ƒ | 2 å‘¨ | 1 å‰ç«¯ + 1 QA |

**æœåŠ¡ç«¯å·¥ä½œé‡**ï¼š
- åŸºæœ¬æ— éœ€ä¿®æ”¹
- å¯é€‰ï¼šæ·»åŠ æˆ¿é—´åŠ å¯†æ ‡è¯†ï¼ˆ< 1 å¤©ï¼‰
- å¯é€‰ï¼šæ·»åŠ å…ƒæ•°æ®å­—æ®µï¼ˆ< 1 å¤©ï¼‰

**æ€»è®¡**ï¼š
- å‰ç«¯å¼€å‘ï¼š8-10 å‘¨ï¼ˆ1 äººï¼‰
- åç«¯å¼€å‘ï¼š0-2 å¤©ï¼ˆå¯é€‰ï¼‰
- æµ‹è¯• + æ–‡æ¡£ï¼š2 å‘¨

### Q9: æœ‰ä»€ä¹ˆé£é™©å—ï¼Ÿ

**ç­”ï¼šä¸»è¦é£é™©å¯æ§ï¼Œå»ºè®®åˆ†é˜¶æ®µæ¨å‡ºã€‚**

**æŠ€æœ¯é£é™©**ï¼š

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|-------|------|---------|
| æµè§ˆå™¨å…¼å®¹æ€§ | ä½ | ä¸­ | Web Crypto API å¹¿æ³›æ”¯æŒï¼Œé™çº§å¤„ç† |
| æ€§èƒ½é—®é¢˜ | ä½ | ä¸­ | å……åˆ†çš„æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ– |
| å¯†é’¥ç®¡ç†å¤æ‚ | ä¸­ | é«˜ | ç®€åŒ–ä¸ºæˆ¿é—´å¯†ç æ–¹æ¡ˆ |
| ç”¨æˆ·å¿˜è®°å¯†ç  | é«˜ | ä¸­ | æä¾›å¯†ç æ¢å¤æœºåˆ¶ã€å¤‡ä»½åŠŸèƒ½ |

**äº§å“é£é™©**ï¼š

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|-------|------|---------|
| ç”¨æˆ·å­¦ä¹ æˆæœ¬ | ä¸­ | ä½ | ç®€åŒ– UIï¼Œåƒ WiFi å¯†ç ä¸€æ ·ç®€å• |
| å¯†ç åˆ†äº«å›°éš¾ | ä¸­ | ä¸­ | æä¾›å¤šç§åˆ†äº«æ–¹å¼ï¼ˆé“¾æ¥ã€QR ç ï¼‰ |
| è·¨è®¾å¤‡åŒæ­¥ | é«˜ | ä¸­ | å¯†ç è‡ªåŠ¨ä¿å­˜ï¼Œæ”¯æŒæ‰‹åŠ¨å¯¼å…¥å¯¼å‡º |

**æ¨èå‘å¸ƒç­–ç•¥**ï¼š

```
ç¬¬ä¸€é˜¶æ®µï¼šå†…æµ‹ï¼ˆ2 å‘¨ï¼‰
- 10-20 ä¸ªå†…éƒ¨ç”¨æˆ·
- æ”¶é›†åé¦ˆï¼Œä¿®å¤ bug
- éªŒè¯æ€§èƒ½æŒ‡æ ‡

ç¬¬äºŒé˜¶æ®µï¼šBeta æµ‹è¯•ï¼ˆ4 å‘¨ï¼‰
- 100-500 ä¸ªå¤–éƒ¨ç”¨æˆ·
- ç›‘æ§æ€§èƒ½æ•°æ®
- ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

ç¬¬ä¸‰é˜¶æ®µï¼šé€æ­¥æ¨å¹¿ï¼ˆ6 å‘¨ï¼‰
- æ–°æˆ¿é—´é»˜è®¤å¯ç”¨åŠ å¯†
- æ—§æˆ¿é—´ä¿æŒä¸å˜
- è§‚å¯Ÿç”¨æˆ·åé¦ˆå’Œé‡‡ç”¨ç‡

ç¬¬å››é˜¶æ®µï¼šå…¨é‡å‘å¸ƒ
- æ‰€æœ‰æ–°æˆ¿é—´å¯ç”¨åŠ å¯†
- æä¾›åŠ å¯†è¿ç§»å·¥å…·
- å‘å¸ƒç”¨æˆ·æŒ‡å—
```

### Q10: ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªæ–¹æ¡ˆï¼Ÿ

**ç­”ï¼šå¹³è¡¡äº†å®‰å…¨æ€§ã€æ˜“ç”¨æ€§å’Œå®ç°æˆæœ¬ã€‚**

**æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | å®‰å…¨æ€§ | æ˜“ç”¨æ€§ | å®ç°éš¾åº¦ | æœåŠ¡ç«¯æ”¹åŠ¨ |
|------|-------|-------|---------|-----------|
| **æˆ¿é—´å¯†ç ï¼ˆé€‰æ‹©ï¼‰** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | âŒ æ—  |
| Signal åè®® | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | âœ… éœ€è¦ |
| PGP å…¬é’¥äº¤æ¢ | â­â­â­â­â­ | â­â­ | â­â­â­â­ | âœ… éœ€è¦ |
| ä¸­å¿ƒåŒ–åŠ å¯† | â­â­ | â­â­â­â­â­ | â­â­ | âœ… éœ€è¦ |

**æˆ‘ä»¬æ–¹æ¡ˆçš„ä¼˜åŠ¿**ï¼š

âœ… **å®‰å…¨æ€§**ï¼š
- çœŸæ­£çš„ç«¯å¯¹ç«¯åŠ å¯†
- æœåŠ¡å™¨æ— æ³•è§£å¯†
- æŠµæŠ—æœåŠ¡å™¨æ”»å‡»

âœ… **æ˜“ç”¨æ€§**ï¼š
- å°±åƒè®¾ç½® WiFi å¯†ç ä¸€æ ·ç®€å•
- æ”¯æŒ URL åˆ†äº«ã€QR ç 
- å¯†ç è‡ªåŠ¨ä¿å­˜

âœ… **å®ç°æˆæœ¬**ï¼š
- æœåŠ¡ç«¯å‡ ä¹é›¶æ”¹åŠ¨
- ä¸»è¦å·¥ä½œåœ¨å®¢æˆ·ç«¯
- 8-10 å‘¨å®Œæˆ

âœ… **æ€§èƒ½**ï¼š
- Web Workers å¼‚æ­¥å¤„ç†
- UI ä¸»çº¿ç¨‹ä¸é˜»å¡
- ç§»åŠ¨ç«¯æµç•…è¿è¡Œ

âœ… **å…¼å®¹æ€§**ï¼š
- å‘åå…¼å®¹ç°æœ‰æˆ¿é—´
- æ”¯æŒé€æ­¥è¿ç§»
- æ‰€æœ‰åŠŸèƒ½å®Œæ•´æ”¯æŒ

### Q11: é”™è¯¯çš„å¯†ç èƒ½è¿›å…¥æˆ¿é—´å—ï¼Ÿç”¨æˆ·ä¼šçœ‹åˆ°ä»€ä¹ˆï¼Ÿ

**ç­”ï¼šå¯ä»¥è¿æ¥ï¼Œä½†æ— æ³•çœ‹åˆ°å†…å®¹ã€‚å¯†ç é€šè¿‡"è§£å¯†æµ‹è¯•"éªŒè¯ã€‚**

**å…³é”®ç†è§£**ï¼š

```
æœåŠ¡ç«¯å±‚é¢ï¼š
- âœ… ä»»ä½•äººéƒ½å¯ä»¥è¿æ¥åˆ°æˆ¿é—´çš„ WebSocket
- âœ… æœåŠ¡å™¨ä¸éªŒè¯å¯†ç ï¼ˆå› ä¸ºæœåŠ¡å™¨ä¸çŸ¥é“å¯†ç ï¼‰
- âœ… æœåŠ¡å™¨åªè½¬å‘å¯†æ–‡

å®¢æˆ·ç«¯å±‚é¢ï¼š
- âœ… é€šè¿‡å°è¯•è§£å¯†æ¥éªŒè¯å¯†ç 
- âŒ å¯†ç é”™è¯¯ = è§£å¯†å¤±è´¥ = æ— æ³•çœ‹åˆ°å†…å®¹
- âœ… å¯†ç æ­£ç¡® = è§£å¯†æˆåŠŸ = æ­£å¸¸ä½¿ç”¨
```

**è¯¦ç»†æµç¨‹**ï¼š

**1ï¸âƒ£ è¾“å…¥å¯†ç é˜¶æ®µï¼ˆæ¨èæ–¹å¼ï¼‰**

```javascript
ç”¨æˆ·å°è¯•åŠ å…¥æˆ¿é—´
   â†“
ç³»ç»Ÿæç¤ºè¾“å…¥å¯†ç 
   â†“
ç”¨æˆ·è¾“å…¥å¯†ç ï¼ˆæ­£ç¡®æˆ–é”™è¯¯ï¼‰
   â†“
å®¢æˆ·ç«¯è·å–æˆ¿é—´çš„ä¸€æ¡åŠ å¯†æ¶ˆæ¯
   â†“
å°è¯•ç”¨è¾“å…¥çš„å¯†ç è§£å¯†
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯†ç æ­£ç¡®ï¼Ÿ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… YES: è§£å¯†æˆåŠŸ                    â”‚
â”‚    â†’ ä¿å­˜å¯†ç åˆ° IndexedDB           â”‚
â”‚    â†’ è¿›å…¥æˆ¿é—´                        â”‚
â”‚    â†’ æ˜¾ç¤ºæ‰€æœ‰è§£å¯†åçš„æ¶ˆæ¯            â”‚
â”‚                                     â”‚
â”‚  âŒ NO: è§£å¯†å¤±è´¥ï¼ˆAES-GCM æŠ›å‡ºå¼‚å¸¸ï¼‰ â”‚
â”‚    â†’ æ˜¾ç¤º"å¯†ç é”™è¯¯"æç¤º              â”‚
â”‚    â†’ è¦æ±‚é‡æ–°è¾“å…¥                    â”‚
â”‚    â†’ ä¸å…è®¸è¿›å…¥æˆ¿é—´                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç•Œé¢ç¤ºä¾‹ï¼ˆå¯†ç é”™è¯¯ï¼‰**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ Incorrect Password             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚
â”‚  The password you entered is       â”‚
â”‚  incorrect. Please try again.      â”‚
â”‚                                    â”‚
â”‚  Attempts: 2/âˆ                     â”‚
â”‚                                    â”‚
â”‚  Password:                         â”‚
â”‚  [____________________]            â”‚
â”‚                                    â”‚
â”‚  [Try Again] [Cancel]              â”‚
â”‚                                    â”‚
â”‚  ğŸ’¡ Tips:                          â”‚
â”‚  â€¢ Ask the room creator            â”‚
â”‚  â€¢ Check for typos                 â”‚
â”‚  â€¢ Password is case-sensitive      â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2ï¸âƒ£ å¦‚æœç”¨æˆ·ç»•è¿‡å¯†ç éªŒè¯ï¼ˆç†è®ºä¸Šï¼‰**

è™½ç„¶æ­£å¸¸æµç¨‹ä¼šé˜»æ­¢ç”¨æˆ·ï¼Œä½†å¦‚æœæœ‰äººä¿®æ”¹å®¢æˆ·ç«¯ä»£ç ç»•è¿‡éªŒè¯ï¼š

```javascript
// å‡è®¾ç”¨æˆ·å¼ºè¡Œè¿›å…¥æˆ¿é—´ï¼ˆæ²¡æœ‰æ­£ç¡®å¯†ç ï¼‰

// åœºæ™¯ A: å®Œå…¨æ²¡æœ‰å¯†é’¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Room: Secret Chat                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  âš ï¸ You don't have the encryption key     â”‚
â”‚     for this room.                         â”‚
â”‚                                            â”‚
â”‚  ğŸ”’ [10:30] Alice: [ğŸ” Encrypted - No Key] â”‚
â”‚  ğŸ”’ [10:31] Bob: [ğŸ” Encrypted - No Key]   â”‚
â”‚  ğŸ”’ [10:32] Carol: [ğŸ” Encrypted - No Key] â”‚
â”‚                                            â”‚
â”‚  [Request Access] [Enter Password]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// åœºæ™¯ B: æœ‰é”™è¯¯çš„å¯†é’¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Room: Secret Chat                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  ğŸ”’ [10:30] Alice: [ğŸ” Decryption Failed]  â”‚
â”‚  ğŸ”’ [10:31] Bob: [ğŸ” Decryption Failed]    â”‚
â”‚  ğŸ”’ [10:32] Carol: [ğŸ” Decryption Failed]  â”‚
â”‚                                            â”‚
â”‚  âš ï¸ Unable to decrypt messages.            â”‚
â”‚     Your password may be incorrect.        â”‚
â”‚                                            â”‚
â”‚  [Change Password] [Leave Room]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// ç”¨æˆ·å°è¯•å‘é€æ¶ˆæ¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ Cannot Send Message            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚
â”‚  You need the correct password     â”‚
â”‚  to send encrypted messages.       â”‚
â”‚                                    â”‚
â”‚  [Enter Password]                  â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**3ï¸âƒ£ æŠ€æœ¯éªŒè¯æœºåˆ¶**

```javascript
// æ¥æ”¶åˆ°åŠ å¯†æ¶ˆæ¯æ—¶çš„å¤„ç†
ws.onmessage = async (event) => {
  const data = JSON.parse(event.data);
  
  if (data.message && data.message.startsWith("ENCRYPTED:")) {
    const encryptedData = JSON.parse(data.message.substring(10));
    const roomKey = await keyManager.getRoomKey(currentRoomId);
    
    if (!roomKey) {
      // æƒ…å†µ 1ï¼šå®Œå…¨æ²¡æœ‰å¯†é’¥
      displayMessage({
        ...data,
        message: "[ğŸ” Encrypted message - No key available]",
        encrypted: true,
        cannotDecrypt: true
      });
      
      // æ˜¾ç¤ºæç¤º
      showEncryptionWarning("You need to enter the room password to read messages.");
      return;
    }
    
    try {
      // æƒ…å†µ 2ï¼šå°è¯•è§£å¯†
      const plaintext = await CryptoUtils.decryptMessage(encryptedData, roomKey);
      
      // è§£å¯†æˆåŠŸ
      displayMessage({
        ...data,
        message: plaintext,
        decrypted: true
      });
    } catch (error) {
      // æƒ…å†µ 3ï¼šè§£å¯†å¤±è´¥ï¼ˆå¯†é’¥é”™è¯¯ï¼‰
      console.error("Decryption failed:", error);
      
      displayMessage({
        ...data,
        message: "[ğŸ” Decryption failed - Incorrect password?]",
        decryptionFailed: true
      });
      
      // æç¤ºç”¨æˆ·å¯†ç å¯èƒ½é”™è¯¯
      showEncryptionWarning(
        "Unable to decrypt messages. Your password may be incorrect. " +
        "Click here to update your password."
      );
    }
  }
};

// å‘é€æ¶ˆæ¯æ—¶çš„éªŒè¯
async function sendMessage(plaintext) {
  const roomKey = await keyManager.getRoomKey(currentRoomId);
  
  if (!roomKey) {
    // æ²¡æœ‰å¯†é’¥ï¼Œé˜»æ­¢å‘é€
    alert("âŒ Cannot send message: Room password required");
    showPasswordPrompt();
    return;
  }
  
  try {
    // åŠ å¯†æ¶ˆæ¯
    const encrypted = await CryptoUtils.encryptMessage(plaintext, roomKey);
    
    // å‘é€
    ws.send(JSON.stringify({
      message: `ENCRYPTED:${JSON.stringify(encrypted)}`,
      messageId: crypto.randomUUID(),
      encryptionType: "e2ee-aes256-gcm"
    }));
  } catch (error) {
    alert("âŒ Encryption failed: " + error.message);
  }
}
```

**4ï¸âƒ£ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

**ä¼˜åŠ¿**ï¼š
- âœ… **çœŸæ­£çš„é›¶ä¿¡ä»»**ï¼šæœåŠ¡å™¨å®Œå…¨ä¸å‚ä¸å¯†ç éªŒè¯
- âœ… **æœåŠ¡å™¨æ— æ³•é˜»æ­¢è®¿é—®**ï¼šæ²¡æœ‰ä¸­å¿ƒåŒ–æ§åˆ¶
- âœ… **éšç§ä¿æŠ¤**ï¼šæœåŠ¡å™¨ä¸çŸ¥é“è°æœ‰æ­£ç¡®çš„å¯†ç 
- âœ… **ç®€åŒ–æœåŠ¡ç«¯**ï¼šä¸éœ€è¦å¯†ç éªŒè¯é€»è¾‘

**æƒè¡¡**ï¼š
- âš ï¸ ç”¨æˆ·å¯ä»¥"è¿æ¥"åˆ°æˆ¿é—´ï¼Œä½†çœ‹ä¸åˆ°å†…å®¹ï¼ˆä¸æ˜¯çœŸæ­£çš„"è¿›å…¥"ï¼‰
- âš ï¸ å¯†ç éªŒè¯åœ¨å®¢æˆ·ç«¯ï¼Œç†è®ºä¸Šå¯ä»¥è¢«ç»•è¿‡ï¼ˆä½†æ— æ„ä¹‰ï¼Œå› ä¸ºè¿˜æ˜¯çœ‹ä¸åˆ°å†…å®¹ï¼‰
- âœ… ä½†è¿™æ­£æ˜¯ç«¯å¯¹ç«¯åŠ å¯†çš„ç²¾é«“ï¼š**å†…å®¹ä¿æŠ¤ï¼Œè€Œéè®¿é—®æ§åˆ¶**

**å¯¹æ¯”ä¼ ç»Ÿæ–¹æ¡ˆ**ï¼š

| ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆæœåŠ¡ç«¯éªŒè¯ï¼‰ | E2EE æ–¹æ¡ˆï¼ˆå®¢æˆ·ç«¯éªŒè¯ï¼‰ |
|---------------------|----------------------|
| æœåŠ¡å™¨å­˜å‚¨å¯†ç å“ˆå¸Œ | æœåŠ¡å™¨ä¸çŸ¥é“å¯†ç  |
| æœåŠ¡å™¨å†³å®šè°èƒ½è¿›å…¥ | å®¢æˆ·ç«¯è§£å¯†å†³å®šèƒ½å¦é˜…è¯» |
| å¯†ç é”™è¯¯æ— æ³•è¿æ¥ | å¯†ç é”™è¯¯æ— æ³•è§£å¯† |
| ä¸­å¿ƒåŒ–è®¿é—®æ§åˆ¶ | å»ä¸­å¿ƒåŒ–å†…å®¹ä¿æŠ¤ |
| æœåŠ¡å™¨è¢«æ”»ç ´=å¯†ç æ³„éœ² | æœåŠ¡å™¨è¢«æ”»ç ´=ä»ç„¶å®‰å…¨ |

**5ï¸âƒ£ å®é™…ç”¨æˆ·ä½“éªŒ**

```
âœ… æ­£å¸¸ç”¨æˆ·ï¼ˆæœ‰æ­£ç¡®å¯†ç ï¼‰ï¼š
1. è¾“å…¥å¯†ç 
2. å¯†ç éªŒè¯æˆåŠŸ
3. è¿›å…¥æˆ¿é—´
4. çœ‹åˆ°æ‰€æœ‰è§£å¯†çš„æ¶ˆæ¯
5. å¯ä»¥æ­£å¸¸èŠå¤©

âŒ æ¶æ„ç”¨æˆ·ï¼ˆæ²¡æœ‰å¯†ç ï¼‰ï¼š
1. å°è¯•å„ç§å¯†ç 
2. å…¨éƒ¨éªŒè¯å¤±è´¥
3. æ— æ³•è¿›å…¥æˆ¿é—´
4. å³ä½¿ç»•è¿‡éªŒè¯ï¼Œä¹Ÿåªçœ‹åˆ°ä¹±ç 
5. æ— æ³•å‘é€æœ‰æ•ˆæ¶ˆæ¯ï¼ˆå…¶ä»–äººä¹Ÿè§£å¯†ä¸äº†ï¼‰

âš ï¸ ç²—å¿ƒç”¨æˆ·ï¼ˆå¿˜è®°å¯†ç ï¼‰ï¼š
1. è¾“å…¥é”™è¯¯å¯†ç 
2. éªŒè¯å¤±è´¥
3. çœ‹åˆ°å‹å¥½æç¤º
4. å¯ä»¥é‡è¯•æˆ–è¯·æ±‚å¸®åŠ©
5. æ‰¾å›å¯†ç åæ­£å¸¸ä½¿ç”¨
```

**æ€»ç»“**ï¼š
- ğŸ”‘ **å¯†ç æ˜¯çœ‹æ‡‚å†…å®¹çš„é’¥åŒ™**ï¼Œè€Œä¸æ˜¯è¿›å…¥æˆ¿é—´çš„é—¨ç¦å¡
- ğŸ”’ **é”™è¯¯çš„å¯†ç ** = èƒ½"çœ‹åˆ°"æˆ¿é—´ï¼Œä½†å…¨æ˜¯ä¹±ç 
- âœ… **æ­£ç¡®çš„å¯†ç ** = ä¸€åˆ‡æ­£å¸¸
- ğŸ›¡ï¸ **æœåŠ¡å™¨æ°¸è¿œä¸çŸ¥é“** è°æœ‰æ­£ç¡®çš„å¯†ç 
