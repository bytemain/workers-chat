<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E2EE Crypto Test Suite</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    h1 {
      color: #333;
    }

    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .test-section h2 {
      margin-top: 0;
      color: #444;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }

    button:hover {
      background: #0056b3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .test-result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
    }

    .test-result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .test-result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .test-result.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 10px 0;
    }

    .metric {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      text-align: center;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }

    .metric-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: #007bff;
      transition: width 0.3s;
    }

    .summary {
      padding: 20px;
      background: #e7f3ff;
      border-left: 4px solid #007bff;
      margin: 20px 0;
    }

    .summary h3 {
      margin-top: 0;
    }
  </style>
</head>

<body>
  <h1>🔐 E2EE Crypto Test Suite</h1>

  <div class="summary">
    <h3>Testing Environment</h3>
    <div id="environment"></div>
  </div>

  <div class="test-section">
    <h2>Test 1: Message Encryption/Decryption</h2>
    <button onclick="testMessageEncryption()">Run Test</button>
    <div id="test1-results"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Password-Based Key Derivation</h2>
    <button onclick="testKeyDerivation()">Run Test</button>
    <div id="test2-results"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Password Verification</h2>
    <button onclick="testPasswordVerification()">Run Test</button>
    <div id="test3-results"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: Key Manager (IndexedDB)</h2>
    <button onclick="testKeyManager()">Run Test</button>
    <div id="test4-results"></div>
  </div>

  <div class="test-section">
    <h2>Test 5: Performance Benchmark</h2>
    <button onclick="runBenchmark()">Run Benchmark</button>
    <div id="test5-results"></div>
  </div>

  <div class="test-section">
    <h2>Test 6: Run All Tests</h2>
    <button onclick="runAllTests()">Run All Tests</button>
    <div id="all-results"></div>
  </div>

  <script type="module">
    import CryptoUtils from '../common/crypto-utils.js';
    import { KeyManager } from '../common/key-manager.js';

    // 显示测试环境
    document.getElementById('environment').innerHTML = `
      <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
      <p><strong>Hardware Concurrency:</strong> ${navigator.hardwareConcurrency || 'Unknown'} cores</p>
      <p><strong>Web Crypto API:</strong> ${window.crypto && window.crypto.subtle ? '✅ Available' : '❌ Not available'}</p>
      <p><strong>IndexedDB:</strong> ${window.indexedDB ? '✅ Available' : '❌ Not available'}</p>
      <p><strong>Web Workers:</strong> ${window.Worker ? '✅ Available' : '❌ Not available'}</p>
    `;

    // 辅助函数：显示结果
    function showResult(containerId, message, type = 'info') {
      const container = document.getElementById(containerId);
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.textContent = message;
      container.appendChild(div);
    }

    function clearResults(containerId) {
      document.getElementById(containerId).innerHTML = '';
    }

    // Test 1: 消息加密/解密
    window.testMessageEncryption = async function () {
      clearResults('test1-results');
      showResult('test1-results', '🚀 Starting message encryption test...');

      try {
        // 1. 生成密钥
        const password = 'testPassword123';
        const roomId = 'test-room-001';
        showResult('test1-results', `Deriving key from password...`, 'info');

        const startDerive = performance.now();
        const key = await CryptoUtils.deriveKeyFromPassword(password, roomId);
        const deriveTime = performance.now() - startDerive;
        showResult('test1-results', `✅ Key derived in ${deriveTime.toFixed(2)}ms`, 'success');

        // 2. 加密消息
        const plaintext = 'Hello, this is a secret message! 🔐';
        showResult('test1-results', `Encrypting message: "${plaintext}"`, 'info');

        const startEncrypt = performance.now();
        const encrypted = await CryptoUtils.encryptMessage(plaintext, key);
        const encryptTime = performance.now() - startEncrypt;
        showResult('test1-results', `✅ Message encrypted in ${encryptTime.toFixed(2)}ms`, 'success');
        showResult('test1-results', `Encrypted data: ${JSON.stringify(encrypted).substring(0, 100)}...`, 'info');

        // 3. 解密消息
        showResult('test1-results', `Decrypting message...`, 'info');

        const startDecrypt = performance.now();
        const decrypted = await CryptoUtils.decryptMessage(encrypted, key);
        const decryptTime = performance.now() - startDecrypt;

        if (decrypted === plaintext) {
          showResult('test1-results', `✅ Message decrypted successfully in ${decryptTime.toFixed(2)}ms`, 'success');
          showResult('test1-results', `Decrypted text: "${decrypted}"`, 'success');
        } else {
          showResult('test1-results', `❌ Decryption failed: text mismatch`, 'error');
        }

        // 4. 测试错误密钥
        showResult('test1-results', `Testing with wrong key...`, 'info');
        const wrongKey = await CryptoUtils.deriveKeyFromPassword('wrongPassword', roomId);

        try {
          await CryptoUtils.decryptMessage(encrypted, wrongKey);
          showResult('test1-results', `❌ ERROR: Wrong key should fail!`, 'error');
        } catch (error) {
          showResult('test1-results', `✅ Correctly rejected wrong key: ${error.message}`, 'success');
        }

      } catch (error) {
        showResult('test1-results', `❌ Test failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // Test 2: 密钥派生
    window.testKeyDerivation = async function () {
      clearResults('test2-results');
      showResult('test2-results', '🚀 Starting key derivation test...');

      try {
        const password = 'myPassword123';
        const roomId1 = 'room-001';
        const roomId2 = 'room-002';

        // 1. 从相同密码和roomId派生密钥两次，应该相同
        showResult('test2-results', 'Test 1: Deriving key twice with same params...', 'info');

        const key1a = await CryptoUtils.deriveKeyFromPassword(password, roomId1);
        const key1b = await CryptoUtils.deriveKeyFromPassword(password, roomId1);

        const export1a = await CryptoUtils.exportKey(key1a);
        const export1b = await CryptoUtils.exportKey(key1b);

        if (export1a === export1b) {
          showResult('test2-results', '✅ Same password + roomId = Same key', 'success');
        } else {
          showResult('test2-results', '❌ ERROR: Keys should be identical!', 'error');
        }

        // 2. 不同roomId应该产生不同密钥
        showResult('test2-results', 'Test 2: Different roomId should generate different keys...', 'info');

        const key2 = await CryptoUtils.deriveKeyFromPassword(password, roomId2);
        const export2 = await CryptoUtils.exportKey(key2);

        if (export1a !== export2) {
          showResult('test2-results', '✅ Different roomId = Different key', 'success');
        } else {
          showResult('test2-results', '❌ ERROR: Keys should be different!', 'error');
        }

        // 3. 测试导入/导出
        showResult('test2-results', 'Test 3: Key export/import...', 'info');

        const exportedKey = await CryptoUtils.exportKey(key1a);
        const importedKey = await CryptoUtils.importKey(exportedKey);
        const exportedAgain = await CryptoUtils.exportKey(importedKey);

        if (exportedKey === exportedAgain) {
          showResult('test2-results', '✅ Key export/import works correctly', 'success');
        } else {
          showResult('test2-results', '❌ ERROR: Exported key mismatch!', 'error');
        }

      } catch (error) {
        showResult('test2-results', `❌ Test failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // Test 3: 密码验证
    window.testPasswordVerification = async function () {
      clearResults('test3-results');
      showResult('test3-results', '🚀 Starting password verification test...');

      try {
        const roomId = 'secure-room';
        const correctPassword = 'SecurePass123';
        const wrongPassword = 'WrongPass456';

        // 1. 生成验证数据
        showResult('test3-results', 'Generating verification data...', 'info');
        const verificationData = await CryptoUtils.generateVerificationData(roomId, correctPassword);
        showResult('test3-results', `✅ Verification data: ${verificationData.substring(0, 50)}...`, 'success');

        // 2. 验证正确密码
        showResult('test3-results', 'Testing correct password...', 'info');
        const result1 = await CryptoUtils.verifyPassword(correctPassword, roomId, verificationData);

        if (result1.success) {
          showResult('test3-results', '✅ Correct password verified successfully', 'success');
        } else {
          showResult('test3-results', `❌ ERROR: Correct password rejected! ${result1.error}`, 'error');
        }

        // 3. 验证错误密码
        showResult('test3-results', 'Testing wrong password...', 'info');
        const result2 = await CryptoUtils.verifyPassword(wrongPassword, roomId, verificationData);

        if (!result2.success) {
          showResult('test3-results', `✅ Wrong password correctly rejected: ${result2.error}`, 'success');
        } else {
          showResult('test3-results', '❌ ERROR: Wrong password should be rejected!', 'error');
        }

      } catch (error) {
        showResult('test3-results', `❌ Test failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // Test 4: KeyManager
    window.testKeyManager = async function () {
      clearResults('test4-results');
      showResult('test4-results', '🚀 Starting KeyManager test...');

      try {
        // 1. 初始化
        showResult('test4-results', 'Initializing KeyManager...', 'info');
        const keyManager = new KeyManager();
        await keyManager.init();
        showResult('test4-results', '✅ KeyManager initialized', 'success');

        // 2. 保存密码
        const roomId = 'test-room-km-001';
        const password = 'TestPassword123';

        showResult('test4-results', `Saving password for room ${roomId}...`, 'info');
        await keyManager.saveRoomPassword(roomId, password);
        showResult('test4-results', '✅ Password saved', 'success');

        // 3. 读取密码
        showResult('test4-results', 'Reading password...', 'info');
        const retrievedPassword = await keyManager.getRoomPassword(roomId);

        if (retrievedPassword === password) {
          showResult('test4-results', '✅ Password retrieved correctly', 'success');
        } else {
          showResult('test4-results', `❌ ERROR: Password mismatch!`, 'error');
        }

        // 4. 获取密钥
        showResult('test4-results', 'Deriving key from stored password...', 'info');
        const key = await keyManager.getRoomKey(roomId);

        if (key) {
          showResult('test4-results', '✅ Key derived successfully', 'success');
        } else {
          showResult('test4-results', '❌ ERROR: Failed to derive key!', 'error');
        }

        // 5. 列出所有房间
        showResult('test4-results', 'Listing all rooms...', 'info');
        const rooms = await keyManager.listRooms();
        showResult('test4-results', `✅ Found ${rooms.length} room(s)`, 'success');

        // 6. 清理
        showResult('test4-results', 'Cleaning up test data...', 'info');
        await keyManager.deleteRoomPassword(roomId);
        showResult('test4-results', '✅ Test data cleaned', 'success');

      } catch (error) {
        showResult('test4-results', `❌ Test failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // Test 5: 性能基准测试
    window.runBenchmark = async function () {
      clearResults('test5-results');
      showResult('test5-results', '🚀 Starting performance benchmark...');

      const results = {
        keyDerivation: [],
        encryption: [],
        decryption: []
      };

      try {
        const password = 'benchmarkPassword';
        const roomId = 'benchmark-room';
        const iterations = 10;

        // 1. 密钥派生性能
        showResult('test5-results', `Testing key derivation (${iterations} iterations)...`, 'info');
        for (let i = 0; i < iterations; i++) {
          const start = performance.now();
          await CryptoUtils.deriveKeyFromPassword(password, roomId + i);
          results.keyDerivation.push(performance.now() - start);
        }

        const avgDerive = results.keyDerivation.reduce((a, b) => a + b) / iterations;
        showResult('test5-results', `✅ Key derivation: ${avgDerive.toFixed(2)}ms avg`, 'success');

        // 2. 加密性能
        const key = await CryptoUtils.deriveKeyFromPassword(password, roomId);
        const testMessage = 'This is a test message for benchmarking encryption performance! 🔐';

        showResult('test5-results', `Testing encryption (${iterations} iterations)...`, 'info');
        for (let i = 0; i < iterations; i++) {
          const start = performance.now();
          await CryptoUtils.encryptMessage(testMessage, key);
          results.encryption.push(performance.now() - start);
        }

        const avgEncrypt = results.encryption.reduce((a, b) => a + b) / iterations;
        showResult('test5-results', `✅ Encryption: ${avgEncrypt.toFixed(2)}ms avg`, 'success');

        // 3. 解密性能
        const encrypted = await CryptoUtils.encryptMessage(testMessage, key);

        showResult('test5-results', `Testing decryption (${iterations} iterations)...`, 'info');
        for (let i = 0; i < iterations; i++) {
          const start = performance.now();
          await CryptoUtils.decryptMessage(encrypted, key);
          results.decryption.push(performance.now() - start);
        }

        const avgDecrypt = results.decryption.reduce((a, b) => a + b) / iterations;
        showResult('test5-results', `✅ Decryption: ${avgDecrypt.toFixed(2)}ms avg`, 'success');

        // 显示汇总
        const metricsHtml = `
          <div class="metrics">
            <div class="metric">
              <div class="metric-value">${avgDerive.toFixed(1)}ms</div>
              <div class="metric-label">Key Derivation</div>
            </div>
            <div class="metric">
              <div class="metric-value">${avgEncrypt.toFixed(1)}ms</div>
              <div class="metric-label">Encryption</div>
            </div>
            <div class="metric">
              <div class="metric-value">${avgDecrypt.toFixed(1)}ms</div>
              <div class="metric-label">Decryption</div>
            </div>
            <div class="metric">
              <div class="metric-value">${((1000 / avgEncrypt)).toFixed(0)}</div>
              <div class="metric-label">Msg/sec</div>
            </div>
          </div>
        `;
        document.getElementById('test5-results').innerHTML += metricsHtml;

      } catch (error) {
        showResult('test5-results', `❌ Benchmark failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // 运行所有测试
    window.runAllTests = async function () {
      clearResults('all-results');
      showResult('all-results', '🎯 Running all tests...', 'info');

      const tests = [
        { name: 'Message Encryption', fn: testMessageEncryption },
        { name: 'Key Derivation', fn: testKeyDerivation },
        { name: 'Password Verification', fn: testPasswordVerification },
        { name: 'KeyManager', fn: testKeyManager },
        { name: 'Performance Benchmark', fn: runBenchmark }
      ];

      let passed = 0;
      let failed = 0;

      for (const test of tests) {
        try {
          showResult('all-results', `Running: ${test.name}...`, 'info');
          await test.fn();
          passed++;
          showResult('all-results', `✅ ${test.name} passed`, 'success');
        } catch (error) {
          failed++;
          showResult('all-results', `❌ ${test.name} failed: ${error.message}`, 'error');
        }
      }

      showResult('all-results', `\n📊 Test Summary: ${passed} passed, ${failed} failed`,
        failed === 0 ? 'success' : 'error');
    };
  </script>
</body>

</html>